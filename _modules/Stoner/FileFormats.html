<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Stoner.FileFormats &#8212; Stoner Pacakge API Documentation</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Stoner Package</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for Stoner.FileFormats</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Stoner.FileFormats is a module within the Stoner package that provides extra classes</span>
<span class="sd">that can load data from various instruments into DataFile type objects.</span>

<span class="sd">Eacg class has a priority attribute that is used to determine the order in which</span>
<span class="sd">they are tried by DataFile and friends where trying to load data. High priority</span>
<span class="sd">is run last.</span>

<span class="sd">Eacg class should implement a load() method and optionally a save() method.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">.compat</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">linecache</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">_np_</span>
<span class="kn">import</span> <span class="nn">fileinput</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">from</span> <span class="nn">re</span> <span class="k">import</span> <span class="n">split</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">numpy.ma</span> <span class="k">as</span> <span class="nn">ma</span>

<span class="kn">import</span> <span class="nn">PIL</span>
<span class="kn">import</span> <span class="nn">PIL.PngImagePlugin</span> <span class="k">as</span> <span class="nn">png</span>
<span class="c1">#Expand png size limits as we have big text blocks full of metadata</span>
<span class="n">png</span><span class="o">.</span><span class="n">MAX_TEXT_CHUNK</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">22</span>
<span class="n">png</span><span class="o">.</span><span class="n">MAX_TEXT_MEMORY</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">28</span>

<span class="kn">from</span> <span class="nn">.Core</span> <span class="k">import</span> <span class="n">DataFile</span><span class="p">,</span><span class="n">StonerLoadError</span>


<div class="viewcode-block" id="CSVFile"><a class="viewcode-back" href="../../classes/Stoner.FileFormats.CSVFile.html#Stoner.FileFormats.CSVFile">[docs]</a><span class="k">class</span> <span class="nc">CSVFile</span><span class="p">(</span><span class="n">DataFile</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;A subclass of DataFiule for loading generic deliminated text fiules without metadata.&quot;&quot;&quot;</span>

    <span class="c1">#: priority (int): is the load order for the class, smaller numbers are tried before larger numbers.</span>
    <span class="c1">#   .. note::</span>
    <span class="c1">#      Subclasses with priority&lt;=32 should make some positive identification that they have the right</span>
    <span class="c1">#      file type before attempting to read data.</span>
    <span class="n">priority</span><span class="o">=</span><span class="mi">128</span> <span class="c1"># Rather generic file format so make it a low priority</span>
    <span class="c1">#: pattern (list of str): A list of file extensions that might contain this type of file. Used to construct</span>
    <span class="c1"># the file load/save dialog boxes.</span>
    <span class="n">patterns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*.csv&quot;</span><span class="p">,</span><span class="s2">&quot;*.txt&quot;</span><span class="p">]</span> <span class="c1"># Recognised filename patterns</span>

    <span class="k">def</span> <span class="nf">_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">header_line</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">data_line</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">data_delim</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">header_delim</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generic deliminated file loader routine.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (string or bool): File to load. If None then the existing filename is used,</span>
<span class="sd">                if False, then a file dialog will be used.</span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">            header_line (int): The line in the file that contains the column headers.</span>
<span class="sd">                If None, then column headers are auotmatically generated.</span>
<span class="sd">            data_line (int): The line on which the data starts</span>
<span class="sd">            data_delim (string): Thge delimiter used for separating data values</span>
<span class="sd">            header_delim (strong): The delimiter used for separating header values</span>

<span class="sd">        Returns:</span>
<span class="sd">            A copy of the current object after loading the data.</span>
<span class="sd">                &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_filename</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="k">if</span> <span class="n">header_line</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">header_string</span> <span class="o">=</span> <span class="n">linecache</span><span class="o">.</span><span class="n">getline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">header_line</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">header_string</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">r&#39;[&quot;\n]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">header_string</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">header_string</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">header_delim</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">linecache</span><span class="o">.</span><span class="n">clearcache</span><span class="p">()</span>
                <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s2">&quot;No Delimiters in header line&quot;</span><span class="p">)</span>
            <span class="n">column_headers</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">header_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">header_delim</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">column_headers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Column&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">_np_</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)[</span><span class="mi">1</span><span class="p">])]</span>
            <span class="n">data_line</span> <span class="o">=</span> <span class="n">linecache</span><span class="o">.</span><span class="n">getline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">data_line</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data_line</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">data_delim</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">linecache</span><span class="o">.</span><span class="n">clearcache</span><span class="p">()</span>
                <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s2">&quot;No delimiters in data lines&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">_np_</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="n">data_delim</span><span class="p">,</span> <span class="n">skip_header</span><span class="o">=</span><span class="n">data_line</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span><span class="o">=</span><span class="n">column_headers</span>
        <span class="n">linecache</span><span class="o">.</span><span class="n">clearcache</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

<div class="viewcode-block" id="CSVFile.save"><a class="viewcode-back" href="../../classes/Stoner.FileFormats.CSVFile.save.html#Stoner.FileFormats.CSVFile.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">deliminator</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Overrides the save method to allow CSVFiles to be written out to disc (as a mininmalist output)</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (string): Fielname to save as (using the same rules as for the load routines)</span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">            deliminator (string): Record deliniminator (defaults to a comma)</span>

<span class="sd">        Returns:</span>
<span class="sd">            A copy of itself.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">):</span>  <span class="c1"># now go and ask for one</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__file_dialog</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">spamWriter</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">),</span> <span class="n">delimiter</span><span class="o">=</span><span class="n">deliminator</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="n">quoting</span><span class="o">=</span><span class="n">csv</span><span class="o">.</span><span class="n">QUOTE_MINIMAL</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">spamWriter</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">spamWriter</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span>
        <span class="k">return</span> <span class="bp">self</span></div></div>


<div class="viewcode-block" id="VSMFile"><a class="viewcode-back" href="../../classes/Stoner.FileFormats.VSMFile.html#Stoner.FileFormats.VSMFile">[docs]</a><span class="k">class</span> <span class="nc">VSMFile</span><span class="p">(</span><span class="n">DataFile</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Extends DataFile to open VSM Files&quot;&quot;&quot;</span>
    
    <span class="c1">#: priority (int): is the load order for the class, smaller numbers are tried before larger numbers.</span>
    <span class="c1">#   .. note::</span>
    <span class="c1">#      Subclasses with priority&lt;=32 should make some positive identification that they have the right</span>
    <span class="c1">#      file type before attempting to read data.</span>
    <span class="n">priority</span><span class="o">=</span><span class="mi">16</span> <span class="c1"># Now makes a positive ID of its contents</span>
    <span class="c1">#: pattern (list of str): A list of file extensions that might contain this type of file. Used to construct</span>
    <span class="c1"># the file load/save dialog boxes.</span>
    <span class="n">patterns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*.fld&quot;</span><span class="p">]</span> <span class="c1"># Recognised filename patterns</span>


    <span class="k">def</span> <span class="nf">__parse_VSM</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header_line</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">data_line</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">data_delim</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">header_delim</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;An intrernal function for parsing deliminated data without a leading column of metadata.copy</span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">            header_line (int): The line in the file that contains the column headers.</span>
<span class="sd">                If None, then column headers are auotmatically generated.</span>
<span class="sd">            data_line (int): The line on which the data starts</span>
<span class="sd">            data_delim (string): Thge delimiter used for separating data values</span>
<span class="sd">            header_delim (strong): The delimiter used for separating header values</span>

<span class="sd">        Returns:</span>
<span class="sd">            Nothing, but modifies the current object.</span>

<span class="sd">        Note:</span>
<span class="sd">            The default values are configured fir read VSM data files</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;Timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="n">check</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;Timestamp&quot;</span><span class="p">],</span> <span class="s2">&quot;%a %b </span><span class="si">%d</span><span class="s2"> %H:%M:%S %Y&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">check</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s2">&quot;Not a VSM file ?&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span>
                    <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">header_string</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">unit_string</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="n">column_headers</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">u</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                            <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">u</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">header_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">header_delim</span><span class="p">),</span> <span class="n">unit_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">header_delim</span><span class="p">))</span>
                        <span class="p">]</span>
                    <span class="k">elif</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="k">break</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">AssertionError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s1">&#39;Not a VSM File&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">_np_</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>
                                    <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float&#39;</span><span class="p">,</span>
                                    <span class="n">usemask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="n">skip_header</span><span class="o">=</span><span class="n">data_line</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                    <span class="n">missing_values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;6:0&#39;</span><span class="p">,</span> <span class="s1">&#39;---&#39;</span><span class="p">],</span>
                                    <span class="n">invalid_raise</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">mask_rows</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">_np_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">compressed</span><span class="p">(),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">cols</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span><span class="o">=</span><span class="n">column_headers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setas</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;H_vsm (T)&quot;</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s2">&quot;m (emu)&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;VSM file loader routine.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (string or bool): File to load. If None then the existing filename is used,</span>
<span class="sd">                if False, then a file dialog will be used.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A copy of the itself after loading the data.</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_filename</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__parse_VSM</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="BigBlueFile"><a class="viewcode-back" href="../../classes/Stoner.FileFormats.BigBlueFile.html#Stoner.FileFormats.BigBlueFile">[docs]</a><span class="k">class</span> <span class="nc">BigBlueFile</span><span class="p">(</span><span class="n">CSVFile</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Extends CSVFile to load files from BigBlue&quot;&quot;&quot;</span>

    <span class="c1">#: priority (int): is the load order for the class, smaller numbers are tried before larger numbers.</span>
    <span class="c1">#   .. note::</span>
    <span class="c1">#      Subclasses with priority&lt;=32 should make some positive identification that they have the right</span>
    <span class="c1">#      file type before attempting to read data.</span>
    <span class="n">priority</span><span class="o">=</span><span class="mi">64</span> <span class="c1"># Also rather generic file format so make a lower priority</span>
    <span class="c1">#: pattern (list of str): A list of file extensions that might contain this type of file. Used to construct</span>
    <span class="c1"># the file load/save dialog boxes.</span>
    <span class="n">patterns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*.dat&quot;</span><span class="p">,</span><span class="s2">&quot;*.iv&quot;</span><span class="p">,</span><span class="s2">&quot;*.rvt&quot;</span><span class="p">]</span> <span class="c1"># Recognised filename patterns</span>


    <span class="k">def</span> <span class="nf">_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Just call the parent class but with the right parameters set</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (string or bool): File to load. If None then the existing filename is used,</span>
<span class="sd">                if False, then a file dialog will be used.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A copy of the itself after loading the data.</span>
<span class="sd">            &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_filename</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">BigBlueFile</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">header_line</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">data_line</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">data_delim</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">header_delim</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_np_</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">_np_</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s2">&quot;All data was NaN in Big Blue format&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="QDFile"><a class="viewcode-back" href="../../classes/Stoner.FileFormats.QDFile.html#Stoner.FileFormats.QDFile">[docs]</a><span class="k">class</span> <span class="nc">QDFile</span><span class="p">(</span><span class="n">DataFile</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Extends DataFile to load files from Quantum Design Systems - including PPMS, MPMS and SQUID-VSM&quot;&quot;&quot;</span>

    <span class="c1">#: priority (int): is the load order for the class, smaller numbers are tried before larger numbers.</span>
    <span class="c1">#   .. note::</span>
    <span class="c1">#      Subclasses with priority&lt;=32 should make some positive identification that they have the right</span>
    <span class="c1">#      file type before attempting to read data.</span>
    <span class="n">priority</span><span class="o">=</span><span class="mi">15</span> <span class="c1"># Is able to make a positive ID of its file content, so get priority to check</span>
    <span class="c1">#: pattern (list of str): A list of file extensions that might contain this type of file. Used to construct</span>
    <span class="c1"># the file load/save dialog boxes.</span>
    <span class="n">patterns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*.dat&quot;</span><span class="p">]</span> <span class="c1"># Recognised filename patterns</span>

    <span class="k">def</span> <span class="nf">_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;QD system file loader routine.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (string or bool): File to load. If None then the existing filename is used,</span>
<span class="sd">                if False, then a file dialog will be used.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A copy of the itself after loading the data.</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_filename</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
            
        <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;encoding&quot;</span><span class="p">:</span><span class="s1">&#39;iso-8859-1&#39;</span><span class="p">}</span> <span class="k">if</span> <span class="n">python_v3</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">()</span> <span class="c1">#Fix encoding for Python 3</span>
        <span class="n">setas</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span><span class="o">**</span><span class="n">extra</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>  <span class="c1"># Read filename linewise</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">line</span> <span class="o">!=</span> <span class="s2">&quot;[Header]&quot;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s2">&quot;Not a Quantum Design File !&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;[Header]&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="s2">&quot;[Data]&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="s2">&quot;,&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s2">&quot;No data in file!&quot;</span><span class="p">)</span>
                <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
                <span class="k">if</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;SEQUENCE FILE&quot;</span><span class="p">:</span>                
                    <span class="n">key</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;INFO&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;APPNAME&quot;</span><span class="p">:</span>
                        <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s2">&quot;No data in file!&quot;</span><span class="p">)</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;BYAPP&#39;</span><span class="p">,</span> <span class="s1">&#39;FILEOPENTIME&#39;</span><span class="p">]:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="k">elif</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;FIELDGROUP&quot;</span><span class="p">:</span>
                    <span class="n">key</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
                    <span class="n">value</span><span class="o">=</span><span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>
                <span class="k">elif</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;STARTUPAXIS&quot;</span><span class="p">:</span>
                    <span class="n">axis</span><span class="o">=</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="n">setas</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="o">=</span><span class="n">setas</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">axis</span><span class="p">,[])</span><span class="o">+</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span>
                    <span class="n">key</span><span class="o">=</span><span class="s2">&quot;Startupaxis-</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="n">value</span><span class="o">=</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">string_to_type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s2">&quot;No data in file!&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;Byapp&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s2">&quot;Not a Quantum Design File !&quot;</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="n">python_v3</span><span class="p">:</span>
                <span class="n">column_headers</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;,&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">():</span>
                    <span class="k">assert</span> <span class="kc">False</span>
                    <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s2">&quot;No data in file!&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">column_headers</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">next</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;,&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">next</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s2">&quot;No data in file!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">_np_</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">invalid_raise</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">skip_header</span><span class="o">=</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span><span class="o">=</span><span class="n">column_headers</span>
        <span class="n">s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">setas</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">setas</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="n">setas</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                <span class="n">s</span><span class="p">[</span><span class="n">ix</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">k</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setas</span><span class="o">=</span><span class="n">s</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="OpenGDAFile"><a class="viewcode-back" href="../../classes/Stoner.FileFormats.OpenGDAFile.html#Stoner.FileFormats.OpenGDAFile">[docs]</a><span class="k">class</span> <span class="nc">OpenGDAFile</span><span class="p">(</span><span class="n">DataFile</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Extends DataFile to load files from RASOR&quot;&quot;&quot;</span>

    <span class="c1">#: priority (int): is the load order for the class, smaller numbers are tried before larger numbers.</span>
    <span class="c1">#   .. note::</span>
    <span class="c1">#      Subclasses with priority&lt;=32 should make some positive identification that they have the right</span>
    <span class="c1">#      file type before attempting to read data.</span>
    <span class="n">priority</span><span class="o">=</span><span class="mi">16</span> <span class="c1"># Makes a positive ID of it&#39;s file type so give priority</span>
    <span class="c1">#: pattern (list of str): A list of file extensions that might contain this type of file. Used to construct</span>
    <span class="c1"># the file load/save dialog boxes.</span>
    <span class="n">patterns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*.dat&quot;</span><span class="p">]</span> <span class="c1"># Recognised filename patterns</span>

    <span class="k">def</span> <span class="nf">_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;OpenGDA file loader routine.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (string or bool): File to load. If None then the existing filename is used,</span>
<span class="sd">                if False, then a file dialog will be used.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A copy of the itself after loading the data.</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_filename</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">line</span> <span class="o">!=</span> <span class="s2">&quot;&amp;SRS&quot;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s2">&quot;Not a GDA File from Rasor ?&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
                <span class="k">if</span> <span class="s2">&quot;&amp;END&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">string_to_type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">python_v3</span><span class="p">:</span>
                <span class="n">column_headers</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">column_headers</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">next</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">_np_</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="n">invalid_raise</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">skip_header</span><span class="o">=</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span><span class="o">=</span><span class="n">column_headers</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="RasorFile"><a class="viewcode-back" href="../../classes/Stoner.FileFormats.RasorFile.html#Stoner.FileFormats.RasorFile">[docs]</a><span class="k">class</span> <span class="nc">RasorFile</span><span class="p">(</span><span class="n">OpenGDAFile</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Just an alias for OpenGDAFile&quot;&quot;&quot;</span>
    
    <span class="k">pass</span></div>


<div class="viewcode-block" id="SPCFile"><a class="viewcode-back" href="../../classes/Stoner.FileFormats.SPCFile.html#Stoner.FileFormats.SPCFile">[docs]</a><span class="k">class</span> <span class="nc">SPCFile</span><span class="p">(</span><span class="n">DataFile</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Extends DataFile to load SPC files from Raman&quot;&quot;&quot;</span>

    <span class="c1">#: priority (int): is the load order for the class, smaller numbers are tried before larger numbers.</span>
    <span class="c1">#   .. note::</span>
    <span class="c1">#      Subclasses with priority&lt;=32 should make some positive identification that they have the right</span>
    <span class="c1">#      file type before attempting to read data.</span>
    <span class="n">priority</span><span class="o">=</span><span class="mi">16</span> <span class="c1"># Can&#39;t make a positive ID of itself</span>
    <span class="c1">#: pattern (list of str): A list of file extensions that might contain this type of file. Used to construct</span>
    <span class="c1"># the file load/save dialog boxes.</span>
    <span class="n">patterns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*.spc&quot;</span><span class="p">]</span> <span class="c1"># Recognised filename patterns</span>

    <span class="n">mime_type</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;application/octet-stream&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reads a .scf file produced by the Renishaw Raman system (amongs others)</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (string or bool): File to load. If None then the existing filename is used,</span>
<span class="sd">                if False, then a file dialog will be used.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A copy of the itself after loading the data.</span>

<span class="sd">        Todo:</span>
<span class="sd">            Implement the second form of the file that stores multiple x-y curves in the one file.</span>

<span class="sd">        Notes:</span>
<span class="sd">            Metadata keys are pretty much as specified in the spc.h file that defines the filerformat.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_filename</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="c1"># Open the file and read the main file header and unpack into a dict</span>
        <span class="n">filesize</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">st_size</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">spchdr</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">b</span><span class="s1">&#39;BBBciddiBBBBi9s9sH8f30s130siiBBHf48sfifB187s&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">512</span><span class="p">))</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;ftflgs&quot;</span><span class="p">,</span> <span class="s2">&quot;fversn&quot;</span><span class="p">,</span> <span class="s2">&quot;fexper&quot;</span><span class="p">,</span> <span class="s2">&quot;fexp&quot;</span><span class="p">,</span> <span class="s2">&quot;fnpts&quot;</span><span class="p">,</span> <span class="s2">&quot;ffirst&quot;</span><span class="p">,</span> <span class="s2">&quot;flast&quot;</span><span class="p">,</span> <span class="s2">&quot;fnsub&quot;</span><span class="p">,</span> <span class="s2">&quot;fxtype&quot;</span><span class="p">,</span> <span class="s2">&quot;fytype&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;fztype&quot;</span><span class="p">,</span> <span class="s2">&quot;fpost&quot;</span><span class="p">,</span> <span class="s2">&quot;fres&quot;</span><span class="p">,</span> <span class="s2">&quot;fsource&quot;</span><span class="p">,</span> <span class="s2">&quot;fpeakpt&quot;</span><span class="p">,</span> <span class="s2">&quot;fspare1&quot;</span><span class="p">,</span> <span class="s2">&quot;fspare2&quot;</span><span class="p">,</span> <span class="s2">&quot;fspare3&quot;</span><span class="p">,</span> <span class="s2">&quot;fspare4&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;fspare5&quot;</span><span class="p">,</span> <span class="s2">&quot;fspare6&quot;</span><span class="p">,</span> <span class="s2">&quot;fspare7&quot;</span><span class="p">,</span> <span class="s2">&quot;fspare8&quot;</span><span class="p">,</span> <span class="s2">&quot;fcm&quot;</span><span class="p">,</span> <span class="s2">&quot;nt&quot;</span><span class="p">,</span> <span class="s2">&quot;fcatx&quot;</span><span class="p">,</span> <span class="s2">&quot;flogoff&quot;</span><span class="p">,</span> <span class="s2">&quot;fmods&quot;</span><span class="p">,</span> <span class="s2">&quot;fprocs&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;flevel&quot;</span><span class="p">,</span> <span class="s2">&quot;fsampin&quot;</span><span class="p">,</span> <span class="s2">&quot;ffactor&quot;</span><span class="p">,</span> <span class="s2">&quot;fmethod&quot;</span><span class="p">,</span> <span class="s2">&quot;fzinc&quot;</span><span class="p">,</span> <span class="s2">&quot;fwplanes&quot;</span><span class="p">,</span> <span class="s2">&quot;fwinc&quot;</span><span class="p">,</span> <span class="s2">&quot;fwtype&quot;</span><span class="p">,</span> <span class="s2">&quot;fwtype&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;fresv&quot;</span><span class="p">)</span>
            <span class="n">header</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">spchdr</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;ftflgs&#39;</span><span class="p">]</span> <span class="o">&amp;</span><span class="mi">64</span> <span class="o">==</span> <span class="mi">64</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">75</span> <span class="o">&lt;=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;fversn&#39;</span><span class="p">]</span> <span class="o">&lt;=</span>
                                             <span class="mi">77</span><span class="p">):</span>  <span class="c1"># This is the multiple XY curves in file flag.</span>
                <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s2">&quot;Filetype not implemented yet ! ftflgs=</span><span class="si">{ftflgs}</span><span class="s2">, fversn=</span><span class="si">{fversn}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">header</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># A single XY curve in the file.</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;fnsub&#39;</span><span class="p">]</span>
                <span class="n">pts</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;fnpts&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;ftflgs&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">128</span><span class="p">:</span>  <span class="c1"># We need to read some X Data</span>
                    <span class="k">if</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">pts</span> <span class="o">&gt;</span> <span class="n">filesize</span> <span class="o">-</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">():</span>
                        <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s2">&quot;Trying to read too much data!&quot;</span><span class="p">)</span>
                    <span class="n">xvals</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">pts</span><span class="p">)</span>  <span class="c1"># I think storing X vals directly implies that each one is 4 bytes....</span>
                    <span class="n">xdata</span> <span class="o">=</span> <span class="n">_np_</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">str2bytes</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pts</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;f&quot;</span><span class="p">),</span> <span class="n">xvals</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># Generate the X Data ourselves</span>
                    <span class="n">first</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;ffirst&#39;</span><span class="p">]</span>
                    <span class="n">last</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;flast&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">pts</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="n">E6</span><span class="p">:</span>  <span class="c1"># Something not right here !</span>
                        <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s2">&quot;More than 1 million points requested. Bugging out now!&quot;</span><span class="p">)</span>
                    <span class="n">xdata</span> <span class="o">=</span> <span class="n">_np_</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">pts</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">_np_</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">pts</span><span class="p">,</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>  <span class="c1"># initialise the data soace</span>
                <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">xdata</span>  <span class="c1"># Put in the X-Data</span>
                <span class="n">xvars</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Arbitrary&quot;</span><span class="p">,</span> <span class="s2">&quot;Wavenumber (cm-1)&quot;</span><span class="p">,</span> <span class="s2">&quot;Micrometers (um)&quot;</span><span class="p">,</span> <span class="s2">&quot;Nanometers (nm)&quot;</span><span class="p">,</span> <span class="s2">&quot;Seconds&quot;</span><span class="p">,</span> <span class="s2">&quot;Minutes&quot;</span><span class="p">,</span>
                         <span class="s2">&quot;Hertz (Hz)&quot;</span><span class="p">,</span> <span class="s2">&quot;Kilohertz (KHz)&quot;</span><span class="p">,</span> <span class="s2">&quot;Megahertz (MHz)&quot;</span><span class="p">,</span> <span class="s2">&quot;Mass (M/z)&quot;</span><span class="p">,</span> <span class="s2">&quot;Parts per million (PPM)&quot;</span><span class="p">,</span>
                         <span class="s2">&quot;Days&quot;</span><span class="p">,</span> <span class="s2">&quot;Years&quot;</span><span class="p">,</span> <span class="s2">&quot;Raman Shift (cm-1)&quot;</span><span class="p">,</span> <span class="s2">&quot;Raman Shift (cm-1)&quot;</span><span class="p">,</span> <span class="s2">&quot;eV&quot;</span><span class="p">,</span>
                         <span class="s2">&quot;XYZ text labels in fcatxt (old 0x4D version only)&quot;</span><span class="p">,</span> <span class="s2">&quot;Diode Number&quot;</span><span class="p">,</span> <span class="s2">&quot;Channel&quot;</span><span class="p">,</span> <span class="s2">&quot;Degrees&quot;</span><span class="p">,</span>
                         <span class="s2">&quot;Temperature (F)&quot;</span><span class="p">,</span> <span class="s2">&quot;Temperature (C)&quot;</span><span class="p">,</span> <span class="s2">&quot;Temperature (K)&quot;</span><span class="p">,</span> <span class="s2">&quot;Data Points&quot;</span><span class="p">,</span> <span class="s2">&quot;Milliseconds (mSec)&quot;</span><span class="p">,</span>
                         <span class="s2">&quot;Microseconds (uSec)&quot;</span><span class="p">,</span> <span class="s2">&quot;Nanoseconds (nSec)&quot;</span><span class="p">,</span> <span class="s2">&quot;Gigahertz (GHz)&quot;</span><span class="p">,</span> <span class="s2">&quot;Centimeters (cm)&quot;</span><span class="p">,</span>
                         <span class="s2">&quot;Meters (m)&quot;</span><span class="p">,</span> <span class="s2">&quot;Millimeters (mm)&quot;</span><span class="p">,</span> <span class="s2">&quot;Hours&quot;</span><span class="p">,</span> <span class="s2">&quot;Hours&quot;</span><span class="p">]</span>
                <span class="n">yvars</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Arbitrary Intensity&quot;</span><span class="p">,</span> <span class="s2">&quot;Interferogram&quot;</span><span class="p">,</span> <span class="s2">&quot;Absorbance&quot;</span><span class="p">,</span> <span class="s2">&quot;Kubelka-Monk&quot;</span><span class="p">,</span> <span class="s2">&quot;Counts&quot;</span><span class="p">,</span> <span class="s2">&quot;Volts&quot;</span><span class="p">,</span>
                         <span class="s2">&quot;Degrees&quot;</span><span class="p">,</span> <span class="s2">&quot;Milliamps&quot;</span><span class="p">,</span> <span class="s2">&quot;Millimeters&quot;</span><span class="p">,</span> <span class="s2">&quot;Millivolts&quot;</span><span class="p">,</span> <span class="s2">&quot;Log(1/R)&quot;</span><span class="p">,</span> <span class="s2">&quot;Percent&quot;</span><span class="p">,</span> <span class="s2">&quot;Percent&quot;</span><span class="p">,</span>
                         <span class="s2">&quot;Intensity&quot;</span><span class="p">,</span> <span class="s2">&quot;Relative Intensity&quot;</span><span class="p">,</span> <span class="s2">&quot;Energy&quot;</span><span class="p">,</span> <span class="s2">&quot;Decibel&quot;</span><span class="p">,</span> <span class="s2">&quot;Temperature (F)&quot;</span><span class="p">,</span> <span class="s2">&quot;Temperature (C)&quot;</span><span class="p">,</span>
                         <span class="s2">&quot;Temperature (K)&quot;</span><span class="p">,</span> <span class="s2">&quot;Index of Refraction [N]&quot;</span><span class="p">,</span> <span class="s2">&quot;Extinction Coeff. [K]&quot;</span><span class="p">,</span> <span class="s2">&quot;Real&quot;</span><span class="p">,</span> <span class="s2">&quot;Imaginary&quot;</span><span class="p">,</span>
                         <span class="s2">&quot;Complex&quot;</span><span class="p">,</span> <span class="s2">&quot;Complex&quot;</span><span class="p">,</span> <span class="s2">&quot;Transmission (ALL HIGHER MUST HAVE VALLEYS!)&quot;</span><span class="p">,</span> <span class="s2">&quot;Reflectance&quot;</span><span class="p">,</span>
                         <span class="s2">&quot;Arbitrary or Single Beam with Valley Peaks&quot;</span><span class="p">,</span> <span class="s2">&quot;Emission&quot;</span><span class="p">,</span> <span class="s2">&quot;Emission&quot;</span><span class="p">]</span>
                <span class="n">column_headers</span> <span class="o">=</span> <span class="p">[</span><span class="n">xvars</span><span class="p">[</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;fxtype&#39;</span><span class="p">]]]</span>  <span class="c1"># And label the X column correctly</span>

                <span class="c1">#Now we&#39;re going to read the Y-data</span>
                <span class="c1"># Start by preping some vars for use</span>

                <span class="n">subhdr_keys</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;subflgs&quot;</span><span class="p">,</span> <span class="s2">&quot;subexp&quot;</span><span class="p">,</span> <span class="s2">&quot;subindx&quot;</span><span class="p">,</span> <span class="s2">&quot;subtime&quot;</span><span class="p">,</span> <span class="s2">&quot;subnext&quot;</span><span class="p">,</span> <span class="s2">&quot;subnois&quot;</span><span class="p">,</span> <span class="s2">&quot;subnpts&quot;</span><span class="p">,</span> <span class="s2">&quot;subscan&quot;</span><span class="p">,</span>
                               <span class="s2">&quot;subwlevel&quot;</span><span class="p">,</span> <span class="s2">&quot;subresv&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;ftflgs&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">y_width</span> <span class="o">=</span> <span class="mi">2</span>
                    <span class="n">y_fmt</span> <span class="o">=</span> <span class="s1">&#39;h&#39;</span>
                    <span class="n">divisor</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">16</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">y_width</span> <span class="o">=</span> <span class="mi">4</span>
                    <span class="n">y_fmt</span> <span class="o">=</span> <span class="s1">&#39;i&#39;</span>
                    <span class="n">divisor</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">32</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="n">y_width</span> <span class="o">*</span> <span class="n">pts</span> <span class="o">+</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">filesize</span> <span class="o">-</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s2">&quot;No good, going to read too much data!&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>  <span class="c1"># We have n sub-scans</span>
                    <span class="c1"># Read the subheader and import into the main metadata dictionary as scan#:&lt;subheader item&gt;</span>
                    <span class="n">subhdr</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">b</span><span class="s1">&#39;BBHfffIIf4s&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span>
                    <span class="n">subheader</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;scan&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">subhdr_keys</span><span class="p">],</span> <span class="n">subhdr</span><span class="p">))</span>

                    <span class="c1"># Now read the y-data</span>
                    <span class="n">exponent</span> <span class="o">=</span> <span class="n">subheader</span><span class="p">[</span><span class="s2">&quot;scan&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:subexp&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">exponent</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">-</span><span class="mi">128</span><span class="p">:</span>  <span class="c1"># Data is unscaled direct floats</span>
                        <span class="n">ydata</span> <span class="o">=</span> <span class="n">_np_</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">str2bytes</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pts</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;f&quot;</span><span class="p">),</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">pts</span> <span class="o">*</span> <span class="n">y_width</span><span class="p">)))</span>
                    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Data is scaled by exponent</span>
                        <span class="n">yvals</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">str2bytes</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pts</span><span class="p">)</span> <span class="o">+</span> <span class="n">y_fmt</span><span class="p">),</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">pts</span> <span class="o">*</span> <span class="n">y_width</span><span class="p">))</span>
                        <span class="n">ydata</span> <span class="o">=</span> <span class="n">_np_</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">yvals</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">exponent</span><span class="p">)</span> <span class="o">/</span> <span class="n">divisor</span>

    <span class="c1"># Pop the y-data into the array and merge the matadata in too.</span>
                    <span class="n">data</span><span class="p">[:,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ydata</span>
                    <span class="n">header</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="o">**</span><span class="n">subheader</span><span class="p">)</span>
                    <span class="n">column_headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Scan&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">yvars</span><span class="p">[</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;fytype&#39;</span><span class="p">]])</span>

    <span class="c1"># Now we&#39;re going to read any log information</span>
                <span class="k">if</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;flogoff&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Ok, we&#39;ve got a log, so read the log header and merge into metadata</span>
                    <span class="n">logstc</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">b</span><span class="s1">&#39;IIIII44s&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">64</span><span class="p">))</span>
                    <span class="n">logstc_keys</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;logsizd&quot;</span><span class="p">,</span> <span class="s2">&quot;logsizm&quot;</span><span class="p">,</span> <span class="s2">&quot;logtxto&quot;</span><span class="p">,</span> <span class="s2">&quot;logbins&quot;</span><span class="p">,</span> <span class="s2">&quot;logdsks&quot;</span><span class="p">,</span> <span class="s2">&quot;logrsvr&quot;</span><span class="p">)</span>
                    <span class="n">logheader</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">logstc_keys</span><span class="p">,</span> <span class="n">logstc</span><span class="p">))</span>
                    <span class="n">header</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="o">**</span><span class="n">logheader</span><span class="p">)</span>

                    <span class="c1"># Can&#39;t handle either binary log information or ion disk log information (wtf is this anyway !)</span>
                    <span class="k">if</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;logbins&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;logdsks&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">filesize</span> <span class="o">-</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">():</span>
                        <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s2">&quot;Too much logfile data to read&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;logbins&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;logdsks&#39;</span><span class="p">])</span>

                    <span class="c1"># The renishaw seems to put a 16 character timestamp next - it&#39;s not in the spec but never mind that.</span>
                    <span class="n">header</span><span class="p">[</span><span class="s1">&#39;Date-Time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
                    <span class="c1"># Now read the rest of the file as log text</span>
                    <span class="n">logtext</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="c1"># We expect things to be single lines terminated with a CR-LF of the format key=value</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">split</span><span class="p">(</span><span class="n">b</span><span class="s2">&quot;[</span><span class="se">\r\n</span><span class="s2">]+&quot;</span><span class="p">,</span> <span class="n">logtext</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">b</span><span class="s2">&quot;=&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">b</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
                            <span class="n">key</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                            <span class="n">header</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="c1"># Ok now build the Stoner.DataFile instance to return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
            <span class="c1"># The next bit generates the metadata. We don&#39;t just copy the metadata because we need to figure out the typehints first - hence the loop here to call DataFile.__setitem()</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span> <span class="o">=</span> <span class="n">column_headers</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setas</span> <span class="o">=</span> <span class="s2">&quot;xy&quot;</span>
            <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="RigakuFile"><a class="viewcode-back" href="../../classes/Stoner.FileFormats.RigakuFile.html#Stoner.FileFormats.RigakuFile">[docs]</a><span class="k">class</span> <span class="nc">RigakuFile</span><span class="p">(</span><span class="n">DataFile</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Loads a .ras file as produced by Rigaku X-ray diffractormeters&quot;&quot;&quot;</span>

    <span class="c1">#: priority (int): is the load order for the class, smaller numbers are tried before larger numbers.</span>
    <span class="c1">#   .. note::</span>
    <span class="c1">#      Subclasses with priority&lt;=32 should make some positive identification that they have the right</span>
    <span class="c1">#      file type before attempting to read data.</span>
    <span class="n">priority</span><span class="o">=</span><span class="mi">16</span> <span class="c1">#Can make a positive id of file from first line</span>
    <span class="c1">#: pattern (list of str): A list of file extensions that might contain this type of file. Used to construct</span>
    <span class="c1"># the file load/save dialog boxes.</span>
    <span class="n">patterns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*.ras&quot;</span><span class="p">]</span> <span class="c1"># Recognised filename patterns</span>


    <span class="k">def</span> <span class="nf">_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reads an Rigaku ras file including handling the metadata nicely</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (string or bool): File to load. If None then the existing filename is used,</span>
<span class="sd">                if False, then a file dialog will be used.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A copy of the itself after loading the data.</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ast</span> <span class="k">import</span> <span class="n">literal_eval</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_filename</span><span class="p">(</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="n">sh</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;^\*([^\s]+)\s+(.*)$&#39;</span><span class="p">)</span>  <span class="c1"># Regexp to grab the keys</span>
        <span class="n">ka</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;(.*)\-(\d+)$&#39;</span><span class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">line</span> <span class="o">!=</span> <span class="s2">&quot;*RAS_DATA_START&quot;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s2">&quot;Not a Rigaku file!&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;*RAS_HEADER_START&quot;</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">for</span> <span class="n">i2</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">header</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">if</span> <span class="s2">&quot;*RAS_INT_START&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">keys</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">ka</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">newvalue</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">newvalue</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">_np_</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">list</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_np_</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">newvalue</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">newvalue</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_np_</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">newvalue</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newvalue</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_np_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">newvalue</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">newvalue</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">_np_</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>
                                    <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float&#39;</span><span class="p">,</span>
                                    <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span>
                                    <span class="n">invalid_raise</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">comments</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
                                    <span class="n">skip_header</span><span class="o">=</span><span class="n">i</span> <span class="o">+</span> <span class="n">i2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">column_headers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Column&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
        <span class="n">column_headers</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;meas.scan.unit.x&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;meas.scan.unit.y&#39;</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_np_</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setas</span> <span class="o">=</span> <span class="s2">&quot;xy&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span><span class="o">=</span><span class="n">column_headers</span>
        <span class="k">return</span> <span class="bp">self</span>

<div class="viewcode-block" id="RigakuFile.to_Q"><a class="viewcode-back" href="../../classes/Stoner.FileFormats.RigakuFile.to_Q.html#Stoner.FileFormats.RigakuFile.to_Q">[docs]</a>    <span class="k">def</span> <span class="nf">to_Q</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mf">1.540593</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds an additional function to covert an angualr scale to momentum transfer</span>

<span class="sd">        returns a copy of itself.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_column</span><span class="p">((</span><span class="mi">4</span> <span class="o">*</span> <span class="n">_np_</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">l</span><span class="p">)</span> <span class="o">*</span> <span class="n">_np_</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">_np_</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="mi">360</span><span class="p">),</span> <span class="n">header</span><span class="o">=</span><span class="s2">&quot;Momentum Transfer, Q ($</span><span class="se">\\</span><span class="s2">AA$)&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="XRDFile"><a class="viewcode-back" href="../../classes/Stoner.FileFormats.XRDFile.html#Stoner.FileFormats.XRDFile">[docs]</a><span class="k">class</span> <span class="nc">XRDFile</span><span class="p">(</span><span class="n">DataFile</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Loads Files from a Brucker D8 Discovery X-Ray Diffractometer&quot;&quot;&quot;</span>

    <span class="c1">#: priority (int): is the load order for the class, smaller numbers are tried before larger numbers.</span>
    <span class="c1">#   .. note::</span>
    <span class="c1">#      Subclasses with priority&lt;=32 should make some positive identification that they have the right</span>
    <span class="c1">#      file type before attempting to read data.</span>
    <span class="n">priority</span><span class="o">=</span><span class="mi">16</span> <span class="c1"># Makes a positive id of its file contents</span>
    <span class="c1">#: pattern (list of str): A list of file extensions that might contain this type of file. Used to construct</span>
    <span class="c1"># the file load/save dialog boxes.</span>
    <span class="n">patterns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*.dql&quot;</span><span class="p">]</span> <span class="c1"># Recognised filename patterns</span>

<div class="viewcode-block" id="XRDFile.__init__"><a class="viewcode-back" href="../../classes/Stoner.FileFormats.XRDFile.__init__.html#Stoner.FileFormats.XRDFile.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a public attribute to XRD File.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">XRDFile</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_public_attrs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;four_bounce&quot;</span><span class="p">:</span><span class="nb">bool</span><span class="p">}</span></div>

    <span class="k">def</span> <span class="nf">_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reads an XRD datafile as produced by the Brucker diffractometer</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (string or bool): File to load. If None then the existing filename is used,</span>
<span class="sd">                if False, then a file dialog will be used.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A copy of the itself after loading the data.</span>

<span class="sd">        Notes:</span>
<span class="sd">            Format is ini file like but not enough to do standard inifile processing - in particular</span>
<span class="sd">            one can have multiple sections with the same name (!)</span>
<span class="sd">    &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_filename</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="n">sh</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;\[(.+)\]&#39;</span><span class="p">)</span>  <span class="c1"># Regexp to grab section name</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="c1"># Read filename linewise</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;;RAW4.00&quot;</span><span class="p">:</span>  <span class="c1"># Check we have the corrrect fileformat</span>
                <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s2">&quot;File Format Not Recognized !&quot;</span><span class="p">)</span>
            <span class="n">drive</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>  <span class="c1">#for each line</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">m</span><span class="p">:</span>  <span class="c1"># This is a new section</span>
                    <span class="n">section</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">section</span> <span class="o">==</span> <span class="s2">&quot;Drive&quot;</span><span class="p">:</span>  <span class="c1">#If this is a Drive section we need to know which Drive Section it is</span>
                        <span class="n">section</span> <span class="o">=</span> <span class="n">section</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">drive</span><span class="p">)</span>
                        <span class="n">drive</span> <span class="o">=</span> <span class="n">drive</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">section</span> <span class="o">==</span> <span class="s2">&quot;Data&quot;</span><span class="p">:</span>  <span class="c1"># Data section contains the business but has a redundant first line</span>
                        <span class="k">if</span> <span class="n">python_v3</span><span class="p">:</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>  <span class="c1">#Now start reading lines in this section...</span>
                        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span>
                        <span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>  <span class="c1"># A blank line marks the end of the section, so go back to the outer loop which will handle a new section</span>
                            <span class="k">break</span>
                        <span class="k">elif</span> <span class="n">section</span><span class="o">==</span><span class="s2">&quot;Data&quot;</span><span class="p">:</span> <span class="c1"># In the Data section read lines of data value,vale</span>
                            <span class="n">parts</span><span class="o">=</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                            <span class="n">angle</span><span class="o">=</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="n">counts</span><span class="o">=</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="n">dataline</span><span class="o">=</span><span class="n">_np_</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">counts</span><span class="p">)])</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">=</span><span class="n">_np_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">dataline</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span> <span class="c1"># Other sections contain metadata</span>
                            <span class="n">parts</span><span class="o">=</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
                            <span class="n">key</span><span class="o">=</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="n">data</span><span class="o">=</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="bp">self</span><span class="p">[</span><span class="n">section</span><span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="o">+</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">string_to_type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="c1"># Keynames in main metadata are section:key - use theDataFile magic to do type determination</span>
            <span class="n">column_headers</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Angle&#39;</span><span class="p">,</span> <span class="s1">&#39;Counts&#39;</span><span class="p">]</span> <span class="c1"># Assume the columns were Angles and Counts</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">=</span><span class="n">_np_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setas</span><span class="o">=</span><span class="s2">&quot;xy&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">four_bounce</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;HardwareConfiguration:Monochromator&quot;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span><span class="o">=</span><span class="n">column_headers</span>
        <span class="k">return</span> <span class="bp">self</span>

<div class="viewcode-block" id="XRDFile.to_Q"><a class="viewcode-back" href="../../classes/Stoner.FileFormats.XRDFile.to_Q.html#Stoner.FileFormats.XRDFile.to_Q">[docs]</a>    <span class="k">def</span> <span class="nf">to_Q</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mf">1.540593</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds an additional function to covert an angualr scale to momentum transfer</span>

<span class="sd">        returns a copy of itself.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_column</span><span class="p">((</span><span class="mi">4</span> <span class="o">*</span> <span class="n">_np_</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">l</span><span class="p">)</span> <span class="o">*</span> <span class="n">_np_</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">_np_</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="mi">360</span><span class="p">),</span> <span class="n">header</span><span class="o">=</span><span class="s2">&quot;Momentum Transfer, Q ($</span><span class="se">\\</span><span class="s2">AA$)&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="BNLFile"><a class="viewcode-back" href="../../classes/Stoner.FileFormats.BNLFile.html#Stoner.FileFormats.BNLFile">[docs]</a><span class="k">class</span> <span class="nc">BNLFile</span><span class="p">(</span><span class="n">DataFile</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates BNLFile a subclass of DataFile that caters for files in the SPEC format given</span>
<span class="sd">    by BNL (specifically u4b beamline but hopefully generalisable).</span>

<span class="sd">    Author Rowan 12/2011</span>

<span class="sd">    The file from BNL must be split into seperate scan files before Stoner can use</span>
<span class="sd">    them, a separate python script has been written for this and should be found</span>
<span class="sd">    in data/Python/PythonCode/scripts.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    

    <span class="c1">#: priority (int): is the load order for the class, smaller numbers are tried before larger numbers.</span>
    <span class="c1">#   .. note::</span>
    <span class="c1">#      Subclasses with priority&lt;=32 should make some positive identification that they have the right</span>
    <span class="c1">#      file type before attempting to read data.</span>
    <span class="n">priority</span><span class="o">=</span><span class="mi">64</span>
    <span class="c1">#: pattern (list of str): A list of file extensions that might contain this type of file. Used to construct</span>
    <span class="c1"># the file load/save dialog boxes.</span>
    <span class="n">patterns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*.txt&quot;</span><span class="p">]</span> <span class="c1"># Recognised filename patterns</span>

<div class="viewcode-block" id="BNLFile.__init__"><a class="viewcode-back" href="../../classes/Stoner.FileFormats.BNLFile.__init__.html#Stoner.FileFormats.BNLFile.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor modification</span>
<span class="sd">        BNLFile(&#39;filename&#39;)</span>
<span class="sd">        Do a normal initiation using the parent class &#39;self&#39; followed by adding an extra attribute line_numbers,</span>
<span class="sd">        line_numbers is a list of important line numbers in the file.</span>
<span class="sd">        I&#39;ve left it open for someone to add options for more args if they wish.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BNLFile</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line_numbers</span> <span class="o">=</span> <span class="p">[]</span></div>

    <span class="k">def</span> <span class="nf">__find_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;returns an array of ints [header_line,data_line,scan_line,date_line,motor_line]&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">line_numbers</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fp</span><span class="p">:</span>
                <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">counter</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;#&#39;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s2">&quot;Not a BNL File ?&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span> <span class="k">continue</span>  <span class="c1">#if there&#39;s nothing written on the line go to the next</span>
                <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#L&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_numbers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">counter</span>
                <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#S&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_numbers</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">counter</span>
                <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#D&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_numbers</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">counter</span>
                <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#P&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_numbers</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">counter</span>
                <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">,</span> <span class="s1">&#39;6&#39;</span><span class="p">,</span> <span class="s1">&#39;7&#39;</span><span class="p">,</span> <span class="s1">&#39;8&#39;</span><span class="p">,</span> <span class="s1">&#39;9&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">line_numbers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">counter</span>
                    <span class="k">break</span>

    <span class="k">def</span> <span class="nf">__get_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Metadata found is scan number &#39;Snumber&#39;, scan type and parameters &#39;Stype&#39;,</span>
<span class="sd">        scan date/time &#39;Sdatetime&#39; and z motor position &#39;Smotor&#39;.&quot;&quot;&quot;</span>
        <span class="n">scanLine</span> <span class="o">=</span> <span class="n">linecache</span><span class="o">.</span><span class="n">getline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_numbers</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">dateLine</span> <span class="o">=</span> <span class="n">linecache</span><span class="o">.</span><span class="n">getline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_numbers</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">motorLine</span> <span class="o">=</span> <span class="n">linecache</span><span class="o">.</span><span class="n">getline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_numbers</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s1">&#39;Snumber&#39;</span><span class="p">,</span> <span class="n">scanLine</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">scanLine</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">:])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s1">&#39;Stype&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)))</span>  <span class="c1">#get rid of commas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s1">&#39;Sdatetime&#39;</span><span class="p">,</span> <span class="n">dateLine</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1">#don&#39;t want \n at end of line so use -1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="s1">&#39;Smotor&#39;</span><span class="p">,</span> <span class="n">motorLine</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">3</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__parse_BNL_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internal function for parsing BNL data. The meta data is labelled by #L type tags</span>
<span class="sd">        so easy to find but #L must be excluded from the result.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__find_lines</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;creates a list, line_numbers, formatted [header_line,data_line,scan_line,date_line,motor_line]&quot;&quot;&quot;</span>
        <span class="n">header_string</span> <span class="o">=</span> <span class="n">linecache</span><span class="o">.</span><span class="n">getline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_numbers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">header_string</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">r&#39;[&quot;\n]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">header_string</span><span class="p">)</span>  <span class="c1">#get rid of new line character</span>
        <span class="n">header_string</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">r&#39;#L&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">header_string</span><span class="p">)</span>  <span class="c1">#get rid of line indicator character</span>
        <span class="n">column_headers</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">header_string</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__get_metadata</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">_np_</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">skip_header</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">line_numbers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">_np_</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Did not import any data for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span><span class="o">=</span><span class="n">column_headers</span>

    <span class="k">def</span> <span class="nf">_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>  <span class="c1">#fileType omitted, implicit in class call</span>
        <span class="sd">&quot;&quot;&quot;BNLFile.load(filename)</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (string or bool): File to load. If None then the existing filename is used,</span>
<span class="sd">                if False, then a file dialog will be used.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A copy of the itself after loading the data.</span>

<span class="sd">        Notes:</span>
<span class="sd">            Overwrites load method in DataFile class, no header positions and data</span>
<span class="sd">            positions are needed because of the hash title structure used in BNL files.</span>

<span class="sd">            Normally its good to use _parse_plain_data method from DataFile class</span>
<span class="sd">            to load data but unfortunately Brookhaven data isn&#39;t very plain so there&#39;s</span>
<span class="sd">            a new method below.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__parse_BNL_data</span><span class="p">()</span>  <span class="c1">#call an internal function rather than put it in load function</span>
        <span class="n">linecache</span><span class="o">.</span><span class="n">clearcache</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="MokeFile"><a class="viewcode-back" href="../../classes/Stoner.FileFormats.MokeFile.html#Stoner.FileFormats.MokeFile">[docs]</a><span class="k">class</span> <span class="nc">MokeFile</span><span class="p">(</span><span class="n">DataFile</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Class that extgends DataFile to load files from the Leeds MOKE system.&quot;&quot;&quot;</span>

    <span class="c1">#: priority (int): is the load order for the class, smaller numbers are tried before larger numbers.</span>
    <span class="c1">#   .. note::</span>
    <span class="c1">#      Subclasses with priority&lt;=32 should make some positive identification that they have the right</span>
    <span class="c1">#      file type before attempting to read data.</span>
    <span class="n">priotity</span><span class="o">=</span><span class="mi">16</span>
    <span class="c1">#: pattern (list of str): A list of file extensions that might contain this type of file. Used to construct</span>
    <span class="c1"># the file load/save dialog boxes.</span>
    <span class="n">patterns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*.dat&quot;</span><span class="p">,</span><span class="s2">&quot;*.txt&quot;</span><span class="p">]</span>


    <span class="k">def</span> <span class="nf">_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Leeds  MOKE file loader routine.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (string or bool): File to load. If None then the existing filename is used,</span>
<span class="sd">                if False, then a file dialog will be used.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A copy of the itself after loading the data.</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_filename</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span> <span class="o">!=</span> <span class="s2">&quot;#Leeds CM Physics MOKE&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s2">&quot;Not a datafile from the Leeds MOKE&quot;</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="s2">&quot;:&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">column_headers</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">_np_</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setas</span> <span class="o">=</span> <span class="s2">&quot;xy.de&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span><span class="o">=</span><span class="n">column_headers</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="FmokeFile"><a class="viewcode-back" href="../../classes/Stoner.FileFormats.FmokeFile.html#Stoner.FileFormats.FmokeFile">[docs]</a><span class="k">class</span> <span class="nc">FmokeFile</span><span class="p">(</span><span class="n">DataFile</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Extends DataFile to open Fmoke Files&quot;&quot;&quot;</span>

    <span class="c1">#: priority (int): is the load order for the class, smaller numbers are tried before larger numbers.</span>
    <span class="c1">#   .. note::</span>
    <span class="c1">#      Subclasses with priority&lt;=32 should make some positive identification that they have the right</span>
    <span class="c1">#      file type before attempting to read data.</span>
    <span class="n">priority</span><span class="o">=</span><span class="mi">16</span> <span class="c1"># Makes a positive ID check of its contents so give it priority in autoloading</span>
    <span class="c1">#: pattern (list of str): A list of file extensions that might contain this type of file. Used to construct</span>
    <span class="c1"># the file load/save dialog boxes.</span>
    <span class="n">patterns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*.dat&quot;</span><span class="p">]</span> <span class="c1"># Recognised filename patterns</span>

    <span class="k">def</span> <span class="nf">_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sheffield Focussed MOKE file loader routine.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (string or bool): File to load. If None then the existing filename is used,</span>
<span class="sd">                if False, then a file dialog will be used.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A copy of the itself after loading the data.</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_filename</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s2">&quot;Not an FMOKE file?&quot;</span><span class="p">)</span>
            <span class="n">label</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;Header:&quot;</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s2">&quot;Not a Focussed MOKE file !&quot;</span><span class="p">)</span>
            <span class="k">del</span> <span class="p">(</span><span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>  <span class="c1"># Create metatdata from first 2 lines</span>
            <span class="n">column_headers</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">_np_</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">invalid_raise</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span><span class="o">=</span><span class="n">column_headers</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<span class="k">class</span> <span class="nc">GenXFile</span><span class="p">(</span><span class="n">DataFile</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Extends DataFile for GenX Exported data.&quot;&quot;&quot;</span>

    <span class="c1">#: priority (int): is the load order for the class, smaller numbers are tried before larger numbers.</span>
    <span class="c1">#   .. note::</span>
    <span class="c1">#      Subclasses with priority&lt;=32 should make some positive identification that they have the right</span>
    <span class="c1">#      file type before attempting to read data.</span>
    <span class="n">priority</span><span class="o">=</span><span class="mi">64</span>
    <span class="c1">#: pattern (list of str): A list of file extensions that might contain this type of file. Used to construct</span>
    <span class="c1"># the file load/save dialog boxes.</span>
    <span class="n">patterns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*.dat&quot;</span><span class="p">]</span> <span class="c1"># Recognised filename patterns</span>


    <span class="k">def</span> <span class="nf">_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load function. File format has space delimited columns from row 3 onwards.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_filename</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;# Dataset &quot;([^\&quot;]*)&quot; exported from GenX on (.*)$&#39;</span><span class="p">)</span>
        <span class="n">pattern2</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">r&quot;#\sFile\sexported\sfrom\sGenX\&#39;s\sReflectivity\splugin&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">datafile</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">datafile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">match2</span> <span class="o">=</span> <span class="n">pattern2</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dataset</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">date</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">datafile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">datafile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date</span>
            <span class="k">elif</span> <span class="n">match2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">datafile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">datafile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">datafile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">dataset</span> <span class="o">=</span> <span class="s2">&quot;asymmetry&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s2">&quot;Not a GenXFile&quot;</span><span class="p">)</span>
            <span class="n">column_headers</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">_np_</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataset</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setas</span> <span class="o">=</span> <span class="s2">&quot;xye&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span><span class="o">=</span><span class="n">column_headers</span>
        <span class="k">return</span> <span class="bp">self</span>


<div class="viewcode-block" id="SNSFile"><a class="viewcode-back" href="../../classes/Stoner.FileFormats.SNSFile.html#Stoner.FileFormats.SNSFile">[docs]</a><span class="k">class</span> <span class="nc">SNSFile</span><span class="p">(</span><span class="n">DataFile</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;This reads the ASCII exported Poalrised Neutron Rfeflectivity reduced files from</span>
<span class="sd">    BL-4A line at the Spallation Neutron Source at Oak Ridge National Lab.</span>

<span class="sd">    File has a large header marked up with # prefixes which include several section is []</span>
<span class="sd">    Each section seems to have a slightly different format</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#: priority (int): is the load order for the class, smaller numbers are tried before larger numbers.</span>
    <span class="c1">#   .. note::</span>
    <span class="c1">#      Subclasses with priority&lt;=32 should make some positive identification that they have the right</span>
    <span class="c1">#      file type before attempting to read data.</span>
    <span class="n">priority</span><span class="o">=</span><span class="mi">16</span>
    <span class="c1">#: pattern (list of str): A list of file extensions that might contain this type of file. Used to construct</span>
    <span class="c1"># the file load/save dialog boxes.</span>
    <span class="n">patterns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*.dat&quot;</span><span class="p">]</span> <span class="c1"># Recognised filename patterns</span>

    <span class="k">def</span> <span class="nf">_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load function. File format has space delimited columns from row 3 onwards.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_filename</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">data</span><span class="p">:</span>  <span class="c1"># Slightly ugly text handling</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;# Datafile created by QuickNXS 0.9.39&quot;</span><span class="p">:</span>  <span class="c1"># bug out oif we don&#39;t like the header</span>
                <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s2">&quot;Not a file from the SNS BL4A line&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;# &quot;</span><span class="p">):</span>  <span class="c1"># We&#39;re in the header</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1"># strip the header and whitespace</span>

                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">):</span>  <span class="c1"># Look for a section header</span>
                    <span class="n">section</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;[]&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">section</span> <span class="o">==</span> <span class="s2">&quot;Data&quot;</span><span class="p">:</span>  <span class="c1"># The Data section has one line of colum headers and then data</span>
                        <span class="n">header</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">data</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">column_headers</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">header</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">_np_</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># we end by reading the raw data</span>
                    <span class="k">elif</span> <span class="n">section</span> <span class="o">==</span> <span class="s2">&quot;Global Options&quot;</span><span class="p">:</span>  <span class="c1"># This section can go into metadata</span>
                        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                                <span class="k">break</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">11</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="n">section</span> <span class="o">==</span> <span class="s2">&quot;Direct Beam Runs&quot;</span> <span class="ow">or</span> <span class="n">section</span> <span class="o">==</span> <span class="s2">&quot;Data Runs&quot;</span><span class="p">:</span>  <span class="c1"># These are constructed into lists ofg dictionaries for each file</span>
                        <span class="n">sec</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                        <span class="n">header</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                        <span class="n">header</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;  &#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
                        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                                <span class="k">break</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;  &#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
                                <span class="n">sec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">values</span><span class="p">)))</span>
                        <span class="bp">self</span><span class="p">[</span><span class="n">section</span><span class="p">]</span> <span class="o">=</span> <span class="n">sec</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># We must still be in the opening un-labelled section of meta data</span>
                    <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span><span class="o">=</span><span class="n">column_headers</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="OVFFile"><a class="viewcode-back" href="../../classes/Stoner.FileFormats.OVFFile.html#Stoner.FileFormats.OVFFile">[docs]</a><span class="k">class</span> <span class="nc">OVFFile</span><span class="p">(</span><span class="n">DataFile</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;A class that reads OOMMF vector format files and constructs x,y,z,u,v,w data.</span>

<span class="sd">    OVF 1 and OVF 2 files with text or binary data and only files with a meshtype rectangular are supported&quot;&quot;&quot;</span>

    <span class="c1">#: priority (int): is the load order for the class, smaller numbers are tried before larger numbers.</span>
    <span class="c1">#   .. note::</span>
    <span class="c1">#      Subclasses with priority&lt;=32 should make some positive identification that they have the right</span>
    <span class="c1">#      file type before attempting to read data.</span>
    <span class="n">priority</span><span class="o">=</span><span class="mi">16</span>
    <span class="c1">#: pattern (list of str): A list of file extensions that might contain this type of file. Used to construct</span>
    <span class="c1"># the file load/save dialog boxes.</span>
    <span class="n">patterns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*.ovf&quot;</span><span class="p">]</span> <span class="c1"># Recognised filename patterns</span>


    <span class="k">def</span> <span class="nf">_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load function. File format has space delimited columns from row 3 onwards.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_filename</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>

        <span class="n">ptr</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">data</span><span class="p">:</span>  <span class="c1"># Slightly ugly text handling</span>
            <span class="n">line</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">ptr</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="s2">&quot;OOMMF: rectangular mesh&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;v1.0&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="s2">&quot;v2.0&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s2">&quot;Cannot determine version of OOMMFF file&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># bug out oif we don&#39;t like the header</span>
                <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s2">&quot;Not n OOMMF OVF File: opening line eas </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">r&quot;#\s*([^\:]+)\:\s+(.*)$&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="n">ptr</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;# Begin: Data&quot;</span><span class="p">):</span>  <span class="c1"># marks the start of the trext</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;# Begin:&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;# End:&quot;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                        <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">string_to_type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s2">&quot;Failed to understand metadata&quot;</span><span class="p">)</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">r&quot;.*Data\s+(.*)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;meshtype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;rectangular&quot;</span><span class="p">,</span> <span class="s2">&quot;Sorry only OVF files with rectnagular meshes are currently supported.&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;meshtype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;rectangular&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;valuedim&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;valuedim&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;Text&quot;</span><span class="p">:</span>
            <span class="n">uvwdata</span> <span class="o">=</span> <span class="n">_np_</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">skip_header</span><span class="o">=</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;Binary 4&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">_np_</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;&gt;f4&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">_np_</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;&lt;f4&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">bindata</span><span class="p">:</span>
                <span class="n">bindata</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
                <span class="n">uvwdata</span> <span class="o">=</span> <span class="n">_np_</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">bindata</span><span class="p">,</span>
                                        <span class="n">dtype</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span>
                                        <span class="n">count</span><span class="o">=</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;xnodes&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;ynodes&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;znodes&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;valuedim&quot;</span><span class="p">])</span>
                <span class="k">assert</span> <span class="n">uvwdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mf">1234567.0</span><span class="p">,</span> <span class="s2">&quot;Binary 4 format check value incorrect ! Actual Value was </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">uvwdata</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">uvwdata</span> <span class="o">=</span> <span class="n">uvwdata</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">uvwdata</span> <span class="o">=</span> <span class="n">_np_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">uvwdata</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;valuedim&quot;</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;Binary 8&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">_np_</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;&gt;f8&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">_np_</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;&lt;f8&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">bindata</span><span class="p">:</span>
                <span class="n">bindata</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
                <span class="n">uvwdata</span> <span class="o">=</span> <span class="n">_np_</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">bindata</span><span class="p">,</span>
                                        <span class="n">dtype</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span>
                                        <span class="n">count</span><span class="o">=</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;xnodes&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;ynodes&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;znodes&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;valuedim&quot;</span><span class="p">])</span>
                <span class="k">assert</span> <span class="n">uvwdata</span><span class="p">[</span>
                    <span class="mi">0</span>
                <span class="p">]</span> <span class="o">==</span> <span class="mf">123456789012345.0</span><span class="p">,</span> <span class="s2">&quot;Binary 4 format check value incorrect ! Actual Value was </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uvwdata</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">uvwdata</span> <span class="o">=</span> <span class="n">_np_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">uvwdata</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;valuedim&quot;</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s2">&quot;Unknow OVF Format </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fmt</span><span class="p">))</span>

        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">_np_</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;xmin&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;xmax&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;xnode&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;xbase&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">1</span><span class="n">E9</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">_np_</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;ymin&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;ymax&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;ynode&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;ybase&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">1</span><span class="n">E9</span>
        <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">_np_</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;zmin&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;zmax&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;znode&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;zbase&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">1</span><span class="n">E9</span>
        <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">_np_</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">_np_</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">_np_</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">uvwdata</span><span class="p">))</span>
        <span class="n">column_headers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;X (nm)&quot;</span><span class="p">,</span> <span class="s2">&quot;Y (nm)&quot;</span><span class="p">,</span> <span class="s2">&quot;Z (nm)&quot;</span><span class="p">,</span> <span class="s2">&quot;U&quot;</span><span class="p">,</span> <span class="s2">&quot;V&quot;</span><span class="p">,</span> <span class="s2">&quot;W&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setas</span> <span class="o">=</span> <span class="s2">&quot;xyzuvw&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span><span class="o">=</span><span class="n">column_headers</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="MDAASCIIFile"><a class="viewcode-back" href="../../classes/Stoner.FileFormats.MDAASCIIFile.html#Stoner.FileFormats.MDAASCIIFile">[docs]</a><span class="k">class</span> <span class="nc">MDAASCIIFile</span><span class="p">(</span><span class="n">DataFile</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Reads files generated from the APS.&quot;&quot;&quot;</span>

    <span class="c1">#: priority (int): is the load order for the class, smaller numbers are tried before larger numbers.</span>
    <span class="c1">#   .. note::</span>
    <span class="c1">#      Subclasses with priority&lt;=32 should make some positive identification that they have the right</span>
    <span class="c1">#      file type before attempting to read data.</span>
    <span class="n">priority</span><span class="o">=</span><span class="mi">16</span>
    <span class="c1">#: pattern (list of str): A list of file extensions that might contain this type of file. Used to construct</span>
    <span class="c1"># the file load/save dialog boxes.</span>
    <span class="n">patterns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*.txt&quot;</span><span class="p">]</span> <span class="c1"># Recognised filename patterns</span>


    <span class="k">def</span> <span class="nf">_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load function. File format has space delimited columns from row 3 onwards.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_filename</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">data</span><span class="p">:</span>  <span class="c1"># Slightly ugly text handling</span>
            <span class="k">for</span> <span class="n">i1</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i1</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;## mda2ascii 1.2 generated output&quot;</span><span class="p">:</span>  <span class="c1"># bug out oif we don&#39;t like the header</span>
                    <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s2">&quot;Not a file mda2ascii&quot;</span><span class="p">)</span>
                <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="s2">&quot;=&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">string_to_type</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#  Extra PV:&quot;</span><span class="p">):</span>
                    <span class="c1"># Onto the next metadata bit</span>
                    <span class="k">break</span>
            <span class="n">pvpat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;^#\s+Extra\s+PV\s\d+\:(.*)&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i2</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;# Extra PV&quot;</span><span class="p">):</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">pvpat</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="n">bits</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">r&#39;&quot;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
                    <span class="k">if</span> <span class="n">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="n">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bits</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot; (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">string_to_type</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>  <span class="c1"># End of Extra PV stuff</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s2">&quot;Overran Extra PV Block&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i3</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;# Column Descriptions:&quot;</span><span class="p">):</span>
                    <span class="k">break</span>  <span class="c1"># Start of column headers now</span>
                <span class="k">elif</span> <span class="s2">&quot;=&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">string_to_type</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s2">&quot;Overran end of scan header before column descriptions&quot;</span><span class="p">)</span>
            <span class="n">colpat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">r&quot;#\s+\d+\s+\[([^\]]*)\](.*)&quot;</span><span class="p">)</span>
            <span class="n">column_headers</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i4</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">colpat</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;# 1-D Scan Values&quot;</span><span class="p">):</span>
                    <span class="k">break</span>  <span class="c1"># Start of data</span>
                <span class="k">elif</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;,&quot;</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                        <span class="n">bits</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
                        <span class="k">if</span> <span class="n">bits</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                            <span class="n">colname</span> <span class="o">=</span> <span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">colname</span> <span class="o">=</span> <span class="n">bits</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">bits</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                            <span class="n">colname</span> <span class="o">+=</span> <span class="s2">&quot; (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">colname</span> <span class="ow">in</span> <span class="n">column_headers</span><span class="p">:</span>
                            <span class="n">colname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">colname</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">colname</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">column_headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colname</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s2">&quot;Overand the end of file without reading data&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">_np_</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">skip_header</span><span class="o">=</span><span class="n">i1</span> <span class="o">+</span> <span class="n">i2</span> <span class="o">+</span> <span class="n">i3</span> <span class="o">+</span> <span class="n">i4</span><span class="p">)</span>  <span class="c1"># so that&#39;s ok then !</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span><span class="o">=</span><span class="n">column_headers</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="LSTemperatureFile"><a class="viewcode-back" href="../../classes/Stoner.FileFormats.LSTemperatureFile.html#Stoner.FileFormats.LSTemperatureFile">[docs]</a><span class="k">class</span> <span class="nc">LSTemperatureFile</span><span class="p">(</span><span class="n">DataFile</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;A class that reads and writes Lakeshore Temperature Calibration Curves.</span>

<span class="sd">.. warning::</span>
<span class="sd">    THis class works for cernox curves in Log Ohms/Kelvin and Log Ohms/Log Kelvin. It may or may not work with any</span>
<span class="sd">    other temperature calibration data !</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#: priority (int): is the load order for the class, smaller numbers are tried before larger numbers.</span>
    <span class="c1">#   .. note::</span>
    <span class="c1">#      Subclasses with priority&lt;=32 should make some positive identification that they have the right</span>
    <span class="c1">#      file type before attempting to read data.</span>
    <span class="n">priority</span><span class="o">=</span><span class="mi">16</span>
     <span class="c1">#: pattern (list of str): A list of file extensions that might contain this type of file. Used to construct</span>
    <span class="c1"># the file load/save dialog boxes.</span>
    <span class="n">patterns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*.340&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_filename</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s2">&quot;Header doesn&#39;t contain two parts at </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s2">&quot;Overan the end of the file&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">keys</span> <span class="o">!=</span> <span class="p">[</span><span class="s2">&quot;Sensor Model&quot;</span><span class="p">,</span> <span class="s2">&quot;Serial Number&quot;</span><span class="p">,</span> <span class="s2">&quot;Data Format&quot;</span><span class="p">,</span> <span class="s2">&quot;SetPoint Limit&quot;</span><span class="p">,</span> <span class="s2">&quot;Temperature coefficient&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Number of Breakpoints&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s2">&quot;Header did not contain recognised keys.&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">vals</span><span class="p">):</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">string_to_type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="n">bytes2str</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">data</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">column_headers</span> <span class="o">=</span> <span class="n">headers</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="n">_np_</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span><span class="o">=</span><span class="n">column_headers</span>
        <span class="k">return</span> <span class="bp">self</span>

<div class="viewcode-block" id="LSTemperatureFile.save"><a class="viewcode-back" href="../../classes/Stoner.FileFormats.LSTemperatureFile.save.html#Stoner.FileFormats.LSTemperatureFile.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Overrides the save method to allow CSVFiles to be written out to disc (as a mininmalist output)</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (string): Filename to save as (using the same rules as for the load routines)</span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">            deliminator (string): Record deliniminator (defaults to a comma)</span>

<span class="sd">        Returns:</span>
<span class="sd">            A copy of itself.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">):</span>  <span class="c1"># now go and ask for one</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__file_dialog</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Sensor Model&quot;</span><span class="p">,</span> <span class="s2">&quot;Serial Number&quot;</span><span class="p">,</span> <span class="s2">&quot;Data Format&quot;</span><span class="p">,</span> <span class="s2">&quot;SetPoint Limit&quot;</span><span class="p">,</span> <span class="s2">&quot;Temperature coefficient&quot;</span><span class="p">,</span>
                      <span class="s2">&quot;Number of Breakpoints&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Sensor Model&quot;</span><span class="p">,</span> <span class="s2">&quot;Serial Number&quot;</span><span class="p">,</span> <span class="s2">&quot;Data Format&quot;</span><span class="p">,</span> <span class="s2">&quot;SetPoint Limit&quot;</span><span class="p">]:</span>
                    <span class="n">kstr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:16s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">kstr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:   &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;Data Format&quot;</span><span class="p">:</span>
                    <span class="n">units</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;()&quot;</span><span class="p">,</span> <span class="s2">&quot;()&quot;</span><span class="p">,</span> <span class="s2">&quot;()&quot;</span><span class="p">,</span> <span class="s2">&quot;()&quot;</span><span class="p">,</span> <span class="s2">&quot;(Log Ohms/Kelvin)&quot;</span><span class="p">,</span> <span class="s2">&quot;(Log Ohms/Log Kelvin)&quot;</span><span class="p">]</span>
                    <span class="n">vstr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">      </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">units</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)])</span>
                <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;SetPointLimit&quot;</span><span class="p">:</span>
                    <span class="n">vstr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">      (Kelvin)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;Temperature coefficient&quot;</span><span class="p">:</span>
                    <span class="n">vstr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;(positive)&quot;</span><span class="p">,</span> <span class="s2">&quot;(negative)&quot;</span><span class="p">][</span><span class="n">v</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;Number of Breakpoints&quot;</span><span class="p">:</span>
                    <span class="n">vstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">vstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}{}</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kstr</span><span class="p">,</span> <span class="n">vstr</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;No.   &quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:11s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">h</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n\r\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)):</span>  <span class="c1"># This is a slow way to write the data, but there should only ever be 200 lines</span>
                <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">{:&lt;10.8f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span>
        <span class="k">return</span> <span class="bp">self</span></div></div>


<div class="viewcode-block" id="EasyPlotFile"><a class="viewcode-back" href="../../classes/Stoner.FileFormats.EasyPlotFile.html#Stoner.FileFormats.EasyPlotFile">[docs]</a><span class="k">class</span> <span class="nc">EasyPlotFile</span><span class="p">(</span><span class="n">DataFile</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;A class that will extract as much as it can from an EasyPlot save File.&quot;&quot;&quot;</span>

    <span class="c1">#: priority (int): is the load order for the class, smaller numbers are tried before larger numbers.</span>
    <span class="c1">#   .. note::</span>
    <span class="c1">#      Subclasses with priority&lt;=32 should make some positive identification that they have the right</span>
    <span class="c1">#      file type before attempting to read data.</span>
    <span class="n">priority</span><span class="o">=</span><span class="mi">32</span> <span class="c1"># Fairly generic, but can do some explicit testing</span>

    <span class="k">def</span> <span class="nf">_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Private loader method.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_filename</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>

        <span class="n">datastart</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">dataend</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;******** EasyPlot save file ********&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1024</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s2">&quot;Not an EasyPlot Save file?&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s2">&quot;-0123456789&quot;</span> <span class="ow">and</span> <span class="n">datastart</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">dataend</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">dataend</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)]</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">string_to_type</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
                <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>  <span class="c1"># command</span>
                    <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">next</span><span class="p">(</span><span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">([</span><span class="n">line</span><span class="p">],</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">))</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>
                    <span class="n">cmd</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">cmdname</span> <span class="o">=</span> <span class="s2">&quot;_</span><span class="si">{}</span><span class="s2">_cmd&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">cmdname</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1">#If this command is implemented as a function run it</span>
                            <span class="n">cmd</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s2">&quot;_</span><span class="si">{}</span><span class="s2">_cmd&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
                            <span class="n">cmd</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
                            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">value</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">value</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="bp">self</span><span class="p">[</span><span class="n">cmd</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="s2">&quot;-0123456789&quot;</span> <span class="ow">and</span> <span class="n">datastart</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1">#start of data</span>
                    <span class="n">datastart</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="k">if</span> <span class="s2">&quot;,&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">delimiter</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">delimiter</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">dataend</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dataend</span> <span class="o">=</span> <span class="n">i</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">_np_</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">skip_header</span><span class="o">=</span><span class="n">datastart</span><span class="p">,</span> <span class="n">skip_footer</span><span class="o">=</span><span class="n">i</span> <span class="o">-</span> <span class="n">dataend</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="n">delimiter</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setas</span> <span class="o">=</span> <span class="s2">&quot;xy&quot;</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">_extend_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ensure the column headers are at least i long.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">=</span><span class="n">_np_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">_np_</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">i</span><span class="o">-</span><span class="n">l</span><span class="p">)),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># Need to expand the array first</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;Column </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">i</span><span class="p">)])</span>

    <span class="k">def</span> <span class="nf">_et_cmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle axis labellling command.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_extend_columns</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_extend_columns</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;g&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_td_cmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parts</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setas</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_sa_cmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The sa (set-axis?) command.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;l&quot;</span><span class="p">:</span>  <span class="c1">#Legend</span>
            <span class="n">col</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_extend_columns</span><span class="p">(</span><span class="n">col</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></div>

<span class="k">class</span> <span class="nc">PinkLibFile</span><span class="p">(</span><span class="n">DataFile</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Extends DataFile to load files from MdV&#39;s PINK library - as used by the GMR anneal rig.&quot;&quot;&quot;</span>

    <span class="c1">#: priority (int): is the load order for the class, smaller numbers are tried before larger numbers.</span>
    <span class="c1">#   .. note::</span>
    <span class="c1">#      Subclasses with priority&lt;=32 should make some positive identification that they have the right</span>
    <span class="c1">#      file type before attempting to read data.</span>
    <span class="n">priority</span><span class="o">=</span><span class="mi">32</span> <span class="c1"># reasonably generic format</span>
    <span class="c1">#: pattern (list of str): A list of file extensions that might contain this type of file. Used to construct</span>
    <span class="c1"># the file load/save dialog boxes.</span>
    <span class="n">patterns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*.dat&quot;</span><span class="p">]</span> <span class="c1"># Recognised filename patterns</span>


    <span class="k">def</span> <span class="nf">_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;PinkLib file loader routine.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (string or bool): File to load. If None then the existing filename is used,</span>
<span class="sd">                if False, then a file dialog will be used.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A copy of the itself after loading the data.</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_filename</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>  <span class="c1"># Read filename linewise</span>
            <span class="k">if</span> <span class="s2">&quot;PINKlibrary&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s2">&quot;Not a PINK file&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="n">happened_before</span><span class="o">=</span><span class="kc">False</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;#&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">happened_before</span><span class="p">:</span>
                    <span class="n">header_line</span><span class="o">=</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span> <span class="c1">#-2 because there&#39;s a commented out data line</span>
                    <span class="n">happened_before</span><span class="o">=</span><span class="kc">True</span>
                    <span class="k">continue</span> <span class="c1">#want to get the metadata at the bottom of the file too</span>
                <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">s</span> <span class="ow">in</span> <span class="n">line</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;Start time&#39;</span><span class="p">,</span> <span class="s1">&#39;End time&#39;</span><span class="p">,</span> <span class="s1">&#39;Title&#39;</span><span class="p">)):</span>
                    <span class="n">tmp</span><span class="o">=</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">column_headers</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">header_line</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;#</span><span class="se">\t</span><span class="s1"> &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">_np_</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">invalid_raise</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="s1">&#39;#&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="c1">#Deal with an errant tab at the end of each line</span>
        <span class="k">if</span> <span class="n">_np_</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">h</span> <span class="ow">in</span> <span class="n">column_headers</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;T (C)&#39;</span><span class="p">,</span> <span class="s1">&#39;R (Ohm)&#39;</span><span class="p">)]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setas</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;T (C)&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;R (Ohm)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span><span class="o">=</span><span class="n">column_headers</span>
        <span class="k">return</span> <span class="bp">self</span>

<span class="k">class</span> <span class="nc">KermitPNGFile</span><span class="p">(</span><span class="n">DataFile</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Loads PNG files with additional metadata embedded in them and extracts as metadata&quot;&quot;&quot;</span>

    <span class="c1">#: priority (int): is the load order for the class, smaller numbers are tried before larger numbers.</span>
    <span class="c1">#   .. note::</span>
    <span class="c1">#      Subclasses with priority&lt;=32 should make some positive identification that they have the right</span>
    <span class="c1">#      file type before attempting to read data.</span>
    <span class="n">priority</span><span class="o">=</span><span class="mi">32</span> <span class="c1"># reasonably generic format</span>
    <span class="c1">#: pattern (list of str): A list of file extensions that might contain this type of file. Used to construct</span>
    <span class="c1"># the file load/save dialog boxes.</span>
    <span class="n">patterns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*.png&quot;</span><span class="p">]</span> <span class="c1"># Recognised filename patterns</span>

    <span class="n">mime_type</span><span class="o">=</span><span class="s2">&quot;image/png&quot;</span>

    <span class="k">def</span> <span class="nf">_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;PNG file loader routine.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (string or bool): File to load. If None then the existing filename is used,</span>
<span class="sd">                if False, then a file dialog will be used.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A copy of the itself after loading the data.</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_filename</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">img</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">img</span><span class="o">.</span><span class="n">info</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">=</span><span class="n">_np_</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s2">&quot;Unable to read as a PNG file.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Overrides the save method to allow KermitPNGFiles to be written out to disc</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (string): Filename to save as (using the same rules as for the load routines)</span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">            deliminator (string): Record deliniminator (defaults to a comma)</span>

<span class="sd">        Returns:</span>
<span class="sd">            A copy of itself.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">):</span>  <span class="c1"># now go and ask for one</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__file_dialog</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>

        <span class="n">metadata</span><span class="o">=</span><span class="n">PIL</span><span class="o">.</span><span class="n">PngImagePlugin</span><span class="o">.</span><span class="n">PngInfo</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
            <span class="n">key</span><span class="o">=</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">val</span><span class="o">=</span><span class="n">str2bytes</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">val</span><span class="p">)</span>
        <span class="n">img</span><span class="o">=</span><span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s2">&quot;png&quot;</span><span class="p">,</span><span class="n">pnginfo</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span>
        <span class="k">return</span> <span class="bp">self</span>

<span class="k">try</span><span class="p">:</span> <span class="c1">#Optional tdms support</span>
    <span class="kn">from</span> <span class="nn">nptdms</span> <span class="k">import</span> <span class="n">TdmsFile</span>
    
<div class="viewcode-block" id="TDMSFile"><a class="viewcode-back" href="../../classes/Stoner.FileFormats.TDMSFile.html#Stoner.FileFormats.TDMSFile">[docs]</a>    <span class="k">class</span> <span class="nc">TDMSFile</span><span class="p">(</span><span class="n">DataFile</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;A first stab at writing a file that will import TDMS files&quot;&quot;&quot;</span>
    
        <span class="c1">#: priority (int): is the load order for the class, smaller numbers are tried before larger numbers.</span>
        <span class="c1">#   .. note::</span>
        <span class="c1">#      Subclasses with priority&lt;=32 should make some positive identification that they have the right</span>
        <span class="c1">#      file type before attempting to read data.</span>
        <span class="n">priority</span><span class="o">=</span><span class="mi">16</span> <span class="c1"># Makes a positive ID of its file contents</span>
        <span class="c1">#: pattern (list of str): A list of file extensions that might contain this type of file. Used to construct</span>
        <span class="c1"># the file load/save dialog boxes.</span>
        <span class="n">patterns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*.tdms&quot;</span><span class="p">]</span> <span class="c1"># Recognised filename patterns</span>
    
        <span class="n">mime_type</span><span class="o">=</span><span class="s2">&quot;application/octet-stream&quot;</span>
    
        <span class="k">def</span> <span class="nf">_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;TDMS file loader routine.</span>
<span class="sd">    </span>
<span class="sd">            Args:</span>
<span class="sd">                filename (string or bool): File to load. If None then the existing filename is used,</span>
<span class="sd">                    if False, then a file dialog will be used.</span>
<span class="sd">    </span>
<span class="sd">            Returns:</span>
<span class="sd">                A copy of the itself after loading the data.</span>
<span class="sd">                &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_filename</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
            <span class="c1"># Open the file and read the main file header and unpack into a dict</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">f</span><span class="o">=</span><span class="n">TdmsFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
                       
                <span class="n">column_headers</span><span class="o">=</span><span class="p">[]</span>
                <span class="n">data</span><span class="o">=</span><span class="n">_np_</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
                        
                
                <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">grp</span><span class="o">==</span><span class="s2">&quot;/&quot;</span><span class="p">:</span>
                        <span class="k">pass</span> <span class="c1">#skip the rooot group</span>
                    <span class="k">elif</span> <span class="n">grp</span><span class="o">==</span><span class="s2">&quot;/&#39;TDI Format 1.5&#39;&quot;</span><span class="p">:</span>
                        <span class="n">metadata</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="s2">&quot;TDI Format 1.5&quot;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">string_to_type</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">objects</span><span class="p">[</span><span class="n">grp</span><span class="p">]</span><span class="o">.</span><span class="n">has_data</span><span class="p">:</span>
                            <span class="n">chnl</span><span class="o">=</span><span class="n">grp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">chnl</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
                            <span class="n">column_headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chnl</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                                <span class="n">data</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">objects</span><span class="p">[</span><span class="n">grp</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">data</span><span class="o">=</span><span class="n">_np_</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">data</span><span class="p">,</span><span class="n">f</span><span class="o">.</span><span class="n">objects</span><span class="p">[</span><span class="n">grp</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">=</span><span class="n">data</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span><span class="o">=</span><span class="n">column_headers</span>                       
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">traceback</span> <span class="k">import</span> <span class="n">format_exc</span>
                <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s1">&#39;Not a TDMS File </span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">format_exc</span><span class="p">()))</span>
            
            <span class="k">return</span> <span class="bp">self</span></div>

<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/StonerLogo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Stoner Package</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2013-15, Gavin Burnell et al.
      Last updated on Apr 20, 2017.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.1.
    </div>
  </body>
</html>