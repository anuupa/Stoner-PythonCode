
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stoner.Image.imagefuncs &#8212; Stoner Pacakge API Documentation</title>
    <link rel="stylesheet" href="../../../_static/better.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  </head><body>
    <header id="pageheader"><h1><a href="../../../index.html ">
        Stoner Pacakge API Documentation
    </a></h1></header>
  <div class="related top">
  <nav id="rellinks">
    <ul>
    </ul>
  </nav>
  <nav id="breadcrumbs">
    <ul>
      <li><a href="../../../index.html">Stoner Package</a></li>
      <li>
        <a href="../../index.html">Module code</a>
      </li> 
    </ul>
  </nav>
  </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for Stoner.Image.imagefuncs</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;Functions for manipulating Kerr (or any other) images.</span>

<span class="sd">All of these functions are accessible through the :class:`ImageArray` attributes e.g.:</span>

<span class="sd">    k=ImageArray(&#39;myfile&#39;); k.level_image().</span>

<span class="sd">The first &#39;im&#39; function argument is automatically added in this case.</span>

<span class="sd">If you want to add new functions that&#39;s great. There&#39;s a few important points:</span>

<span class="sd">    * Please make sure they take an image as the first argument</span>

<span class="sd">    * Don&#39;t give them the same name as functions from the numpy library or</span>
<span class="sd">          skimage library if you don&#39;t want to override them.</span>

<span class="sd">    * The function should not change the shape of the array. Please use crop_image</span>
<span class="sd">          before doing the function if you want to do that.</span>

<span class="sd">    * After that you&#39;re free to treat im as a ImageArray</span>
<span class="sd">          or numpy array, it should all behave the same.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;adjust_contrast&quot;</span><span class="p">,</span>
    <span class="s2">&quot;align&quot;</span><span class="p">,</span>
    <span class="s2">&quot;convert&quot;</span><span class="p">,</span>
    <span class="s2">&quot;correct_drift&quot;</span><span class="p">,</span>
    <span class="s2">&quot;subtract_image&quot;</span><span class="p">,</span>
    <span class="s2">&quot;fft&quot;</span><span class="p">,</span>
    <span class="s2">&quot;filter_image&quot;</span><span class="p">,</span>
    <span class="s2">&quot;gridimage&quot;</span><span class="p">,</span>
    <span class="s2">&quot;hist&quot;</span><span class="p">,</span>
    <span class="s2">&quot;imshow&quot;</span><span class="p">,</span>
    <span class="s2">&quot;level_image&quot;</span><span class="p">,</span>
    <span class="s2">&quot;normalise&quot;</span><span class="p">,</span>
    <span class="s2">&quot;profile_line&quot;</span><span class="p">,</span>
    <span class="s2">&quot;quantize&quot;</span><span class="p">,</span>
    <span class="s2">&quot;radial_coordinates&quot;</span><span class="p">,</span>
    <span class="s2">&quot;radial_profile&quot;</span><span class="p">,</span>
    <span class="s2">&quot;remove_outliers&quot;</span><span class="p">,</span>
    <span class="s2">&quot;rotate&quot;</span><span class="p">,</span>
    <span class="s2">&quot;translate&quot;</span><span class="p">,</span>
    <span class="s2">&quot;translate_limits&quot;</span><span class="p">,</span>
    <span class="s2">&quot;plot_histogram&quot;</span><span class="p">,</span>
    <span class="s2">&quot;threshold_minmax&quot;</span><span class="p">,</span>
    <span class="s2">&quot;do_nothing&quot;</span><span class="p">,</span>
    <span class="s2">&quot;denoise&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">io</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">griddata</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">gaussian_filter</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">signal</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">to_rgba</span><span class="p">,</span> <span class="n">ListedColormap</span>
<span class="kn">import</span> <span class="nn">matplotlib.cm</span> <span class="k">as</span> <span class="nn">cm</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">feature</span><span class="p">,</span> <span class="n">measure</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">filters</span>

<span class="kn">from</span> <span class="nn">PyQt5.QtGui</span> <span class="kn">import</span> <span class="n">QImage</span>
<span class="kn">from</span> <span class="nn">PyQt5.QtWidgets</span> <span class="kn">import</span> <span class="n">QApplication</span>

<span class="kn">from</span> <span class="nn">Stoner.compat</span> <span class="kn">import</span> <span class="n">string_types</span>
<span class="kn">from</span> <span class="nn">Stoner.tools</span> <span class="kn">import</span> <span class="n">isTuple</span><span class="p">,</span> <span class="n">isIterable</span><span class="p">,</span> <span class="n">make_Data</span>
<span class="kn">from</span> <span class="nn">.core</span> <span class="kn">import</span> <span class="n">ImageArray</span>
<span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">sign_loss</span><span class="p">,</span> <span class="n">_dtype2</span><span class="p">,</span> <span class="n">_supported_types</span><span class="p">,</span> <span class="n">prec_loss</span><span class="p">,</span> <span class="n">dtype_range</span><span class="p">,</span> <span class="n">_dtype</span><span class="p">,</span> <span class="n">_scale</span> <span class="k">as</span> <span class="n">im_scale</span>

<span class="k">try</span><span class="p">:</span>  <span class="c1"># Make OpenCV an optional import</span>
    <span class="kn">import</span> <span class="nn">cv2</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">cv2</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">try</span><span class="p">:</span>  <span class="c1"># Make imreg_dfft2 optional</span>
    <span class="kn">import</span> <span class="nn">imreg_dft</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">imreg_dft</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">try</span><span class="p">:</span>  <span class="c1"># image_registration module</span>
    <span class="kn">from</span> <span class="nn">image_registration</span> <span class="kn">import</span> <span class="n">chi2_shift</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">chi2_shift</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">_scale</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">to_pixel</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert pixel cordinates to scaled co-ordinates or visa versa.</span>

<span class="sd">    Args:</span>
<span class="sd">        coord(int,float or iterable): Coordinates to be scaled</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">        scale(float): Microns per Pixel scale of image</span>
<span class="sd">        to_pixel(bool): Force the conversion to be to pixels</span>

<span class="sd">    Returns:</span>
<span class="sd">        scaled co-ordinates.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">to_pixel</span><span class="p">:</span>
            <span class="n">coord</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">to_pixel</span><span class="p">:</span>
            <span class="n">coord</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">coord</span> <span class="o">/</span> <span class="n">scale</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">isIterable</span><span class="p">(</span><span class="n">coord</span><span class="p">):</span>
        <span class="n">coord</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">_scale</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">to_pixel</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">coord</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;coord should be an integer or a float or an iterable of integers and floats&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">coord</span>


<div class="viewcode-block" id="adjust_contrast"><a class="viewcode-back" href="../../../classes/Stoner.Image.imagefuncs.adjust_contrast.html#Stoner.Image.imagefuncs.adjust_contrast">[docs]</a><span class="k">def</span> <span class="nf">adjust_contrast</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">lims</span><span class="o">=</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">),</span> <span class="n">percent</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Rescale the intensity of the image.</span>

<span class="sd">    Mostly a call through to skimage.exposure.rescale_intensity. The absolute limits of contrast are</span>
<span class="sd">    added to the metadata as &#39;adjust_contrast&#39;</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lims: 2-tuple</span>
<span class="sd">        limits of rescaling the intensity</span>
<span class="sd">    percent: bool</span>
<span class="sd">        if True then lims are the give the percentile of the image intensity</span>
<span class="sd">        histogram, otherwise lims are absolute</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    image: ImageArray</span>
<span class="sd">        rescaled image</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">percent</span><span class="p">:</span>
        <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lims</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">lims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">im</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;adjust_contrast&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">)</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">rescale_intensity</span><span class="p">(</span><span class="n">in_range</span><span class="o">=</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">))</span>  <span class="c1"># clip the intensity</span>
    <span class="k">return</span> <span class="n">im</span></div>


<span class="k">def</span> <span class="nf">_align_scharr</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the translation vector to shirt im to align to ref using the Scharr method.&quot;&quot;&quot;</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">/</span> <span class="mf">500.0</span><span class="p">)</span>
    <span class="n">ref1</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">scharr</span><span class="p">(</span><span class="n">gaussian_filter</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;wrap&quot;</span><span class="p">))</span>
    <span class="n">im1</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">scharr</span><span class="p">(</span><span class="n">gaussian_filter</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;wrap&quot;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">_align_imreg_dft</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span> <span class="n">ref1</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_align_chi2_shift</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the translation vector to shirt im to align to ref using the chi^2 shift method.&quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">chi2_shift</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">))</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">{}</span>


<span class="k">def</span> <span class="nf">_align_imreg_dft</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the translation vector to shirt im to align to ref using the imreg_dft method.&quot;&quot;&quot;</span>
    <span class="n">constraints</span> <span class="o">=</span> <span class="n">kargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;constraints&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;angle&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]})</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>  <span class="c1"># This causes a warning due to the masking</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">imreg_dft</span><span class="o">.</span><span class="n">similarity</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">)</span>
    <span class="n">tvec</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;tvec&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tvec</span><span class="p">),</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">_align_cv2</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>  <span class="c1"># pylint: disable=unused-argument</span>
    <span class="sd">&quot;&quot;&quot;Return the translation vector to shirt im to align to ref using the cv2 method.&quot;&quot;&quot;</span>
    <span class="n">im1_gray</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;uint8&quot;</span><span class="p">,</span> <span class="n">force_copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">im2_gray</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;uint8&quot;</span><span class="p">,</span> <span class="n">force_copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Define the motion model</span>
    <span class="n">warp_mode</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">MOTION_TRANSLATION</span>
    <span class="n">warp_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="c1"># Specify the number of iterations.</span>
    <span class="n">number_of_iterations</span> <span class="o">=</span> <span class="mi">5000</span>

    <span class="c1"># Specify the threshold of the increment</span>
    <span class="c1"># in the correlation coefficient between two iterations</span>
    <span class="n">termination_eps</span> <span class="o">=</span> <span class="mf">1e-10</span>

    <span class="c1"># Define termination criteria</span>
    <span class="n">criteria</span> <span class="o">=</span> <span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">TERM_CRITERIA_EPS</span> <span class="o">|</span> <span class="n">cv2</span><span class="o">.</span><span class="n">TERM_CRITERIA_COUNT</span><span class="p">,</span> <span class="n">number_of_iterations</span><span class="p">,</span> <span class="n">termination_eps</span><span class="p">)</span>

    <span class="c1"># Run the ECC algorithm. The results are stored in warp_matrix.</span>
    <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">warp_matrix</span><span class="p">)</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findTransformECC</span><span class="p">(</span>
        <span class="n">im1_gray</span><span class="p">,</span> <span class="n">im2_gray</span><span class="p">,</span> <span class="n">warp_matrix</span><span class="p">,</span> <span class="n">warp_mode</span><span class="p">,</span> <span class="n">criteria</span><span class="p">,</span> <span class="n">inputMask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gaussFiltSize</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="o">-</span><span class="n">warp_matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">{}</span>


<div class="viewcode-block" id="align"><a class="viewcode-back" href="../../../classes/Stoner.Image.imagefuncs.align.html#Stoner.Image.imagefuncs.align">[docs]</a><span class="k">def</span> <span class="nf">align</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;scharr&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Use one of a variety of algroithms to align two images.</span>

<span class="sd">    Args:</span>
<span class="sd">        im (ndarray) image to align</span>
<span class="sd">        ref (ndarray) reference array</span>

<span class="sd">    Keyword Args:</span>
<span class="sd">        method (str or None):</span>
<span class="sd">            If given specifies which module to try and use.</span>
<span class="sd">            Options: &#39;scharr&#39;, &#39;chi2_shift&#39;, &#39;imreg_dft&#39;, &#39;cv2&#39;</span>
<span class="sd">        box (integer, float, tuple of images or floats):</span>
<span class="sd">            Used with ImageArray.crop to select a subset of the image to use for the aligning process.</span>
<span class="sd">        oversample (int):</span>
<span class="sd">            Rescale the image and reference image by constant factor before finding the translation vector.</span>
<span class="sd">        **kargs (various): All other keyword arguments are passed to the specific algorithm.</span>


<span class="sd">    Returns</span>
<span class="sd">        (ImageArray or ndarray) aligned image</span>

<span class="sd">    Notes:</span>
<span class="sd">        Currently three algorithms are supported:</span>
<span class="sd">            - image_registration module&#39;s chi^2 shift: This uses a dft with an automatic</span>
<span class="sd">              up-sampling of the fourier transform for sub-pixel alignment. The metadata</span>
<span class="sd">              key *chi2_shift* contains the translation vector and errors.</span>
<span class="sd">            - imreg_dft module&#39;s similarity function. This implements a full scale, rotation, translation</span>
<span class="sd">              algorithm (by default cosntrained for just translation). It&#39;s unclear how much sub-pixel translation</span>
<span class="sd">              is accomodated.</span>
<span class="sd">            - cv2 module based affine transform on a gray scale image.</span>
<span class="sd">              from: http://www.learnopencv.com/image-alignment-ecc-in-opencv-c-python/</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># To be consistent with x-y co-ordinate systems</span>
    <span class="n">align_methods</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;scharr&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">_align_scharr</span><span class="p">,</span> <span class="n">imreg_dft</span><span class="p">),</span>
        <span class="s2">&quot;chi2_shift&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">_align_chi2_shift</span><span class="p">,</span> <span class="n">chi2_shift</span><span class="p">),</span>
        <span class="s2">&quot;imreg_dft&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">_align_imreg_dft</span><span class="p">,</span> <span class="n">imreg_dft</span><span class="p">),</span>
        <span class="s2">&quot;cv2&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">_align_cv2</span><span class="p">,</span> <span class="n">cv2</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">meth</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">align_methods</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">align_methods</span><span class="p">[</span><span class="n">meth</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">mod</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">align_methods</span><span class="p">[</span><span class="n">meth</span><span class="p">]</span>
    <span class="n">method</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">new_type</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">dtype</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">align_methods</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;align requires one of imreg_dft, chi2_shift or cv2 modules to be available.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">align_methods</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2"> is not available either because it is not recognised or there is a missing module&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;box&quot;</span> <span class="ow">in</span> <span class="n">kargs</span><span class="p">:</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">kargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;box&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isIterable</span><span class="p">(</span><span class="n">box</span><span class="p">):</span>
            <span class="n">box</span> <span class="o">=</span> <span class="p">[</span><span class="n">box</span><span class="p">]</span>
        <span class="n">working</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="o">*</span><span class="n">box</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ref</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">working</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">ImageArray</span><span class="p">)</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="o">*</span><span class="n">box</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">working</span> <span class="o">=</span> <span class="n">im</span>

    <span class="n">scale</span> <span class="o">=</span> <span class="n">kargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;scale&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">scale</span><span class="p">:</span>
        <span class="n">working</span> <span class="o">=</span> <span class="n">working</span><span class="o">.</span><span class="n">rescale</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">rescale</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="n">prefilter</span> <span class="o">=</span> <span class="n">kargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;prefilter&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">tvec</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">align_methods</span><span class="p">[</span><span class="n">method</span><span class="p">][</span><span class="mi">0</span><span class="p">](</span><span class="n">working</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
        <span class="n">tvec</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">im</span>

    <span class="k">if</span> <span class="n">scale</span><span class="p">:</span>
        <span class="n">tvec</span> <span class="o">/=</span> <span class="n">scale</span>
    <span class="n">new_im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shift</span><span class="p">((</span><span class="n">tvec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">tvec</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">prefilter</span><span class="o">=</span><span class="n">prefilter</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">new_type</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">new_im</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="n">new_im</span><span class="p">[</span><span class="s2">&quot;tvec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">tvec</span><span class="p">)</span>
    <span class="n">new_im</span><span class="p">[</span><span class="s2">&quot;translation_limits&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_im</span><span class="o">.</span><span class="n">translate_limits</span><span class="p">(</span><span class="s2">&quot;tvec&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_im</span></div>


<div class="viewcode-block" id="convert"><a class="viewcode-back" href="../../../classes/Stoner.Image.imagefuncs.convert.html#Stoner.Image.imagefuncs.convert">[docs]</a><span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">force_copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">uniform</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">normalise</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert an image to the requested data-type.</span>

<span class="sd">    Warnings are issued in case of precision loss, or when negative values</span>
<span class="sd">    are clipped during conversion to unsigned integer types (sign loss).</span>

<span class="sd">    Floating point values are expected to be normalized and will be clipped</span>
<span class="sd">    to the range [0.0, 1.0] or [-1.0, 1.0] when converting to unsigned or</span>
<span class="sd">    signed integers respectively.</span>

<span class="sd">    Numbers are not shifted to the negative side when converting from</span>
<span class="sd">    unsigned to signed integer types. Negative values will be clipped when</span>
<span class="sd">    converting to unsigned integers.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image : ndarray</span>
<span class="sd">        Input image.</span>
<span class="sd">    dtype : dtype</span>
<span class="sd">        Target data-type.</span>
<span class="sd">    force_copy : bool</span>
<span class="sd">        Force a copy of the data, irrespective of its current dtype.</span>
<span class="sd">    uniform : bool</span>
<span class="sd">        Uniformly quantize the floating point range to the integer range.</span>
<span class="sd">        By default (uniform=False) floating point values are scaled and</span>
<span class="sd">        rounded to the nearest integers, which minimizes back and forth</span>
<span class="sd">        conversion errors.</span>
<span class="sd">    normalise : bool</span>
<span class="sd">        When converting from int types to float normalise the resulting array</span>
<span class="sd">        by the maximum allowed value of the int type.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    (1) DirectX data conversion rules.</span>
<span class="sd">        http://msdn.microsoft.com/en-us/library/windows/desktop/dd607323%28v=vs.85%29.aspx</span>
<span class="sd">    (2) Data Conversions.</span>
<span class="sd">        In &quot;OpenGL ES 2.0 Specification v2.0.25&quot;, pp 7-8. Khronos Group, 2010.</span>
<span class="sd">    (3) Proper treatment of pixels as integers. A.W. Paeth.</span>
<span class="sd">        In &quot;Graphics Gems I&quot;, pp 249-256. Morgan Kaufmann, 1990.</span>
<span class="sd">    (4) Dirty Pixels. J. Blinn.</span>
<span class="sd">        In &quot;Jim Blinn&#39;s corner: Dirty Pixels&quot;, pp 47-57. Morgan Kaufmann, 1998.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="n">dtypeobj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">dtypeobj_in</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">dtype</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">dtypeobj</span><span class="o">.</span><span class="n">type</span>
    <span class="n">dtype_in</span> <span class="o">=</span> <span class="n">dtypeobj_in</span><span class="o">.</span><span class="n">type</span>

    <span class="k">if</span> <span class="n">dtype_in</span> <span class="o">==</span> <span class="n">dtype</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">force_copy</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">clone</span>
        <span class="k">return</span> <span class="n">image</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">dtype_in</span> <span class="ow">in</span> <span class="n">_supported_types</span> <span class="ow">and</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">_supported_types</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;can not convert </span><span class="si">{</span><span class="n">dtype_in</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="n">kind</span> <span class="o">=</span> <span class="n">dtypeobj</span><span class="o">.</span><span class="n">kind</span>
    <span class="n">kind_in</span> <span class="o">=</span> <span class="n">dtypeobj_in</span><span class="o">.</span><span class="n">kind</span>
    <span class="n">itemsize</span> <span class="o">=</span> <span class="n">dtypeobj</span><span class="o">.</span><span class="n">itemsize</span>
    <span class="n">itemsize_in</span> <span class="o">=</span> <span class="n">dtypeobj_in</span><span class="o">.</span><span class="n">itemsize</span>

    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span>
        <span class="c1"># to binary image</span>
        <span class="k">if</span> <span class="n">kind_in</span> <span class="ow">in</span> <span class="s2">&quot;fi&quot;</span><span class="p">:</span>
            <span class="n">sign_loss</span><span class="p">(</span><span class="n">dtype_in</span><span class="p">,</span> <span class="n">dtypeobj</span><span class="p">)</span>
        <span class="n">prec_loss</span><span class="p">(</span><span class="n">dtypeobj_in</span><span class="p">,</span> <span class="n">dtypeobj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">image</span> <span class="o">&gt;</span> <span class="n">dtype_in</span><span class="p">(</span><span class="n">dtype_range</span><span class="p">[</span><span class="n">dtype_in</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">kind_in</span> <span class="o">==</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span>
        <span class="c1"># from binary image, to float and to integer</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">image</span><span class="p">,</span> <span class="o">*</span><span class="n">dtype_range</span><span class="p">[</span><span class="n">dtype</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">if</span> <span class="n">kind</span> <span class="ow">in</span> <span class="s2">&quot;ui&quot;</span><span class="p">:</span>
        <span class="n">imin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">min</span>
        <span class="n">imax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">max</span>
    <span class="k">if</span> <span class="n">kind_in</span> <span class="ow">in</span> <span class="s2">&quot;ui&quot;</span><span class="p">:</span>
        <span class="n">imin_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">dtype_in</span><span class="p">)</span><span class="o">.</span><span class="n">min</span>
        <span class="n">imax_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">dtype_in</span><span class="p">)</span><span class="o">.</span><span class="n">max</span>

    <span class="k">if</span> <span class="n">kind_in</span> <span class="o">==</span> <span class="s2">&quot;f&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">image</span><span class="p">)</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1.0</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">image</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Images of type float must be between -1 and 1.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;f&quot;</span><span class="p">:</span>
            <span class="c1"># floating point -&gt; floating point</span>
            <span class="k">if</span> <span class="n">itemsize_in</span> <span class="o">&gt;</span> <span class="n">itemsize</span><span class="p">:</span>
                <span class="n">prec_loss</span><span class="p">(</span><span class="n">dtypeobj_in</span><span class="p">,</span> <span class="n">dtypeobj</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>

        <span class="c1"># floating point -&gt; integer</span>
        <span class="n">prec_loss</span><span class="p">(</span><span class="n">dtypeobj_in</span><span class="p">,</span> <span class="n">dtypeobj</span><span class="p">)</span>
        <span class="c1"># use float type that can represent output integer type</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">_dtype</span><span class="p">(</span><span class="n">itemsize</span><span class="p">,</span> <span class="n">dtype_in</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">uniform</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;u&quot;</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">*=</span> <span class="n">imax</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">*=</span> <span class="n">imax</span> <span class="o">-</span> <span class="n">imin</span>
                <span class="n">image</span> <span class="o">-=</span> <span class="mf">1.0</span>
                <span class="n">image</span> <span class="o">/=</span> <span class="mf">2.0</span>
            <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">image</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">imin</span><span class="p">,</span> <span class="n">imax</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">image</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;u&quot;</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">*=</span> <span class="n">imax</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">imax</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">image</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">*=</span> <span class="p">(</span><span class="n">imax</span> <span class="o">-</span> <span class="n">imin</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">image</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">imin</span><span class="p">,</span> <span class="n">imax</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">image</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;f&quot;</span><span class="p">:</span>
        <span class="c1"># integer -&gt; floating point</span>
        <span class="k">if</span> <span class="n">itemsize_in</span> <span class="o">&gt;=</span> <span class="n">itemsize</span><span class="p">:</span>
            <span class="n">prec_loss</span><span class="p">(</span><span class="n">dtypeobj_in</span><span class="p">,</span> <span class="n">dtypeobj</span><span class="p">)</span>
        <span class="c1"># use float type that can exactly represent input integers</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">_dtype</span><span class="p">(</span><span class="n">itemsize_in</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">normalise</span><span class="p">:</span>  <span class="c1"># normalise floats by maximum value of int type</span>
            <span class="k">if</span> <span class="n">kind_in</span> <span class="o">==</span> <span class="s2">&quot;u&quot;</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">/=</span> <span class="n">imax_in</span>
                <span class="c1"># DirectX uses this conversion also for signed ints</span>
                <span class="c1"># if imin_in:</span>
                <span class="c1">#    np.maximum(image, -1.0, out=image)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">*=</span> <span class="mf">2.0</span>
                <span class="n">image</span> <span class="o">+=</span> <span class="mf">1.0</span>
                <span class="n">image</span> <span class="o">/=</span> <span class="n">imax_in</span> <span class="o">-</span> <span class="n">imin_in</span>
        <span class="k">return</span> <span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">kind_in</span> <span class="o">==</span> <span class="s2">&quot;u&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;i&quot;</span><span class="p">:</span>
            <span class="c1"># unsigned integer -&gt; signed integer</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">im_scale</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">itemsize_in</span><span class="p">,</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">itemsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtypeobj_in</span><span class="p">,</span> <span class="n">dtypeobj</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">image</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
        <span class="c1"># unsigned integer -&gt; unsigned integer</span>
        <span class="k">return</span> <span class="n">im_scale</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">itemsize_in</span><span class="p">,</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">itemsize</span><span class="p">,</span> <span class="n">dtypeobj_in</span><span class="p">,</span> <span class="n">dtypeobj</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;u&quot;</span><span class="p">:</span>
        <span class="c1"># signed integer -&gt; unsigned integer</span>
        <span class="n">sign_loss</span><span class="p">(</span><span class="n">dtype_in</span><span class="p">,</span> <span class="n">dtypeobj</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">im_scale</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">itemsize_in</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">itemsize</span><span class="p">,</span> <span class="n">dtypeobj_in</span><span class="p">,</span> <span class="n">dtypeobj</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">result</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">casting</span><span class="o">=</span><span class="s2">&quot;unsafe&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="c1"># signed integer -&gt; signed integer</span>
    <span class="k">if</span> <span class="n">itemsize_in</span> <span class="o">&gt;</span> <span class="n">itemsize</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">im_scale</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">itemsize_in</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">itemsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtypeobj_in</span><span class="p">,</span> <span class="n">dtypeobj</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">_dtype2</span><span class="p">(</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="n">itemsize</span> <span class="o">*</span> <span class="mi">8</span><span class="p">))</span>
    <span class="n">image</span> <span class="o">-=</span> <span class="n">imin_in</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">im_scale</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">itemsize_in</span><span class="p">,</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">itemsize</span><span class="p">,</span> <span class="n">dtypeobj_in</span><span class="p">,</span> <span class="n">dtypeobj</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">+=</span> <span class="n">imin</span>
    <span class="k">return</span> <span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span></div>


<div class="viewcode-block" id="correct_drift"><a class="viewcode-back" href="../../../classes/Stoner.Image.imagefuncs.correct_drift.html#Stoner.Image.imagefuncs.correct_drift">[docs]</a><span class="k">def</span> <span class="nf">correct_drift</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span> <span class="n">upsample_factor</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">do_shift</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Align images to correct for image drift.</span>

<span class="sd">    Args:</span>
<span class="sd">        ref (ImageArray): Reference image with assumed zero drift</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">        threshold (float): threshold for detecting imperfections in images</span>
<span class="sd">            (see skimage.feature.corner_fast for details)</span>
<span class="sd">        upsample_factor (float): the resolution for the shift 1/upsample_factor pixels registered.</span>
<span class="sd">            see skimage.feature.register_translation for more details</span>
<span class="sd">        box (sequence of 4 ints): defines a region of the image to use for identifyign the drift</span>
<span class="sd">            defaults to the whol image. Use this to avoid drift calculations being confused by</span>
<span class="sd">            the scale bar/annotation region.</span>
<span class="sd">        do_shift (bool): Shift the image, or just calculate the drift and store in metadata (default True, shit)</span>

<span class="sd">    Returns:</span>
<span class="sd">        A shifted iamge with the image shift added to the metadata as &#39;correct drift&#39;.</span>

<span class="sd">    Detects common features on the images and tracks them moving.</span>
<span class="sd">    Adds &#39;drift_shift&#39; to the metadata as the (x,y) vector that translated the</span>
<span class="sd">    image back to it&#39;s origin.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">box</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">max_box</span>
    <span class="n">cim</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="n">box</span><span class="o">=</span><span class="n">box</span><span class="p">)</span>

    <span class="n">refed</span> <span class="o">=</span> <span class="n">ImageArray</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">get_metadata</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">refed</span> <span class="o">=</span> <span class="n">refed</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="n">box</span><span class="o">=</span><span class="n">box</span><span class="p">)</span>
    <span class="n">refed</span> <span class="o">=</span> <span class="n">refed</span><span class="o">.</span><span class="n">filter_image</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">refed</span> <span class="o">=</span> <span class="n">refed</span> <span class="o">&gt;</span> <span class="n">refed</span><span class="o">.</span><span class="n">threshold_otsu</span><span class="p">()</span>
    <span class="n">refed</span> <span class="o">=</span> <span class="n">refed</span><span class="o">.</span><span class="n">corner_fast</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">)</span>

    <span class="n">imed</span> <span class="o">=</span> <span class="n">cim</span><span class="o">.</span><span class="n">clone</span>
    <span class="n">imed</span> <span class="o">=</span> <span class="n">imed</span><span class="o">.</span><span class="n">filter_image</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">imed</span> <span class="o">=</span> <span class="n">imed</span> <span class="o">&gt;</span> <span class="n">imed</span><span class="o">.</span><span class="n">threshold_otsu</span><span class="p">()</span>
    <span class="n">imed</span> <span class="o">=</span> <span class="n">imed</span><span class="o">.</span><span class="n">corner_fast</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">)</span>

    <span class="n">shift</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">register_translation</span><span class="p">(</span><span class="n">refed</span><span class="p">,</span> <span class="n">imed</span><span class="p">,</span> <span class="n">upsample_factor</span><span class="o">=</span><span class="n">upsample_factor</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">do_shift</span><span class="p">:</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">translation</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">shift</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="n">shift</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>  <span class="c1"># x,y</span>
    <span class="n">im</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;correct_drift&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">shift</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="n">shift</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">im</span></div>


<div class="viewcode-block" id="subtract_image"><a class="viewcode-back" href="../../../classes/Stoner.Image.imagefuncs.subtract_image.html#Stoner.Image.imagefuncs.subtract_image">[docs]</a><span class="k">def</span> <span class="nf">subtract_image</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">background</span><span class="p">,</span> <span class="n">contrast</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Subtract a background image from the ImageArray.</span>

<span class="sd">    Multiply the contrast by the contrast parameter.</span>
<span class="sd">    If clip is on then clip the intensity after for the maximum allowed data range.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">asfloat</span><span class="p">(</span><span class="n">normalise</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">clip_negative</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">contrast</span> <span class="o">*</span> <span class="p">(</span><span class="n">im</span> <span class="o">-</span> <span class="n">background</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span>
    <span class="k">if</span> <span class="n">clip</span><span class="p">:</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">clip_intensity</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">im</span></div>


<div class="viewcode-block" id="fft"><a class="viewcode-back" href="../../../classes/Stoner.Image.imagefuncs.fft.html#Stoner.Image.imagefuncs.fft">[docs]</a><span class="k">def</span> <span class="nf">fft</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">remove_dc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">gaussian</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Perform a 2d fft of the image and shift the result to get zero frequency in the centre.</span>

<span class="sd">    Keyword Args:</span>
<span class="sd">        shift (bool):</span>
<span class="sd">            Shift the fft so that zero order is in the centre of the image. Default True</span>
<span class="sd">        phase (bool, None):</span>
<span class="sd">            If true, return the phase angle rather than the magnitude if False. If None, return the raw fft.</span>
<span class="sd">            Default False - return magnitude of fft.</span>
<span class="sd">        remove_dc(bool):</span>
<span class="sd">            Replace the points around the dc offset with the mean of the fft to avoid dc offset artefacts.</span>
<span class="sd">            Default False</span>
<span class="sd">        gaussian (None or float):</span>
<span class="sd">            Apply a gaussian blur to the fft where this parameter is the width of the blue in px. Default None for off.</span>

<span class="sd">    Return:</span>
<span class="sd">        fft of the image, preserving metadata.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">remove_dc</span><span class="p">:</span>
        <span class="n">fill</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fill</span>
        <span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fill</span>
        <span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fill</span>
        <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fill</span>
    <span class="k">if</span> <span class="n">shift</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">phase</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">phase</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gaussian</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
        <span class="n">r</span><span class="o">.</span><span class="n">gaussian</span><span class="p">(</span><span class="n">gaussian</span><span class="p">)</span>

    <span class="n">r</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">r</span></div>


<div class="viewcode-block" id="filter_image"><a class="viewcode-back" href="../../../classes/Stoner.Image.imagefuncs.filter_image.html#Stoner.Image.imagefuncs.filter_image">[docs]</a><span class="k">def</span> <span class="nf">filter_image</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Alias for skimage.filters.gaussian.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">im</span><span class="o">.</span><span class="n">gaussian</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span></div>


<div class="viewcode-block" id="gridimage"><a class="viewcode-back" href="../../../classes/Stoner.Image.imagefuncs.gridimage.html#Stoner.Image.imagefuncs.gridimage">[docs]</a><span class="k">def</span> <span class="nf">gridimage</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">points</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rescale</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Use :py:func:`scipy.interpolate.griddata` to shift the image to a regular grid of co-ordinates.</span>

<span class="sd">    Args:</span>
<span class="sd">        points (tuple of (x-co-ords,yco-ordsa)):</span>
<span class="sd">            The actual sampled data co-ordinates</span>
<span class="sd">        xi (tupe of (2D array,2D array)):</span>
<span class="sd">            The regular grid co-ordinates (as generated by e.g. :py:func:`np.meshgrid`)</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">        method (&quot;linear&quot;,&quot;cubic&quot;,&quot;nearest&quot;):</span>
<span class="sd">            how to interpolate, default is linear</span>
<span class="sd">        fill_value (folat, Callable, None):</span>
<span class="sd">            What to put when the co-ordinates go out of range (default is None). May be a callable</span>
<span class="sd">            in which case the initial image is presented as the only argument. If None, use the mean value.</span>
<span class="sd">        rescale (bool):</span>
<span class="sd">            If the x and y co-ordinates are very different in scale, set this to True.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A copy of the modified image. The image data is interpolated and metadata kets &quot;actual_x&quot;,&quot;actual_y&quot;,&quot;sample_</span>
<span class="sd">        x&quot;,&quot;samp[le_y&quot; are set to give co-ordinates of new grid.</span>

<span class="sd">    Notes:</span>
<span class="sd">        If points and or xi are missed out then we try to construct them from the metadata. For points, the metadata</span>
<span class="sd">        keys &quot;actual-x&quot; and &quot;actual_y&quot; are looked for and for xi, the metadata keys &quot;sample_x&quot; and &quot;sample_y&quot; are</span>
<span class="sd">        used. These are set, for example, by the :py:class:`Stoner.HDF5.SXTMImage` loader if the interformeter stage</span>
<span class="sd">        data was found in the file.</span>

<span class="sd">        The metadata used in this case is then adjusted as well to ensure that repeated application of this method</span>
<span class="sd">        doesn&#39;t change the image after it has been corrected once.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">points</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">im</span><span class="p">[</span><span class="s2">&quot;actual_x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">im</span><span class="p">[</span><span class="s2">&quot;actual_y&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()))</span>
    <span class="k">if</span> <span class="n">xi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">xi</span> <span class="o">=</span> <span class="n">xi</span> <span class="o">=</span> <span class="p">(</span><span class="n">im</span><span class="p">[</span><span class="s2">&quot;sample_x&quot;</span><span class="p">],</span> <span class="n">im</span><span class="p">[</span><span class="s2">&quot;sample_y&quot;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">fill_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fill_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span>

    <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">fill_value</span><span class="p">):</span>
        <span class="n">fill_value</span> <span class="o">=</span> <span class="n">fill_value</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>

    <span class="n">im2</span> <span class="o">=</span> <span class="n">griddata</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">xi</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">fill_value</span><span class="p">,</span> <span class="n">rescale</span><span class="p">)</span>
    <span class="n">im2</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">im2</span><span class="p">)</span>
    <span class="n">im2</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">metadata</span>
    <span class="n">im2</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;actual_x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">im2</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;actual_y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">im2</span></div>


<div class="viewcode-block" id="hist"><a class="viewcode-back" href="../../../classes/Stoner.Image.imagefuncs.hist.html#Stoner.Image.imagefuncs.hist">[docs]</a><span class="k">def</span> <span class="nf">hist</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Pass through to :py:func:`matplotlib.pyplot.hist` function.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">):</span>
        <span class="n">im_data</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="o">~</span><span class="n">im</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">im_data</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">counts</span><span class="p">,</span> <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">im_data</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">)</span>
    <span class="n">centres</span> <span class="o">=</span> <span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">new</span> <span class="o">=</span> <span class="n">make_Data</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">centres</span><span class="p">,</span> <span class="n">counts</span><span class="p">)))</span>
    <span class="n">new</span><span class="o">.</span><span class="n">column_headers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Intensity&quot;</span><span class="p">,</span> <span class="s2">&quot;Frequency&quot;</span><span class="p">]</span>
    <span class="n">new</span><span class="o">.</span><span class="n">setas</span> <span class="o">=</span> <span class="s2">&quot;xy&quot;</span>
    <span class="k">return</span> <span class="n">new</span></div>


<div class="viewcode-block" id="imshow"><a class="viewcode-back" href="../../../classes/Stoner.Image.imagefuncs.imshow.html#Stoner.Image.imagefuncs.imshow">[docs]</a><span class="k">def</span> <span class="nf">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Quickly plot of image.</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">        figure (int, str or matplotlib.figure):</span>
<span class="sd">            if int then use figure number given, if figure is &#39;new&#39; then create a new figure, if None then use</span>
<span class="sd">            whatever default figure is available</span>
<span class="sd">        title (str,None,False):</span>
<span class="sd">            Title for plot - defaults to False (no title). None will take the title from the filename if present</span>
<span class="sd">        cmap (str,matplotlib.cmap):</span>
<span class="sd">            Colour scheme for plot, defaults to gray</span>

<span class="sd">    Any masked areas are set to NaN which stops them being plotted at all.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">figure</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;figure&quot;</span><span class="p">,</span> <span class="s2">&quot;new&quot;</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;ax&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="c1"># Get a title - from keyword argument, from title attr or filename attr</span>
    <span class="n">title</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;cmap&quot;</span><span class="p">,</span> <span class="s2">&quot;gray&quot;</span><span class="p">)</span>
    <span class="n">mask_alpha</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;mask_alpha&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">mask_col</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;mask_color&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cmap</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">cmap</span><span class="p">)</span>
    <span class="n">im_data</span> <span class="o">=</span> <span class="n">im</span>
    <span class="k">if</span> <span class="n">figure</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">figure</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figure</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">figure</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">figure</span> <span class="o">==</span> <span class="s2">&quot;new&quot;</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">figure</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># matplotlib.figure instance</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figure</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im_data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">is_masked</span><span class="p">(</span><span class="n">im</span><span class="p">):</span>
        <span class="n">mask_col</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">mask_col</span><span class="p">))</span>
        <span class="n">mask_col</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask_alpha</span>
        <span class="n">mask_cmap</span> <span class="o">=</span> <span class="n">ListedColormap</span><span class="p">([(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">mask_col</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;_mask_map&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">mask_cmap</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;filename&quot;</span> <span class="ow">in</span> <span class="n">im</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">im</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">])[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">filename</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">title</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_figure_to_clipboard</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;ctrl+c&quot;</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span> <span class="k">as</span> <span class="n">buffer</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
                <span class="n">QApplication</span><span class="o">.</span><span class="n">clipboard</span><span class="p">()</span><span class="o">.</span><span class="n">setImage</span><span class="p">(</span><span class="n">QImage</span><span class="o">.</span><span class="n">fromData</span><span class="p">(</span><span class="n">buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()))</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s2">&quot;key_press_event&quot;</span><span class="p">,</span> <span class="n">add_figure_to_clipboard</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="level_image"><a class="viewcode-back" href="../../../classes/Stoner.Image.imagefuncs.level_image.html#Stoner.Image.imagefuncs.level_image">[docs]</a><span class="k">def</span> <span class="nf">level_image</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">poly_vert</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">poly_horiz</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">poly</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;clip&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Subtract a polynomial background from image.</span>

<span class="sd">    Keword Arguments:</span>
<span class="sd">        poly_vert (int): fit a polynomial in the vertical direction for the image of order</span>
<span class="sd">            given. If 0 do not fit or subtract in the vertical direction</span>
<span class="sd">        poly_horiz (int): fit a polynomial of order poly_horiz to the image. If 0 given</span>
<span class="sd">            do not subtract</span>
<span class="sd">        box (array, list or tuple of int): [xmin,xmax,ymin,ymax] define region for fitting. IF None use entire</span>
<span class="sd">            image</span>
<span class="sd">        poly (list or None): [pvert, phoriz] pvert and phoriz are arrays of polynomial coefficients</span>
<span class="sd">            (highest power first) to subtract in the horizontal and vertical</span>
<span class="sd">            directions. If None function defaults to fitting its own polynomial.</span>
<span class="sd">        mode (str): Either &#39;clip&#39; or &#39;norm&#39; - specifies how to handle intensitry values that end up being outside</span>
<span class="sd">            of the accepted range for the image.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A new copy of the processed images.</span>

<span class="sd">    Fit and subtract a background to the image. Fits a polynomial of order</span>
<span class="sd">    given in the horizontal and vertical directions and subtracts. If box</span>
<span class="sd">    is defined then level the *entire* image according to the</span>
<span class="sd">    gradient within the box. The polynomial subtracted is added to the</span>
<span class="sd">    metadata as &#39;poly_vert_subtract&#39; and &#39;poly_horiz_subtract&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">box</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">max_box</span>
    <span class="n">cim</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="n">box</span><span class="o">=</span><span class="n">box</span><span class="p">)</span>
    <span class="p">(</span><span class="n">vertl</span><span class="p">,</span> <span class="n">horizl</span><span class="p">)</span> <span class="o">=</span> <span class="n">cim</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">p_horiz</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">p_vert</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">poly_horiz</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">comp_vert</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">cim</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># average (compress) the vertical values</span>
        <span class="k">if</span> <span class="n">poly</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">p_horiz</span> <span class="o">=</span> <span class="n">poly</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p_horiz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">horizl</span><span class="p">),</span> <span class="n">comp_vert</span><span class="p">,</span> <span class="n">poly_horiz</span><span class="p">)</span>  <span class="c1"># fit to the horizontal</span>
            <span class="n">av</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">comp_vert</span><span class="p">)</span>  <span class="c1"># get the average pixel height</span>
            <span class="n">p_horiz</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_horiz</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">av</span>  <span class="c1"># maintain the average image height</span>
        <span class="n">horizcoord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># now apply level to whole image</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p_horiz</span><span class="p">):</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">im</span> <span class="o">-</span> <span class="n">c</span> <span class="o">*</span> <span class="n">horizcoord</span> <span class="o">**</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p_horiz</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">poly_vert</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">comp_horiz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">cim</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># average the horizontal values</span>
        <span class="k">if</span> <span class="n">poly</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">p_vert</span> <span class="o">=</span> <span class="n">poly</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p_vert</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">vertl</span><span class="p">),</span> <span class="n">comp_horiz</span><span class="p">,</span> <span class="n">poly_vert</span><span class="p">)</span>
            <span class="n">av</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">comp_horiz</span><span class="p">)</span>
            <span class="n">p_vert</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_vert</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">av</span>  <span class="c1"># maintain the average image height</span>
        <span class="n">vertcoord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p_vert</span><span class="p">):</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">im</span> <span class="o">-</span> <span class="n">c</span> <span class="o">*</span> <span class="n">vertcoord</span> <span class="o">**</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p_vert</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">im</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;poly_sub&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_horiz</span><span class="p">,</span> <span class="n">p_vert</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;clip&quot;</span><span class="p">:</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">clip_intensity</span><span class="p">()</span>  <span class="c1"># saturate any pixels outside allowed range</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;norm&quot;</span><span class="p">:</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">normalise</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">im</span></div>


<div class="viewcode-block" id="normalise"><a class="viewcode-back" href="../../../classes/Stoner.Image.imagefuncs.normalise.html#Stoner.Image.imagefuncs.normalise">[docs]</a><span class="k">def</span> <span class="nf">normalise</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;Norm alise the data to a fixed scale.</span>

<span class="sd">    Keyword Arguements:</span>
<span class="sd">        scale (2-tuple): The range to scale the image to, defaults to -1 to 1.</span>
<span class="sd">        saple (box): Only use a section of the input image to calculate the new scale over.</span>
<span class="sd">        limits (low,high): Take the input range from the *high* and *low* fraction of the input when sorted.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A scaled version of the data. The ndarray min and max methods are used to allow masked images</span>
<span class="sd">        to be operated on only on the unmasked areas.</span>

<span class="sd">    Notes:</span>
<span class="sd">        The *sample* keyword controls the area in which the range of input values is calculated, the actual scaling is</span>
<span class="sd">        done on the whole image.</span>

<span class="sd">        The *limits* parameter is used to set the input scale being normalised from - if an image has a few outliers</span>
<span class="sd">        then this setting can be used to clip the input range before normalising. The parameters in the limit are the</span>
<span class="sd">        values at the *low* and *high* fractions of the cumulative distribution functions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">mask</span>
    <span class="bp">cls</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="vm">__class__</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">section</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">im</span><span class="o">.</span><span class="n">_box</span><span class="p">(</span><span class="n">sample</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">section</span> <span class="o">=</span> <span class="n">im</span>
    <span class="k">if</span> <span class="n">limits</span> <span class="o">!=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">):</span>
        <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="n">limits</span>
        <span class="n">low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">section</span><span class="o">.</span><span class="n">ravel</span><span class="p">())[</span><span class="nb">int</span><span class="p">(</span><span class="n">low</span> <span class="o">*</span> <span class="n">section</span><span class="o">.</span><span class="n">size</span><span class="p">)]</span>
        <span class="n">high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">section</span><span class="o">.</span><span class="n">ravel</span><span class="p">())[</span><span class="nb">int</span><span class="p">(</span><span class="n">high</span> <span class="o">*</span> <span class="n">section</span><span class="o">.</span><span class="n">size</span><span class="p">)]</span>
        <span class="n">im</span><span class="o">.</span><span class="n">clip_intensity</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">high</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">low</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">isTuple</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;scale should be a 2-tuple of floats.&quot;</span><span class="p">)</span>
    <span class="n">scaled</span> <span class="o">=</span> <span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">data</span> <span class="o">-</span> <span class="n">low</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">low</span><span class="p">)</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">scaled</span> <span class="o">*</span> <span class="n">delta</span> <span class="o">+</span> <span class="n">offset</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
    <span class="n">im</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span>
    <span class="k">return</span> <span class="n">im</span></div>


<span class="k">def</span> <span class="nf">clip_neg</span><span class="p">(</span><span class="n">im</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Clip negative pixels to 0.</span>

<span class="sd">    Most useful for float where pixels above 1 are reduced to 1.0 and -ve pixels</span>
<span class="sd">    are changed to 0.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">im</span><span class="p">[</span><span class="n">im</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">im</span>


<div class="viewcode-block" id="profile_line"><a class="viewcode-back" href="../../../classes/Stoner.Image.imagefuncs.profile_line.html#Stoner.Image.imagefuncs.profile_line">[docs]</a><span class="k">def</span> <span class="nf">profile_line</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span> <span class="n">cval</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">constrain</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wrap sckit-image method of the same name to get a line_profile.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        img(ImageArray):</span>
<span class="sd">            Image data to take line section of</span>

<span class="sd">    Keyword Parameters:</span>
<span class="sd">        src, dst (2-tuple of int or float):</span>
<span class="sd">            start and end of line profile. If the co-ordinates</span>
<span class="sd">            are given as intergers then they are assumed to be pxiel co-ordinates, floats are</span>
<span class="sd">            assumed to be real-space co-ordinates using the embedded metadata.</span>
<span class="sd">        linewidth (int):</span>
<span class="sd">            the wideth of the profile to be taken.</span>
<span class="sd">        order (int 1-3):</span>
<span class="sd">            Order of interpolation used to find image data when not aligned to a point</span>
<span class="sd">        mode (str):</span>
<span class="sd">            How to handle data outside of the image.</span>
<span class="sd">        cval (float):</span>
<span class="sd">            The constant value to assume for data outside of the image is mode is &quot;constant&quot;</span>
<span class="sd">        constrain (bool):</span>
<span class="sd">            Ensure the src and dst are within the image (default True).</span>
<span class="sd">        no_scale (bool):</span>
<span class="sd">            Do not attempt to scale values by the image scale and work in pixels throughout. (default False)</span>


<span class="sd">    Returns:</span>
<span class="sd">        A :py:class:`Stoner.Data` object containing the line profile data and the metadata from the image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">kargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;no_scale&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="n">img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;MicronsPerPixel&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="n">r</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">fast_mode</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">src</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dst</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;x&quot;</span> <span class="ow">in</span> <span class="n">kargs</span><span class="p">:</span>
            <span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">kargs</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">])</span>
            <span class="n">dst</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">kargs</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">])</span>
            <span class="n">fast_mode</span> <span class="o">=</span> <span class="n">kargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;no_scale&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;y&quot;</span> <span class="ow">in</span> <span class="n">kargs</span><span class="p">:</span>
            <span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="n">kargs</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">dst</span> <span class="o">=</span> <span class="p">(</span><span class="n">kargs</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">],</span> <span class="n">c</span><span class="p">)</span>
            <span class="n">fast_mode</span> <span class="o">=</span> <span class="n">kargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;no_scale&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
    <span class="n">dst</span> <span class="o">=</span> <span class="n">_scale</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">_scale</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">isTuple</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;src co-ordinates are not a 2-tuple of ints.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">isTuple</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;dst co-ordinates are not a 2-tuple of ints.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">constrain</span><span class="p">:</span>
        <span class="n">fix</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">mx</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">mx</span><span class="p">])[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">src</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="n">fix</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r</span><span class="p">),</span> <span class="n">fix</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="p">))</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="p">(</span><span class="n">fix</span><span class="p">(</span><span class="n">dst</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r</span><span class="p">),</span> <span class="n">fix</span><span class="p">(</span><span class="n">dst</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">fast_mode</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;x&quot;</span> <span class="ow">in</span> <span class="n">kargs</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">img</span><span class="p">[:,</span> <span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">row_stack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:]</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">row_stack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">profile_line</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">linewidth</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">cval</span><span class="p">)</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">_line_profile_coordinates</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">linewidth</span><span class="p">)[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">make_Data</span><span class="p">()</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">T</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">setas</span> <span class="o">=</span> <span class="s2">&quot;xy&quot;</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">points</span>
    <span class="n">x</span> <span class="o">-=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">-=</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ret</span> <span class="o">&amp;=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">y</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span>
    <span class="n">ret</span> <span class="o">&amp;=</span> <span class="n">result</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">column_headers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;Distance&quot;</span><span class="p">,</span> <span class="s2">&quot;Intensity&quot;</span><span class="p">]</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">setas</span> <span class="o">=</span> <span class="s2">&quot;..xy&quot;</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="radial_coordinates"><a class="viewcode-back" href="../../../classes/Stoner.Image.imagefuncs.radial_coordinates.html#Stoner.Image.imagefuncs.radial_coordinates">[docs]</a><span class="k">def</span> <span class="nf">radial_coordinates</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">centre</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">pixel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">angle</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Rerurn a map of the radial co-ordinates of an image from a given centre, with adjustments for pixel size.</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">        centre (2-tuple):</span>
<span class="sd">            Co-ordinates of centre point in terms of the orginal pixels. Defaults to(None,None) for the middle of the</span>
<span class="sd">            image.</span>
<span class="sd">        pixel_size (2-tuple):</span>
<span class="sd">            The size of one pixel in (dx by dy) - defaults to 1,1</span>
<span class="sd">        angle (bool, None):</span>
<span class="sd">            Whether to return the angles (in radians, True), distances (False) o a complex number (None).</span>

<span class="sd">    Returns:</span>
<span class="sd">        An array of the same class as the input, but with values corresponding to the radial co-ordinates.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span> <span class="o">=</span> <span class="n">centre</span>
    <span class="n">r</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">pixel_size</span>
    <span class="n">cx</span> <span class="o">=</span> <span class="n">c</span> <span class="o">/</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">cx</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">cx</span>
    <span class="n">cy</span> <span class="o">=</span> <span class="n">r</span> <span class="o">/</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">cy</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">cy</span>
    <span class="n">x_r</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="o">-</span> <span class="n">cx</span><span class="p">)</span>
    <span class="n">y_r</span> <span class="o">=</span> <span class="n">dy</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">r</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="o">-</span> <span class="n">cy</span><span class="p">)</span>
    <span class="n">Y</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">y_r</span><span class="p">,</span> <span class="n">x_r</span><span class="p">)</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="o">-</span><span class="n">Y</span> <span class="o">+</span> <span class="p">(</span><span class="mi">0</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="n">X</span>
    <span class="k">if</span> <span class="n">angle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">angle</span><span class="p">:</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
    <span class="n">Z</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">metadata</span>
    <span class="k">return</span> <span class="n">Z</span></div>


<div class="viewcode-block" id="radial_profile"><a class="viewcode-back" href="../../../classes/Stoner.Image.imagefuncs.radial_profile.html#Stoner.Image.imagefuncs.radial_profile">[docs]</a><span class="k">def</span> <span class="nf">radial_profile</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">centre</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">pixel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;Extract a radial  profile line from an image.</span>

<span class="sd">    Keyword Paramaters:</span>
<span class="sd">        angle (float, tuple, None):</span>
<span class="sd">            Select the radial angle to include:</span>
<span class="sd">                - float selects a single angle</span>
<span class="sd">                - tuple selects a range of angles</span>
<span class="sd">                - None integrates over all angles</span>
<span class="sd">        r (array, None):</span>
<span class="sd">            Edges of the bins in the radual direction - will return r.size-1 points. Default is None which uses the</span>
<span class="sd">            minimum r value found on the edges of the image.</span>
<span class="sd">        centre (2-tuple):</span>
<span class="sd">            Co-ordinates of centre point in terms of the orginal pixels. Defaults to(None,None) for the middle of the</span>
<span class="sd">            image.</span>
<span class="sd">        pixel_size (2-tuple):</span>
<span class="sd">            The size of one pixel in (dx by dy) - defaults to 1,1</span>

<span class="sd">    Retunrs:</span>
<span class="sd">        (Data):</span>
<span class="sd">            A py:class:`Stoner.Data` object with a column for r and columns for mean, std, and number of pixels.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">radial_coordinates</span><span class="p">(</span><span class="n">centre</span><span class="o">=</span><span class="n">centre</span><span class="p">,</span> <span class="n">pixel_size</span><span class="o">=</span><span class="n">pixel_size</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Identify the minimum edge value</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coords</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">coords</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">r_limit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">r_limit</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">r_limit</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">r_l</span> <span class="o">=</span> <span class="n">r</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">r_h</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">r_m</span> <span class="o">=</span> <span class="p">(</span><span class="n">r_l</span> <span class="o">+</span> <span class="n">r_h</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="n">angle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">angle_select</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="n">angle_low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">angle_high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">angle_select</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">angle_low</span><span class="p">,</span> <span class="n">angle_high</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="n">angle_select</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">coords</span><span class="p">),</span> <span class="n">angle</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;angle should be a float, tuple of two floats or None not a </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">make_Data</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">mid</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">r_l</span><span class="p">,</span> <span class="n">r_h</span><span class="p">,</span> <span class="n">r_m</span><span class="p">):</span>
        <span class="n">r_select</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">low</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">high</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">r_select</span><span class="p">,</span> <span class="n">angle_select</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">avg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">avg</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">std</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span>
        <span class="n">ret</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">low</span><span class="p">,</span> <span class="n">mid</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">avg</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">num</span><span class="p">])</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">column_headers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Low_r&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;high_r&quot;</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;std&quot;</span><span class="p">,</span> <span class="s2">&quot;number&quot;</span><span class="p">]</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">setas</span> <span class="o">=</span> <span class="s2">&quot;.x.ye.&quot;</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">metadata</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">filename</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_profile.txt&quot;</span>
    <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="quantize"><a class="viewcode-back" href="../../../classes/Stoner.Image.imagefuncs.quantize.html#Stoner.Image.imagefuncs.quantize">[docs]</a><span class="k">def</span> <span class="nf">quantize</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Quantise the image data into fixed levels given by a mapping.</span>

<span class="sd">    Args:</span>
<span class="sd">        output (list,array,tuple): Output levels to return.</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">        levels (list, array or None): The input band markers. If None is constructed from the data.</span>

<span class="sd">    The number of levels should be one less than the number of output levels given.</span>

<span class="sd">    Notes:</span>
<span class="sd">        The routine will ignore all masked pixels and will preserve the mask.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">section</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="o">~</span><span class="n">im</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">mask</span>
    <span class="n">lmin</span><span class="p">,</span> <span class="n">lmax</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">section</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>  <span class="c1"># Dudge to ensure that the bottom and top elements are included.</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">lmax</span> <span class="o">-</span> <span class="n">lmin</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>

    <span class="k">if</span> <span class="n">levels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lmin</span> <span class="o">-</span> <span class="n">delta</span><span class="p">,</span> <span class="n">lmax</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">levels</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">levels</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">lvl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">lvl</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">levels</span>
        <span class="n">lvl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">delta</span>
        <span class="n">lvl</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">delta</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="n">lvl</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> output levels and </span><span class="si">{}</span><span class="s2"> input levels&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">levels</span><span class="p">)))</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">clone</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">lvl</span><span class="p">,</span> <span class="n">lvh</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">levels</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">levels</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">output</span><span class="p">):</span>
        <span class="n">select</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">less_equal</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">lvh</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">lvl</span><span class="p">))</span>
        <span class="n">ret</span><span class="p">[</span><span class="n">select</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
    <span class="n">ret</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)[</span><span class="n">mask</span><span class="p">]</span>  <span class="c1"># Put back the original image values where they are masked.</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span>  <span class="c1"># restore mask</span>
    <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="remove_outliers"><a class="viewcode-back" href="../../../classes/Stoner.Image.imagefuncs.remove_outliers.html#Stoner.Image.imagefuncs.remove_outliers">[docs]</a><span class="k">def</span> <span class="nf">remove_outliers</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">percentiles</span><span class="o">=</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find values of the data that are beyond a percentile of the overall distribution and replace them.</span>

<span class="sd">    Keyword Parameters:</span>
<span class="sd">        percentile (2 tuple):</span>
<span class="sd">            Fraction percentiles to consider to be outliers (default is (0.01,0.99) for 1% limits)</span>
<span class="sd">        replace (2 tuple or None):</span>
<span class="sd">            Values to set outliers to. If None, then the pixel values at the percentile limits are used.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (ndarray):</span>
<span class="sd">            Tje modified array.</span>

<span class="sd">    Use this method if you have an image with a small number of pixels with extreme values that are</span>
<span class="sd">    out of range.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>

    <span class="n">cdf</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">cumulative_distribution</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">count</span><span class="p">()))</span>
    <span class="n">cdf</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">cdf</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span>
    <span class="n">limits</span> <span class="o">=</span> <span class="p">[</span><span class="n">cdf</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">percentiles</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">replace</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">replace</span> <span class="o">=</span> <span class="n">limits</span>
    <span class="n">im</span><span class="p">[</span><span class="n">im</span> <span class="o">&lt;</span> <span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">replace</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">im</span><span class="p">[</span><span class="n">im</span> <span class="o">&gt;</span> <span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">replace</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">im</span></div>


<div class="viewcode-block" id="rotate"><a class="viewcode-back" href="../../../classes/Stoner.Image.imagefuncs.rotate.html#Stoner.Image.imagefuncs.rotate">[docs]</a><span class="k">def</span> <span class="nf">rotate</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">resize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span> <span class="n">cval</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">preserve_range</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Rotate image by a certain angle around its center.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        angle  (float):</span>
<span class="sd">            Rotation angle in **radians** in clockwise direction.</span>

<span class="sd">    Keyword Parameters:</span>
<span class="sd">        resize (bool):</span>
<span class="sd">            Determine whether the shape of the output image will be automatically</span>
<span class="sd">            calculated, so the complete rotated image exactly fits. Default is</span>
<span class="sd">            False.</span>
<span class="sd">        center (iterable of length 2):</span>
<span class="sd">            The rotation center. If ``center=None``, the image is rotated around</span>
<span class="sd">            its center, i.e. ``center=(cols / 2 - 0.5, rows / 2 - 0.5)``.  Please</span>
<span class="sd">            note that this parameter is (cols, rows), contrary to normal skimage</span>
<span class="sd">            ordering.</span>
<span class="sd">        order (int):</span>
<span class="sd">            The order of the spline interpolation, default is 1. The order has to</span>
<span class="sd">            be in the range 0-5. See `skimage.transform.warp` for detail.</span>
<span class="sd">        mode ({&#39;constant&#39;, &#39;edge&#39;, &#39;symmetric&#39;, &#39;reflect&#39;, &#39;wrap&#39;}):</span>
<span class="sd">            Points outside the boundaries of the input are filled according</span>
<span class="sd">            to the given mode.  Modes match the behaviour of `numpy.pad`.</span>
<span class="sd">        cval  (float):</span>
<span class="sd">            Used in conjunction with mode &#39;constant&#39;, the value outside</span>
<span class="sd">            the image boundaries.</span>
<span class="sd">        clip (bool):</span>
<span class="sd">            Whether to clip the output to the range of values of the input image.</span>
<span class="sd">            This is enabled by default, since higher order interpolation may</span>
<span class="sd">            produce values outside the given input range.</span>
<span class="sd">        preserve_range (bool):</span>
<span class="sd">            Whether to keep the original range of values. Otherwise, the input</span>
<span class="sd">            image is converted according to the conventions of `Stpomer.Image.ImageArray.as_float`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (ImageFile/ImageArray):</span>
<span class="sd">            Rotated image</span>

<span class="sd">    Notes:</span>
<span class="sd">        (pass through to the skimage.transform.warps.rotate function)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="o">-</span><span class="n">angle</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span>
        <span class="n">im</span><span class="p">,</span>
        <span class="n">ang</span><span class="p">,</span>
        <span class="n">resize</span><span class="o">=</span><span class="n">resize</span><span class="p">,</span>
        <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">,</span>
        <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
        <span class="n">cval</span><span class="o">=</span><span class="n">cval</span><span class="p">,</span>
        <span class="n">clip</span><span class="o">=</span><span class="n">clip</span><span class="p">,</span>
        <span class="n">preserve_range</span><span class="o">=</span><span class="n">preserve_range</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">im</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">im</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">metadata</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;transform:rotation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">angle</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">ret</span></div>


<span class="k">def</span> <span class="nf">sgolay2d</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">points</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">poly</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">derivative</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Implements a 2D Savitsky Golay Filter for a 2D array (e.g. image).</span>

<span class="sd">    Arguments:</span>
<span class="sd">        img (ImageArray or ImageFile):</span>
<span class="sd">            image to be filtered</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">        points (int):</span>
<span class="sd">            The number of points in the window aperture. Must be an odd number. (default 15)</span>
<span class="sd">        poly (int):</span>
<span class="sd">            Degree of polynomial to use in the filter. (defatult 1)</span>
<span class="sd">        derivative (str or None):</span>
<span class="sd">            Type of defivative to calculate. Can be:</span>
<span class="sd">                None - smooth only (default)</span>
<span class="sd">                &quot;x&quot;,&quot;y&quot; - calculate dIntentity/dx or dIntensity/dy</span>
<span class="sd">                &quot;both&quot; - calculate the full derivative and return magnitud and angle.</span>

<span class="sd">    ReturnsL</span>
<span class="sd">        (imageArray or ImageFile):</span>
<span class="sd">            filtered image.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError if points, order or derivative are incorrect.</span>

<span class="sd">    Notes:</span>
<span class="sd">        Adapted from code on the scipy cookbook : https://scipy-cookbook.readthedocs.io/items/SavitzkyGolay.html</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># number of terms in the polynomial expression</span>
    <span class="n">n_terms</span> <span class="o">=</span> <span class="p">(</span><span class="n">poly</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">poly</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>

    <span class="k">if</span> <span class="n">points</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;window_size must be odd&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">points</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="n">n_terms</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;order is too high for the window size&quot;</span><span class="p">)</span>

    <span class="n">half_size</span> <span class="o">=</span> <span class="n">points</span> <span class="o">//</span> <span class="mi">2</span>

    <span class="c1"># exponents of the polynomial.</span>
    <span class="c1"># p(x,y) = a0 + a1*x + a2*y + a3*x^2 + a4*y^2 + a5*x*y + ...</span>
    <span class="c1"># this line gives a list of two item tuple. Each tuple contains</span>
    <span class="c1"># the exponents of the k-th term. First element of tuple is for x</span>
    <span class="c1"># second element for y.</span>
    <span class="c1"># Ex. exps = [(0,0), (1,0), (0,1), (2,0), (1,1), (0,2), ...]</span>
    <span class="n">exps</span> <span class="o">=</span> <span class="p">[(</span><span class="n">k</span> <span class="o">-</span> <span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">poly</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>

    <span class="c1"># coordinates of points</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">half_size</span><span class="p">,</span> <span class="n">half_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">points</span><span class="p">)</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="p">[</span><span class="n">points</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">points</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,)</span>

    <span class="c1"># build matrix of system of equation</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">points</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">exps</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">exp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">exps</span><span class="p">):</span>
        <span class="n">A</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dx</span> <span class="o">**</span> <span class="n">exp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">dy</span> <span class="o">**</span> <span class="n">exp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># pad input array with appropriate values at the four borders</span>
    <span class="n">new_shape</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">half_size</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">half_size</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">new_shape</span><span class="p">))</span>
    <span class="c1"># top band</span>
    <span class="n">band</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">Z</span><span class="p">[:</span><span class="n">half_size</span><span class="p">,</span> <span class="n">half_size</span><span class="p">:</span><span class="o">-</span><span class="n">half_size</span><span class="p">]</span> <span class="o">=</span> <span class="n">band</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">half_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:])</span> <span class="o">-</span> <span class="n">band</span><span class="p">)</span>
    <span class="c1"># bottom band</span>
    <span class="n">band</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">Z</span><span class="p">[</span><span class="o">-</span><span class="n">half_size</span><span class="p">:,</span> <span class="n">half_size</span><span class="p">:</span><span class="o">-</span><span class="n">half_size</span><span class="p">]</span> <span class="o">=</span> <span class="n">band</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="o">-</span><span class="n">half_size</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span> <span class="o">-</span> <span class="n">band</span><span class="p">)</span>
    <span class="c1"># left band</span>
    <span class="n">band</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">img</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">half_size</span><span class="p">])</span>
    <span class="n">Z</span><span class="p">[</span><span class="n">half_size</span><span class="p">:</span><span class="o">-</span><span class="n">half_size</span><span class="p">,</span> <span class="p">:</span><span class="n">half_size</span><span class="p">]</span> <span class="o">=</span> <span class="n">band</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span><span class="n">img</span><span class="p">[:,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">half_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">band</span><span class="p">)</span>
    <span class="c1"># right band</span>
    <span class="n">band</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">img</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">half_size</span><span class="p">])</span>
    <span class="n">Z</span><span class="p">[</span><span class="n">half_size</span><span class="p">:</span><span class="o">-</span><span class="n">half_size</span><span class="p">,</span> <span class="o">-</span><span class="n">half_size</span><span class="p">:]</span> <span class="o">=</span> <span class="n">band</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span><span class="n">img</span><span class="p">[:,</span> <span class="o">-</span><span class="n">half_size</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">band</span><span class="p">)</span>
    <span class="c1"># central band</span>
    <span class="n">Z</span><span class="p">[</span><span class="n">half_size</span><span class="p">:</span><span class="o">-</span><span class="n">half_size</span><span class="p">,</span> <span class="n">half_size</span><span class="p">:</span><span class="o">-</span><span class="n">half_size</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span>

    <span class="c1"># top left corner</span>
    <span class="n">band</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">Z</span><span class="p">[:</span><span class="n">half_size</span><span class="p">,</span> <span class="p">:</span><span class="n">half_size</span><span class="p">]</span> <span class="o">=</span> <span class="n">band</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">half_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">half_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span> <span class="o">-</span> <span class="n">band</span><span class="p">)</span>
    <span class="c1"># bottom right corner</span>
    <span class="n">band</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Z</span><span class="p">[</span><span class="o">-</span><span class="n">half_size</span><span class="p">:,</span> <span class="o">-</span><span class="n">half_size</span><span class="p">:]</span> <span class="o">=</span> <span class="n">band</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="o">-</span><span class="n">half_size</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">half_size</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">]))</span> <span class="o">-</span> <span class="n">band</span>
    <span class="p">)</span>

    <span class="c1"># top right corner</span>
    <span class="n">band</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">half_size</span><span class="p">,</span> <span class="o">-</span><span class="n">half_size</span><span class="p">:]</span>
    <span class="n">Z</span><span class="p">[:</span><span class="n">half_size</span><span class="p">,</span> <span class="o">-</span><span class="n">half_size</span><span class="p">:]</span> <span class="o">=</span> <span class="n">band</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">Z</span><span class="p">[</span><span class="n">half_size</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">half_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">half_size</span><span class="p">:])</span> <span class="o">-</span> <span class="n">band</span><span class="p">)</span>
    <span class="c1"># bottom left corner</span>
    <span class="n">band</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="o">-</span><span class="n">half_size</span><span class="p">:,</span> <span class="n">half_size</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">Z</span><span class="p">[</span><span class="o">-</span><span class="n">half_size</span><span class="p">:,</span> <span class="p">:</span><span class="n">half_size</span><span class="p">]</span> <span class="o">=</span> <span class="n">band</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span><span class="n">Z</span><span class="p">[</span><span class="o">-</span><span class="n">half_size</span><span class="p">:,</span> <span class="n">half_size</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">half_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">band</span><span class="p">)</span>

    <span class="c1"># solve system and convolve</span>
    <span class="k">if</span> <span class="n">derivative</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">A</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">points</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">derivative</span> <span class="o">==</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">A</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">points</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="o">-</span><span class="n">c</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">derivative</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">A</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">points</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="o">-</span><span class="n">r</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">derivative</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">A</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">points</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">A</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">points</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="o">-</span><span class="n">r</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">),</span> <span class="n">signal</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="o">-</span><span class="n">c</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown derivative mode </span><span class="si">{</span><span class="n">derivative</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span>


<span class="k">def</span> <span class="nf">span</span><span class="p">(</span><span class="n">im</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the minimum and maximum values in the image.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">im</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>


<div class="viewcode-block" id="translate"><a class="viewcode-back" href="../../../classes/Stoner.Image.imagefuncs.translate.html#Stoner.Image.imagefuncs.translate">[docs]</a><span class="k">def</span> <span class="nf">translate</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">translation</span><span class="p">,</span> <span class="n">add_metadata</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;wrap&quot;</span><span class="p">,</span> <span class="n">cval</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Translate the image.</span>

<span class="sd">    Areas lost by move are cropped, and areas gained are made black (0)</span>
<span class="sd">    The area not lost or cropped is added as a metadata parameter</span>
<span class="sd">    &#39;translation_limits&#39;</span>

<span class="sd">    Args:</span>
<span class="sd">        translate (2-tuple):</span>
<span class="sd">            translation (x,y)</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">        add_metadata (bool):</span>
<span class="sd">            Record the shift in the image metadata order (int): Interpolation order (default, 3, bi-cubic)</span>
<span class="sd">        mode (str):</span>
<span class="sd">            How to handle points outside the original image. See :py:func:`skimage.transform.warp`.  Defaults to &quot;wrap&quot;</span>
<span class="sd">        cval (float):</span>
<span class="sd">            The value to fill with if *mode* is constant. If not speficied or None, defaults to the mean pixcel value.</span>

<span class="sd">    Returns:</span>
<span class="sd">        im (ImageArray): translated image</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">translation</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">translation</span><span class="p">]</span>
    <span class="n">trans</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">SimilarityTransform</span><span class="p">(</span><span class="n">translation</span><span class="o">=</span><span class="n">translation</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cval</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">warp</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">cval</span><span class="o">=</span><span class="n">cval</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">add_metadata</span><span class="p">:</span>
        <span class="n">im</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;translation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">translation</span>
        <span class="n">im</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;translation_limits&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">translate_limits</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">translation</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">im</span></div>


<div class="viewcode-block" id="translate_limits"><a class="viewcode-back" href="../../../classes/Stoner.Image.imagefuncs.translate_limits.html#Stoner.Image.imagefuncs.translate_limits">[docs]</a><span class="k">def</span> <span class="nf">translate_limits</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">translation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find the limits of an image after a translation.</span>

<span class="sd">    After using ImageArray.translate some areas will be black,</span>
<span class="sd">    this finds the max area that still has original pixels in</span>

<span class="sd">    Args:</span>
<span class="sd">        translation: 2-tuple</span>
<span class="sd">            the (x,y) translation applied to the image</span>

<span class="sd">    Returns:</span>
<span class="sd">        limits: 4-tuple</span>
<span class="sd">            (xmin,xmax,ymin,ymax) the maximum coordinates of the image with original</span>
<span class="sd">            information</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">translation</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
        <span class="n">translation</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">translation</span><span class="p">]</span>

    <span class="n">shape</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">xmin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">translation</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">xmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">translation</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ymin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">translation</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ymax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">translation</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">)</span></div>


<div class="viewcode-block" id="plot_histogram"><a class="viewcode-back" href="../../../classes/Stoner.Image.imagefuncs.plot_histogram.html#Stoner.Image.imagefuncs.plot_histogram">[docs]</a><span class="k">def</span> <span class="nf">plot_histogram</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot the histogram and cumulative distribution for the image.&quot;&quot;&quot;</span>
    <span class="n">hist</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span>
    <span class="n">cum</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">cumulative_distribution</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
    <span class="n">cum</span> <span class="o">=</span> <span class="n">cum</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cum</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span> <span class="n">hist</span><span class="p">,</span> <span class="s2">&quot;k-&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span> <span class="n">cum</span><span class="p">,</span> <span class="s2">&quot;r-&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="threshold_minmax"><a class="viewcode-back" href="../../../classes/Stoner.Image.imagefuncs.threshold_minmax.html#Stoner.Image.imagefuncs.threshold_minmax">[docs]</a><span class="k">def</span> <span class="nf">threshold_minmax</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">threshmin</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">threshmax</span><span class="o">=</span><span class="mf">0.9</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a boolean array which is thresholded between threshmin and  threshmax.</span>

<span class="sd">    (ie True if value is between threshmin and threshmax)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">im</span> <span class="o">&gt;</span> <span class="n">threshmin</span><span class="p">,</span> <span class="n">im</span> <span class="o">&lt;</span> <span class="n">threshmax</span><span class="p">)</span></div>


<div class="viewcode-block" id="denoise"><a class="viewcode-back" href="../../../classes/Stoner.Image.imagefuncs.denoise.html#Stoner.Image.imagefuncs.denoise">[docs]</a><span class="k">def</span> <span class="nf">denoise</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Rename the skimage restore function.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">im</span><span class="o">.</span><span class="n">denoise_tv_chambolle</span><span class="p">(</span><span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">)</span></div>


<div class="viewcode-block" id="do_nothing"><a class="viewcode-back" href="../../../classes/Stoner.Image.imagefuncs.do_nothing.html#Stoner.Image.imagefuncs.do_nothing">[docs]</a><span class="k">def</span> <span class="nf">do_nothing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Nulop function for testing the integration into ImageArray.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/StonerLogo2.png" alt="Logo"/>
            </a></p>
<form class="search" action="../../../search.html" method="get">
  <input type="text" name="q"
   placeholder="type to search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <div class="related bottom">
  <nav id="rellinks">
    <ul>
    </ul>
  </nav>
  <nav id="breadcrumbs">
    <ul>
      <li><a href="../../../index.html">Stoner Package</a></li>
      <li>
        <a href="../../index.html">Module code</a>
      </li> 
    </ul>
  </nav>
  </div>
  <footer id="pagefooter">&copy; 2013-15, Gavin Burnell et al.Last updated on Dec 21, 2020.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a>
      3.2.1
        with the <a href="http://github.com/irskep/sphinx-better-theme">
          better</a> theme.

  </footer>

  
  </body>
</html>