
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Stoner.Core &#8212; Stoner Pacakge API Documentation</title>
    <link rel="stylesheet" href="../../_static/better.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  </head><body>
    <header id="pageheader"><h1><a href="../../index.html ">
        Stoner Pacakge API Documentation
    </a></h1></header>
  <div class="related top">
  <nav id="rellinks">
    <ul>
    </ul>
  </nav>
  <nav id="breadcrumbs">
    <ul>
      <li><a href="../../index.html">Stoner Package</a></li>
      <li>
        <a href="../index.html">Module code</a>
      </li> 
    </ul>
  </nav>
  </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for Stoner.Core</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Stoner.Core provides the core classes for the Stoner package.&quot;&quot;&quot;</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;StonerLoadError&quot;</span><span class="p">,</span>
    <span class="s2">&quot;StonerSetasError&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_setas&quot;</span><span class="p">,</span>
    <span class="s2">&quot;regexpDict&quot;</span><span class="p">,</span>
    <span class="s2">&quot;typeHintedDict&quot;</span><span class="p">,</span>
    <span class="s2">&quot;metadataObject&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DataArray&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DataFile&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="kn">import</span> <span class="nn">re</span>

<span class="c1"># import pdb # for debugging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">MutableSequence</span>
<span class="kn">import</span> <span class="nn">os.path</span> <span class="k">as</span> <span class="nn">path</span>
<span class="kn">import</span> <span class="nn">inspect</span> <span class="k">as</span> <span class="nn">_inspect_</span>
<span class="kn">from</span> <span class="nn">textwrap</span> <span class="kn">import</span> <span class="n">TextWrapper</span>
<span class="kn">from</span> <span class="nn">traceback</span> <span class="kn">import</span> <span class="n">format_exc</span>
<span class="kn">import</span> <span class="nn">csv</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">NaN</span>  <span class="c1"># NOQA pylint: disable=unused-import</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">ma</span>

<span class="kn">from</span> <span class="nn">.compat</span> <span class="kn">import</span> <span class="n">string_types</span><span class="p">,</span> <span class="n">int_types</span><span class="p">,</span> <span class="n">index_types</span><span class="p">,</span> <span class="n">get_filedialog</span><span class="p">,</span> <span class="n">str2bytes</span><span class="p">,</span> <span class="n">_pattern_type</span>
<span class="kn">from</span> <span class="nn">.tools</span> <span class="kn">import</span> <span class="n">all_type</span><span class="p">,</span> <span class="n">isIterable</span><span class="p">,</span> <span class="n">isLikeList</span><span class="p">,</span> <span class="n">get_option</span>

<span class="kn">from</span> <span class="nn">.core.exceptions</span> <span class="kn">import</span> <span class="n">StonerLoadError</span><span class="p">,</span> <span class="n">StonerSetasError</span><span class="p">,</span> <span class="n">StonerUnrecognisedFormat</span>
<span class="kn">from</span> <span class="nn">.core</span> <span class="kn">import</span> <span class="n">_setas</span><span class="p">,</span> <span class="n">regexpDict</span><span class="p">,</span> <span class="n">typeHintedDict</span><span class="p">,</span> <span class="n">metadataObject</span>
<span class="kn">from</span> <span class="nn">.core.array</span> <span class="kn">import</span> <span class="n">DataArray</span>
<span class="kn">from</span> <span class="nn">.core.operators</span> <span class="kn">import</span> <span class="n">DataFileOperatorsMixin</span>
<span class="kn">from</span> <span class="nn">.core.property</span> <span class="kn">import</span> <span class="n">DataFilePropertyMixin</span>
<span class="kn">from</span> <span class="nn">.core.interfaces</span> <span class="kn">import</span> <span class="n">DataFileInterfacesMixin</span>
<span class="kn">from</span> <span class="nn">.core.methods</span> <span class="kn">import</span> <span class="n">DataFileSearchMixin</span>
<span class="kn">from</span> <span class="nn">.core.utils</span> <span class="kn">import</span> <span class="n">copy_into</span><span class="p">,</span> <span class="n">tab_delimited</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>

    <span class="n">tabulate</span><span class="o">.</span><span class="n">PRESERVE_WHITESPACE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">tabulate</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">magic</span> <span class="kn">import</span> <span class="n">Magic</span> <span class="k">as</span> <span class="n">filemagic</span><span class="p">,</span> <span class="n">MAGIC_MIME_TYPE</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">filemagic</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">pd</span> <span class="o">=</span> <span class="kc">None</span>


<div class="viewcode-block" id="DataFile"><a class="viewcode-back" href="../../classes/Stoner.formats.simulations.GenXFile.__init__.html#Stoner.Core.DataFile">[docs]</a><span class="k">class</span> <span class="nc">DataFile</span><span class="p">(</span>
    <span class="n">DataFileSearchMixin</span><span class="p">,</span>
    <span class="n">DataFileInterfacesMixin</span><span class="p">,</span>
    <span class="n">DataFileOperatorsMixin</span><span class="p">,</span>
    <span class="n">DataFilePropertyMixin</span><span class="p">,</span>
    <span class="n">metadataObject</span><span class="p">,</span>
    <span class="n">MutableSequence</span><span class="p">,</span>
<span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Base class object that represents a matrix of data, associated metadata and column headers.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        column_headers (list):</span>
<span class="sd">            list of strings of the column names of the data.</span>
<span class="sd">        data (2D numpy masked array):</span>
<span class="sd">            The attribute that stores the nuermical data for each DataFile. This is a :py:class:`DataArray` instance -</span>
<span class="sd">            which is itself a subclass of :py:class:`numpy.ma.MaskedArray`.</span>
<span class="sd">        title (string):</span>
<span class="sd">            The title of the measurement.</span>
<span class="sd">        filename (string):</span>
<span class="sd">            The current filename of the data if loaded from or already saved to disc. This is the default filename</span>
<span class="sd">            used by the :py:meth:`Stoner.Core.DataFile.load` and :py:meth:`Stoner.Core.DataFile.save`.</span>
<span class="sd">        header (string):</span>
<span class="sd">            A readonly property that returns a pretty formatted string giving the header of tabular representation.</span>
<span class="sd">        mask (array of booleans):</span>
<span class="sd">            Returns the current mask applied to the numerical data equivalent to self.data.mask.</span>
<span class="sd">        mime_type (list of str):</span>
<span class="sd">            The possible mime-types of data files represented by each matching filename pattern in</span>
<span class="sd">            :py:attr:`Datafile.pattern`.</span>
<span class="sd">        patterns (list):</span>
<span class="sd">            A list of filename extenion glob patterns that matrches the expected filename patterns for a DataFile</span>
<span class="sd">            (*.txt and *.dat&quot;)</span>
<span class="sd">        priority (int):</span>
<span class="sd">            Used to indicathe order in which subclasses of :py:class:`DataFile` are tried when loading data. A higher</span>
<span class="sd">            number means a lower priority (!)</span>
<span class="sd">        setas (:py:class:`_stas`):</span>
<span class="sd">            Defines certain columns to contain X, Y, Z or errors in X,Y,Z data.</span>
<span class="sd">        shape (tuple of integers):</span>
<span class="sd">            Returns the shape of the data (rows,columns) - equivalent to self.data.shape.</span>
<span class="sd">        records (numpy record array):</span>
<span class="sd">            Returns the data in the form of a list of yuples where each tuple maps to the columsn names.</span>
<span class="sd">        clone (DataFile):</span>
<span class="sd">            Creates a deep copy of the :py:class`DataFile` object.</span>
<span class="sd">        dict_records (array of dictionaries):</span>
<span class="sd">            View the data as an array or dictionaries where each dictionary represnets one row with keys dervied</span>
<span class="sd">            from column headers.</span>
<span class="sd">        dims (int):</span>
<span class="sd">            When data columns are set as x,y,z etc. returns the number of dimensions implied in the data set</span>
<span class="sd">        dtype (numpoy dtype):</span>
<span class="sd">            Returns the datatype stored in the :py:attr:`DataFile.data` attribute.</span>
<span class="sd">        T (:py:class:`DataArray`):</span>
<span class="sd">            Transposed version of the data.</span>
<span class="sd">        subclasses (list):</span>
<span class="sd">            Returns a list of all the subclasses of DataFile currently in memory, sorted by</span>
<span class="sd">            their py:attr:`Stoner.Core.DataFile.priority`. Each entry in the list consists of the</span>
<span class="sd">            string name of the subclass and the class object.</span>
<span class="sd">        xcol (int):</span>
<span class="sd">            If a column has been designated as containing *x* values, this will return the index of that column</span>
<span class="sd">        xerr (int):</span>
<span class="sd">            Similarly to :py:attr:`DataFile.xcol` but for the x-error value column.</span>
<span class="sd">        ycol (list of int):</span>
<span class="sd">            Similarly to :py:attr:`DataFile.xcol` but for the y value columns.</span>
<span class="sd">        yerr (list of int):</span>
<span class="sd">            Similarly to :py:attr:`DataFile.xcol` but for the y error value columns.</span>
<span class="sd">        zcol (list of int):</span>
<span class="sd">            Similarly to :py:attr:`DataFile.xcol` but for the z value columns.</span>
<span class="sd">        zerr (list of int):</span>
<span class="sd">            Similarly to :py:attr:`DataFile.xcol` but for the z error value columns.</span>
<span class="sd">        ucol (list of int):</span>
<span class="sd">            Similarly to :py:attr:`DataFile.xcol` but for the u (x-axis direction cosine) columns.</span>
<span class="sd">        vcol (list of int):</span>
<span class="sd">            Similarly to :py:attr:`DataFile.xcol` but for the v (y-axis direction cosine) columns.</span>
<span class="sd">        wcol (list of int):</span>
<span class="sd">            Similarly to :py:attr:`DataFile.xcol` but for the w (z-axis direction cosine) columns.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#: priority (int): is the load order for the class, smaller numbers are tried before larger numbers.</span>
    <span class="c1">#   .. note::</span>
    <span class="c1">#</span>
    <span class="c1">#      Subclasses with priority&lt;=32 should make some positive identification that they have the right</span>
    <span class="c1">#      file type before attempting to read data.</span>
    <span class="n">priority</span> <span class="o">=</span> <span class="mi">32</span>

    <span class="c1">#: pattern (list of str): A list of file extensions that might contain this type of file. Used to construct</span>
    <span class="c1"># the file load/save dialog boxes.</span>
    <span class="n">_patterns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;*.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;*.tdi&quot;</span><span class="p">]</span>  <span class="c1"># Recognised filename patterns</span>

    <span class="c1"># mimetypes we match</span>
    <span class="n">mime_type</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;text/plain&quot;</span><span class="p">]</span>

    <span class="n">_conv_string</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">_conv_float</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="c1"># ====================================================================================</span>
    <span class="c1">############################     Object Construction   ###############################</span>
    <span class="c1"># ====================================================================================</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prepare the basic DataFile instance before the mixins add their bits.&quot;&quot;&quot;</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="n">metadataObject</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;debug&quot;</span><span class="p">,</span> <span class="n">kargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;debug&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_masks</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_public_attrs_real</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_data&quot;</span><span class="p">,</span> <span class="n">DataArray</span><span class="p">([]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_baseclass</span> <span class="o">=</span> <span class="n">DataFile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kargs</span> <span class="o">=</span> <span class="n">kargs</span>
        <span class="k">return</span> <span class="bp">self</span>

<div class="viewcode-block" id="DataFile.__init__"><a class="viewcode-back" href="../../classes/Stoner.Core.DataFile.__init__.html#Stoner.Core.DataFile.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialise the DataFile from arrays, dictionaries and filenames.</span>

<span class="sd">        Various forms are recognised:</span>

<span class="sd">        .. py:function:: DataFile(&#39;filename&#39;,&lt;optional filetype&gt;,&lt;args&gt;)</span>
<span class="sd">            :noindex:</span>

<span class="sd">            Creates the new DataFile object and then executes the :py:class:`DataFile`.load</span>
<span class="sd">            method to load data from the given *filename*.</span>

<span class="sd">        .. py:function:: DataFile(array)</span>
<span class="sd">            :noindex:</span>

<span class="sd">            Creates a new DataFile object and assigns the *array* to the</span>
<span class="sd">            :py:attr:`DataFile.data`  attribute.</span>

<span class="sd">        .. py:function:: DataFile(dictionary)</span>
<span class="sd">            :noindex:</span>

<span class="sd">            Creates the new DataFile object. If the dictionary keys are all strigns and the values are all</span>
<span class="sd">            numpy D arrays of equal length, then assumes the dictionary represents columns of data and the keys</span>
<span class="sd">            are the column titles, otherwise initialises the metadata with :parameter: dictionary.</span>

<span class="sd">        .. py:function:: DataFile(array,dictionary)</span>
<span class="sd">            :noindex:</span>

<span class="sd">            Creates the new DataFile object and does the combination of the</span>
<span class="sd">            previous two forms.</span>


<span class="sd">        .. py:function:: DataFile(DataFile)</span>
<span class="sd">            :noindex:</span>

<span class="sd">            Creates the new DataFile object and initialises all data from the</span>
<span class="sd">            existing :py:class:`DataFile` instance. This on the face of it does the same as</span>
<span class="sd">            the assignment operator, but is more useful when one or other of the</span>
<span class="sd">            DataFile objects is an instance of a sub - class of DataFile</span>

<span class="sd">        Args:</span>
<span class="sd">            args (positional arguments):</span>
<span class="sd">                Variable number of arguments that match one of the definitions above</span>
<span class="sd">            kargs (keyword Arguments):</span>
<span class="sd">                All keyword arguments that match public attributes are used to set those public attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># init instance attributes</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DataFile</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">)</span>  <span class="c1"># initialise self.metadata)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_public_attrs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
            <span class="s2">&quot;setas&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">string_types</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">dict</span><span class="p">),</span>
            <span class="s2">&quot;column_headers&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
            <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="n">typeHintedDict</span><span class="p">,</span>
            <span class="s2">&quot;debug&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
            <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="n">string_types</span><span class="p">,</span>
            <span class="s2">&quot;mask&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_repr_limits</span> <span class="o">=</span> <span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="k">else</span> <span class="mi">3</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_single</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_double</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_many</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_setas</span><span class="o">.</span><span class="n">_get_cols</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">handler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">handler</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">kargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kargs</span>
            <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_kargs&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;Stoner.class&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">if</span> <span class="n">kargs</span><span class="p">:</span>  <span class="c1"># set public attributes from keywords</span>
            <span class="n">to_go</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kargs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_public_attrs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kargs</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_public_attrs</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">kargs</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_raise_type_error</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                        <span class="n">to_go</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> is not a recognised attribute (</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_public_attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">to_go</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">kargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done DataFile init&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_init_single</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle constructor with 1 arguement - called from __init__.&quot;&quot;&quot;</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">string_types</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">arg</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">IOBase</span><span class="p">):</span>
            <span class="c1"># Filename- load datafile</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="c1"># numpy.array - set data</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">DataArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">arg</span><span class="p">),</span> <span class="n">setas</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_setas</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Column_</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">1</span><span class="p">])]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">:</span>
                    <span class="bp">self</span> <span class="o">+=</span> <span class="n">row</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>  <span class="c1"># Dictionary - use as data or metadata</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">all_type</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">string_types</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">all_type</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">])</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">DataFile</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">arg</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="ow">and</span> <span class="n">a</span> <span class="o">!=</span> <span class="s2">&quot;_baseclass&quot;</span><span class="p">:</span>
                    <span class="nb">super</span><span class="p">(</span><span class="n">DataFile</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">a</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">DataArray</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">setas</span><span class="o">=</span><span class="n">arg</span><span class="o">.</span><span class="n">setas</span><span class="o">.</span><span class="n">clone</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">setas</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">setas</span><span class="o">.</span><span class="n">clone</span>
        <span class="k">elif</span> <span class="s2">&quot;&lt;class &#39;Stoner.Image.core.ImageFile&#39;&gt;&quot;</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">arg</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__mro__</span>
        <span class="p">]:</span>  <span class="c1"># Crazy hack to avoid importing a circular ref!</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x_vector&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y_vector&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">image</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">z</span><span class="o">.</span><span class="n">ravel</span><span class="p">()))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;Image Intensity&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setas</span> <span class="o">=</span> <span class="s2">&quot;xyz&quot;</span>
        <span class="k">elif</span> <span class="n">pd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">values</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
                    <span class="n">ch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">isIterable</span><span class="p">(</span><span class="n">ch</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">ch_i</span> <span class="ow">in</span> <span class="n">col</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ch_i</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
                            <span class="n">ch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ch_i</span><span class="p">)</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Column </span><span class="si">{</span><span class="n">ix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Column </span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span> <span class="o">=</span> <span class="n">ch</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">levels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">arg</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="s2">&quot;xyzdefuvw.&quot;</span><span class="p">):</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">setas</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">isIterable</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="ow">and</span> <span class="n">all_type</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">isIterable</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="ow">and</span> <span class="n">all_type</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_many</span><span class="p">(</span><span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No constructor for </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_setas</span><span class="o">.</span><span class="n">cols</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setas</span><span class="o">.</span><span class="n">_get_cols</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_init_double</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Two argument constructors handled here. Called form __init__.&quot;&quot;&quot;</span>
        <span class="p">(</span><span class="n">arg0</span><span class="p">,</span> <span class="n">arg1</span><span class="p">)</span> <span class="o">=</span> <span class="n">args</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">isIterable</span><span class="p">(</span><span class="n">arg1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">all_type</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">string_types</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_single</span><span class="p">(</span><span class="n">arg0</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_single</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg0</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_many</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_many</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle more than two arguments to the constructor - called from init.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="c1"># ============================================================================================</span>
    <span class="c1">############################   Speical Methods ###############################################</span>
    <span class="c1"># ============================================================================================</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clone the DataFile, but allowing additional arguments to modify the new clone.</span>

<span class="sd">        Args:</span>
<span class="sd">            *args (tuple):</span>
<span class="sd">                Positional arguments to pass through to the new clone.</span>
<span class="sd">            **kargs (dict):</span>
<span class="sd">                Keyword arguments to pass through to the new clone.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If a keyword argument doesn&#39;t match an attribute.</span>

<span class="sd">        Returns:</span>
<span class="sd">            new_d (DataFile):</span>
<span class="sd">                Modified clone of the current object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">2</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">new_d</span><span class="o">.</span><span class="n">_init_single</span><span class="p">,</span> <span class="n">new_d</span><span class="o">.</span><span class="n">_init_double</span><span class="p">,</span> <span class="n">new_d</span><span class="o">.</span><span class="n">_init_many</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">handler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">handler</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kargs</span><span class="p">:</span>  <span class="c1"># set public attributes from keywords</span>
            <span class="n">myattrs</span> <span class="o">=</span> <span class="n">new_d</span><span class="o">.</span><span class="n">_public_attrs</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kargs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">myattrs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kargs</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">myattrs</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span>
                        <span class="n">new_d</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">kargs</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">myattrs</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">):</span>
                            <span class="n">typ</span> <span class="o">=</span> <span class="s2">&quot;one of &quot;</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">t</span><span class="p">))</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">myattrs</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">typ</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;a </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">myattrs</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> should be </span><span class="si">{</span><span class="n">typ</span><span class="si">}</span><span class="s2"> not a </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">kargs</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">new_d</span>

    <span class="k">def</span> <span class="nf">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Provide support for copy.deepcopy to work.&quot;&quot;&quot;</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="n">memo</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)]</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">memo</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="fm">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reeturns the attributes of the current object.</span>

<span class="sd">        Augmenting the keys of self.__dict__ with the attributes that __getattr__ will handle.&quot;&quot;&quot;</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="nb">dir</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="n">col_check</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;xcol&quot;</span><span class="p">:</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;xerr&quot;</span><span class="p">:</span> <span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;ycol&quot;</span><span class="p">:</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;yerr&quot;</span><span class="p">:</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="s2">&quot;zcol&quot;</span><span class="p">:</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;zerr&quot;</span><span class="p">:</span> <span class="s2">&quot;f&quot;</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">col_check</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;_setas&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">_setas</span><span class="o">.</span><span class="n">cols</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">_setas</span><span class="o">.</span><span class="n">cols</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">attr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col_check</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">_setas</span><span class="o">.</span><span class="n">cols</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">_setas</span><span class="o">.</span><span class="n">cols</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                    <span class="n">attr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col_check</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle some special pseudo attributes that map to the setas columns.</span>

<span class="sd">        Args:</span>
<span class="sd">            name (string):</span>
<span class="sd">                The name of the attribute to be returned.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Various:</span>
<span class="sd">                the DataFile object in various forms</span>

<span class="sd">        Supported attributes:</span>
<span class="sd">            - records:</span>
<span class="sd">                return the DataFile data as a numpy structured</span>
<span class="sd">                array - i.e. rows of elements whose keys are column headings</span>
<span class="sd">                - clone:</span>
<span class="sd">                    returns a deep copy of the current DataFile instance</span>

<span class="sd">        Otherwise the name parameter is tried as an argument to :py:meth:`DataFile.column` and the resultant column</span>
<span class="sd">        is returned. If DataFile.column raises a KeyError this is remapped as an AttributeError.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">setas_cols</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="s2">&quot;u&quot;</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;debug&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">DataFile</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ret</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">setas_cols</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getattr_col</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ret</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">setas</span><span class="o">.</span><span class="n">cols</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setas</span><span class="o">.</span><span class="n">cols</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ret</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="k">return</span> <span class="n">ret</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">_setas</span><span class="o">.</span><span class="n">find_col</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">setas_cols</span><span class="p">:</span>  <span class="c1"># Probably tried to use a setas col when it wasn&#39;t defined</span>
            <span class="k">raise</span> <span class="n">StonerSetasError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Tried accessing a </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> column, but setas is not defined and </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> is not a column name either&quot;</span>
            <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> is not an attribute of DataFile nor a column name&quot;</span><span class="p">)</span>

    <span class="c1">#    def __reduce_ex__(self, p):</span>
    <span class="c1">#        &quot;&quot;&quot;Machinery used for deepcopy.&quot;&quot;&quot;</span>
    <span class="c1">#        cls=self.__class__</span>
    <span class="c1">#        return (cls, (), self.__getstate__())</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Output the :py:class:`DataFile` object in TDI format.</span>

<span class="sd">        This allows one to print any :py:class:`DataFile` to a stream based</span>
<span class="sd">        object andgenerate a reasonable textual representation of the data.shape</span>

<span class="sd">        Returns:</span>
<span class="sd">            self in a textual format.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">get_option</span><span class="p">(</span><span class="s2">&quot;short_repr&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">get_option</span><span class="p">(</span><span class="s2">&quot;short_data_repr&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repr_short_</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repr_table_</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__repr_core__</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle attempts to set attributes not covered with class attribute variables.</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str):</span>
<span class="sd">                Name of attribute to set. Details of possible attributes below:</span>
<span class="sd">                -   mask Passes through to the mask attribute of self.data (which is a numpy masked array).</span>
<span class="sd">                    Also handles the case where you pass a callable object to nask where we pass each row to the</span>
<span class="sd">                    function and use the return reult as the mask</span>
<span class="sd">                -   data Ensures that the :py:attr:`data` attribute is always a :py:class:`numpy.ma.maskedarray`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">name</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">name</span><span class="p">),</span> <span class="nb">property</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">DataFile</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="s2">&quot;xyzuvwdef&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">setas</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setattr_col</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">DataFile</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Provide an implementation for str(DataFile) that does not shorten the output.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__repr_core__</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># ============================================================================================</span>
    <span class="c1">############################ Private Methods #################################################</span>
    <span class="c1"># ============================================================================================</span>

    <span class="k">def</span> <span class="nf">_col_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create an object which has keys  based either on arguments or setas attribute.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_col_args</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">)</span>  <span class="c1"># Now just pass through to DataArray</span>

    <span class="k">def</span> <span class="nf">__file_dialog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a file dialog box for loading or saving ~b DataFile objects.</span>

<span class="sd">        Args:</span>
<span class="sd">            mode (string):</span>
<span class="sd">                The mode of the file operation  &#39;r&#39; or &#39;w&#39;</span>

<span class="sd">        Returns:</span>
<span class="sd">            (str):</span>
<span class="sd">                A filename to be used for the file operation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Wildcard pattern to be used in file dialogs.</span>

        <span class="n">descs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;*.*&quot;</span><span class="p">:</span> <span class="s2">&quot;All Files&quot;</span><span class="p">}</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patterns</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">:</span>  <span class="c1"># pylint: disable=not-an-iterable</span>
            <span class="n">descs</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot; file&quot;</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">DataFile</span><span class="o">.</span><span class="n">subclasses</span><span class="p">:</span>  <span class="c1"># pylint: disable=E1136, E1133</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">DataFile</span><span class="o">.</span><span class="n">subclasses</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">patterns</span><span class="p">:</span>  <span class="c1"># pylint: disable=unsubscriptable-object</span>
                <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">descs</span><span class="p">:</span>
                    <span class="n">descs</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="n">DataFile</span><span class="o">.</span><span class="n">subclasses</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot; file&quot;</span>  <span class="c1"># pylint: disable=E1136</span>
                    <span class="p">)</span>  <span class="c1"># pylint: disable=unsubscriptable-object</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">descs</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">DataFile</span><span class="o">.</span><span class="n">subclasses</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot; file&quot;</span>  <span class="c1"># pylint: disable=unsubscriptable-object</span>

        <span class="n">patterns</span> <span class="o">=</span> <span class="n">descs</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">dirname</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;r&quot;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;file&quot;</span>
        <span class="k">elif</span> <span class="s2">&quot;w&quot;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;save&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;directory&quot;</span>
        <span class="n">dlg</span> <span class="o">=</span> <span class="n">get_filedialog</span><span class="p">(</span><span class="n">what</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">dirname</span><span class="p">,</span> <span class="n">patterns</span><span class="o">=</span><span class="n">patterns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dlg</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">dlg</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_getattr_col</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a column using the setas attribute.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">StonerSetasError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_interesting_cols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cols</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Workout which columns the user might be interested in in the basis of the setas.</span>

<span class="sd">        ArgsL</span>
<span class="sd">            cols (float):</span>
<span class="sd">                Maximum Number of columns to display</span>

<span class="sd">        Returns</span>
<span class="sd">            list(ints):</span>
<span class="sd">                The indices of interesting columns with breaks in runs indicated by -1</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="n">cols</span><span class="p">:</span>
            <span class="n">interesting</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">last</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">typ</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setas</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">last</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">last</span> <span class="o">!=</span> <span class="n">ix</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">interesting</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">last</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">if</span> <span class="n">typ</span> <span class="o">!=</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span>
                    <span class="n">interesting</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span>
                    <span class="n">last</span> <span class="o">=</span> <span class="n">ix</span>
            <span class="k">if</span> <span class="n">interesting</span> <span class="ow">and</span> <span class="n">interesting</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">interesting</span> <span class="o">=</span> <span class="n">interesting</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">interesting</span><span class="p">:</span>
                <span class="n">c_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">interesting</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">c_start</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">interesting</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">c_start</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">interesting</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">cols</span><span class="p">:</span>
                <span class="n">cols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">interesting</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">interesting</span><span class="p">[</span><span class="n">cols</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">interesting</span><span class="p">[</span><span class="n">cols</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">interesting</span><span class="p">[</span><span class="n">cols</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span> <span class="o">-</span> <span class="mi">2</span>
            <span class="n">interesting</span><span class="p">[</span><span class="n">cols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">interesting</span> <span class="o">=</span> <span class="n">interesting</span><span class="p">[:</span><span class="n">cols</span><span class="p">]</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">cols</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">interesting</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>

        <span class="n">col_assignments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">interesting</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span>
                    <span class="n">col_assignments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">col_assignments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">col_assignments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">interesting</span><span class="p">,</span> <span class="n">col_assignments</span><span class="p">,</span> <span class="n">cols</span>

    <span class="k">def</span> <span class="nf">_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Actually load the data from disc assuming a .tdi file format.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (str):</span>
<span class="sd">                Path to filename to be loaded. If None or False, a dialog bax is raised to ask for the filename.</span>

<span class="sd">        Returns:</span>
<span class="sd">            DataFile:</span>
<span class="sd">                A copy of the newly loaded :py:class`DataFile` object.</span>

<span class="sd">        Exceptions:</span>
<span class="sd">            StonerLoadError:</span>
<span class="sd">                Raised if the first row does not start with &#39;TDI Format 1.5&#39; or &#39;TDI Format=1.0&#39;.</span>

<span class="sd">        Note:</span>
<span class="sd">            The *_load* methods shouldbe overidden in each child class to handle the process of loading data from</span>
<span class="sd">            disc. If they encounter unexpected data, then they should raise StonerLoadError to signal this, so that</span>
<span class="sd">            the loading class can try a different sub-class instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_filename</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">datafile</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">datafile</span><span class="p">,</span> <span class="n">dialect</span><span class="o">=</span><span class="n">tab_delimited</span><span class="p">())</span>
                <span class="n">row</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;TDI Format 1.5&quot;</span><span class="p">:</span>
                    <span class="n">fmt</span> <span class="o">=</span> <span class="mf">1.5</span>
                <span class="k">elif</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;TDI Format=Text 1.0&quot;</span><span class="p">:</span>
                    <span class="n">fmt</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s2">&quot;Not a TDI File&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">StonerLoadError</span><span class="p">(</span><span class="s2">&quot;Not a TDI File&quot;</span><span class="p">)</span>
            <span class="n">col_headers_tmp</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
            <span class="n">data_array</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">metaDataArray</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>  <span class="c1"># Now read through the metadata columns</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="n">data_array</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">still_data</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">still_data</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>  <span class="c1"># end of metadata:</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cols</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>
                    <span class="n">metaDataArray</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">import_key</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># End of metadata reading, close filke and reopen to read data</span>
        <span class="k">if</span> <span class="n">still_data</span><span class="p">:</span>  <span class="c1"># data extends beyond metada - read with genfromtxt</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">DataArray</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>
                    <span class="n">skip_header</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">usemask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">usecols</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span>
                    <span class="n">invalid_raise</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">comments</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\0</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">data_array</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># some data less than metadata</span>
            <span class="n">footer</span> <span class="o">=</span> <span class="n">metaDataArray</span> <span class="o">-</span> <span class="n">data_array</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">DataArray</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>
                    <span class="n">skip_header</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">skip_footer</span><span class="o">=</span><span class="n">footer</span><span class="p">,</span>
                    <span class="n">usemask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">comments</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\0</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">usecols</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span> <span class="o">=</span> <span class="n">col_headers_tmp</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;TDI Format&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fmt</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="c1"># def _parse_metadata(self, key, value):</span>
    <span class="c1">#     &quot;&quot;&quot;Parse the metadata string, removing the type hints into a separate dictionary from the metadata.</span>

    <span class="c1">#     Args:</span>
    <span class="c1">#         key (string):</span>
    <span class="c1">#             The name of the metadata parameter to be written, possibly including a type hinting string.</span>
    <span class="c1">#         value (any):</span>
    <span class="c1">#             The value of the item of metadata.</span>

    <span class="c1">#     Note:</span>
    <span class="c1">#         Uses the typehint to set the type correctly in the dictionary</span>

    <span class="c1">#         All the clever work of managing the typehinting is done in the metadata dictionary object now.</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     self.metadata[key] = value</span>

    <span class="k">def</span> <span class="nf">__repr_core__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shorten</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Actuall do the repr work, but allow for a shorten parameter to save printing big files out to disc.&quot;&quot;&quot;</span>
        <span class="n">outp</span> <span class="o">=</span> <span class="s2">&quot;TDI Format 1.5</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">md</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">export_all</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">m</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">outp</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">md</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">outp</span> <span class="o">=</span> <span class="n">outp</span> <span class="o">+</span> <span class="n">md</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">filled</span><span class="p">()])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="n">r</span><span class="p">:</span>  <span class="c1"># More metadata</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
                <span class="n">outp</span> <span class="o">=</span> <span class="n">outp</span> <span class="o">+</span> <span class="n">md</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">elif</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="n">m</span><span class="p">:</span>  <span class="c1"># More data than metadata</span>
            <span class="k">if</span> <span class="n">shorten</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">shorten</span> <span class="ow">and</span> <span class="n">r</span> <span class="o">-</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="n">shorten</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">m</span> <span class="o">+</span> <span class="n">shorten</span> <span class="o">-</span> <span class="mi">100</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">outp</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">outp</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">filled</span><span class="p">()])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">outp</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;... </span><span class="si">{</span><span class="n">r</span> <span class="o">-</span> <span class="n">m</span> <span class="o">-</span> <span class="n">shorten</span> <span class="o">+</span> <span class="mi">100</span><span class="si">}</span><span class="s2"> lines skipped...</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">outp</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">outp</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">filled</span><span class="p">()])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">outp</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">outp</span> <span class="o">=</span> <span class="n">outp</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">filled</span><span class="p">()])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">outp</span>

    <span class="k">def</span> <span class="nf">_repr_html_private</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Version of repr_core that does and html output.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repr_table_</span><span class="p">(</span><span class="s2">&quot;html&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_repr_short_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">) of shape </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setas</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span><span class="si">}</span><span class="s2"> items of metadata&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">_repr_table_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;rst&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert the DataFile to a 2D array and then feed to tabulate.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">tabulate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;No tabulate.&quot;</span><span class="p">)</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="s2">&quot;&lt;br/&gt;&quot;</span> <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;html&quot;</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repr_limits</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">interesting</span><span class="p">,</span> <span class="n">col_assignments</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interesting_cols</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">interesting</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">c_w</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span><span class="p">[</span><span class="n">x</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">interesting</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c_w</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">wrapper</span> <span class="o">=</span> <span class="n">TextWrapper</span><span class="p">(</span><span class="n">subsequent_indent</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="p">(</span><span class="mi">80</span> <span class="o">-</span> <span class="n">c_w</span> <span class="o">*</span> <span class="n">c</span><span class="p">))))</span>
        <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">shorten</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">rows</span> <span class="o">+</span> <span class="n">rows</span> <span class="o">%</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shorten</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>

        <span class="n">shorten</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="n">cols</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">),</span> <span class="n">r</span><span class="p">)</span>

        <span class="n">outp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
        <span class="n">outp</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="s2">&quot;...&quot;</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="k">if</span> <span class="n">ix</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;....&quot;</span> <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="n">interesting</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">col_assignments</span><span class="p">)):</span>
            <span class="n">spaces1</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">((</span><span class="n">c_w</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="p">))</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">spaces2</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">((</span><span class="n">c_w</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">ch</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">spaces1</span><span class="si">}{</span><span class="n">h</span><span class="si">}{</span><span class="n">lb</span><span class="si">}{</span><span class="n">spaces2</span><span class="si">}{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spaces1</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">spaces2</span><span class="p">))</span>
        <span class="n">outp</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">ch</span>
        <span class="n">outp</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">col_assignments</span>
        <span class="n">outp</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;TDI Format 1.5</span><span class="si">{</span><span class="n">lb</span><span class="si">}</span><span class="s2">index&quot;</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">md</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">export_all</span><span class="p">():</span>
            <span class="n">md</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="s2">&quot;= &quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">md</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">outp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>  <span class="c1"># pylint: disable=E1136</span>
                    <span class="n">outp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outp</span><span class="p">,</span> <span class="p">[[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">outp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># pylint: disable=E1136</span>
                <span class="n">outp</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">ic</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">interesting</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">shorten</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>

                    <span class="n">col_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">[:</span> <span class="n">r</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="p">],</span> <span class="s2">&quot;#####&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span> <span class="n">r</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
                    <span class="n">outp</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">r</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ic</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">col_out</span>
                    <span class="n">col_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="o">-</span><span class="n">r</span> <span class="o">//</span> <span class="mi">2</span> <span class="p">:,</span> <span class="n">c</span><span class="p">],</span> <span class="s2">&quot;#####&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="n">r</span> <span class="o">//</span> <span class="mi">2</span> <span class="p">:,</span> <span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
                    <span class="n">outp</span><span class="p">[</span><span class="n">r</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ic</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">col_out</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">col_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">[:,</span> <span class="n">c</span><span class="p">],</span> <span class="s2">&quot;#####&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
                    <span class="n">outp</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ic</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">col_out</span>
        <span class="k">return</span> <span class="n">tabulate</span><span class="p">(</span><span class="n">outp</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">outp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tablefmt</span><span class="o">=</span><span class="n">fmt</span><span class="p">,</span> <span class="n">numalign</span><span class="o">=</span><span class="s2">&quot;decimal&quot;</span><span class="p">,</span> <span class="n">stralign</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_setattr_col</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Attempt to either assign data columns if set up, or setas setting.</span>

<span class="sd">        Args:</span>
<span class="sd">            name (length 1 string):</span>
<span class="sd">                Column type to work with (one of x,y,z,u,v,w,d,e or f)</span>
<span class="sd">            value (nd array or column index):</span>
<span class="sd">                If an ndarray and the column type corresponding to *name* is set up, then overwrite the column(s)</span>
<span class="sd">                of data with this new data. If an index type, then set the corresponding setas assignment to</span>
<span class="sd">                these columns.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">T</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Value to be assigned to data columns is the wrong shape!&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">find_col</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setas</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">force_list</span><span class="o">=</span><span class="kc">True</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">index_types</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_setas</span><span class="p">({</span><span class="n">name</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">_set_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cumulative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply func to each row in self.data and uses the result to set the mask for the row.</span>

<span class="sd">        Args:</span>
<span class="sd">            func (callable):</span>
<span class="sd">                A Callable object of the form lambda x:True where x is a row of data (numpy</span>
<span class="sd">            invert (bool):</span>
<span class="sd">                Optionally invert te reult of the func test so that it unmasks data instead</span>
<span class="sd">            cumulative (bool):</span>
<span class="sd">                if tru, then an unmask value doesn&#39;t unmask the data, it just leaves it as it is.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_inspect_</span><span class="o">.</span><span class="n">getargs</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__code__</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">():</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">args</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">r</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">t</span> <span class="o">^</span> <span class="n">invert</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">cumulative</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)[</span><span class="mi">1</span><span class="p">])):</span>
                    <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">^</span> <span class="n">invert</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="n">cumulative</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_push_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy the current data mask to a temporary store and replace it with a new mask if supplied.</span>

<span class="sd">        Args:</span>
<span class="sd">            mask (:py:class:numpy.array of bool or bool or None):</span>
<span class="sd">                The new data mask to apply (defaults to None = unmask the data</span>

<span class="sd">        Returns:</span>
<span class="sd">            Nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span>

    <span class="k">def</span> <span class="nf">_pop_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Replace the mask on the data with the last one stored by _push_mask().</span>

<span class="sd">        Returns:</span>
<span class="sd">            Nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_masks</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>  <span class="c1"># pylint: disable=E0203</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_masks</span><span class="p">:</span>  <span class="c1"># pylint: disable=E0203</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_masks</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_raise_type_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Raise a type error when setting an attribute k.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_public_attrs</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">typ</span> <span class="o">=</span> <span class="s2">&quot;one of &quot;</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">t</span><span class="p">))</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_public_attrs</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">typ</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;a </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_public_attrs</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> should be </span><span class="si">{</span><span class="n">typ</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># ============================================================================================</span>
    <span class="c1">############################   Public Methods ################################################</span>
    <span class="c1"># ============================================================================================</span>

<div class="viewcode-block" id="DataFile.add_column"><a class="viewcode-back" href="../../classes/Stoner.Core.DataFile.add_column.html#Stoner.Core.DataFile.add_column">[docs]</a>    <span class="k">def</span> <span class="nf">add_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column_data</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">func_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">setas</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Append a column of data or inserts a column to a datafile instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            column_data (:py:class:`numpy.array` or list or callable):</span>
<span class="sd">                Data to append or insert or a callable function that will generate new data</span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">            header (string):</span>
<span class="sd">                The text to set the column header to,</span>
<span class="sd">                if not supplied then defaults to &#39;col#&#39;</span>
<span class="sd">            index (index type):</span>
<span class="sd">                The  index (numeric or string) to insert (or replace) the data</span>
<span class="sd">            func_args (dict):</span>
<span class="sd">                If column_data is a callable object, then this argument</span>
<span class="sd">                can be used to supply a dictionary of function arguments to the callable object.</span>
<span class="sd">            replace (bool):</span>
<span class="sd">                Replace the data or insert the data (default)</span>
<span class="sd">            setas (str):</span>
<span class="sd">                Set the type of column (x,y,z data etc - see :py:attr:`Stoner.Core.DataFile.setas`)</span>

<span class="sd">        Returns:</span>
<span class="sd">            self:</span>
<span class="sd">                The :py:class:`DataFile` instance with the additonal column inserted.</span>

<span class="sd">        Note:</span>
<span class="sd">            Like most :py:class:`DataFile` methods, this method operates in-place in that it also modifies</span>
<span class="sd">            the original DataFile Instance as well as returning it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="n">index</span><span class="p">:</span>  <span class="c1"># Enure index is set</span>
            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">replace</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">int_types</span><span class="p">)</span> <span class="ow">and</span> <span class="n">index</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">replace</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_col</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

        <span class="c1"># Sort out the data and get it into an array of values.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">column_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">column_data</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column_data</span><span class="p">,</span> <span class="n">DataArray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">column_data</span><span class="o">.</span><span class="n">column_headers</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column_data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">np_data</span> <span class="o">=</span> <span class="n">column_data</span>
        <span class="k">elif</span> <span class="n">callable</span><span class="p">(</span><span class="n">column_data</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func_args</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">new_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">column_data</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">func_args</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">column_data</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
            <span class="n">np_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>

        <span class="c1"># Sort out the sizes of the arrays</span>
        <span class="k">if</span> <span class="n">np_data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">np_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">np_data</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">cl</span><span class="p">,</span> <span class="n">cw</span> <span class="o">=</span> <span class="n">np_data</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># Make setas</span>
        <span class="n">setas</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span> <span class="o">*</span> <span class="n">cw</span> <span class="k">if</span> <span class="n">setas</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">setas</span>

        <span class="k">if</span> <span class="n">isIterable</span><span class="p">(</span><span class="n">setas</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">setas</span><span class="p">)</span> <span class="o">==</span> <span class="n">cw</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">setas</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s2">&quot;.-xyzuvwdefpqr&quot;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;setas parameter should be a string or list of letter in the set xyzdefuvw.-, not </span><span class="si">{</span><span class="n">setas</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;setas parameter should be a string or list of letter the same length as the number of columns</span>
<span class="s2">                being added in the set xyzdefuvw.-, not </span><span class="si">{</span><span class="n">setas</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Make sure our current data is at least 2D and get its size</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="p">(</span><span class="n">dr</span><span class="p">,</span> <span class="n">dc</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[]])</span>
            <span class="p">(</span><span class="n">dr</span><span class="p">,</span> <span class="n">dc</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Expand either our current data or new data to have the same number of rows</span>
        <span class="k">if</span> <span class="n">cl</span> <span class="o">&gt;</span> <span class="n">dr</span> <span class="ow">and</span> <span class="n">dc</span> <span class="o">*</span> <span class="n">dr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Existing data is finite and too short</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">DataArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">cl</span> <span class="o">-</span> <span class="n">dr</span><span class="p">,</span> <span class="n">dc</span><span class="p">)),</span> <span class="mi">0</span><span class="p">),</span> <span class="n">setas</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">setas</span><span class="o">.</span><span class="n">clone</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">cl</span> <span class="o">&lt;</span> <span class="n">dr</span><span class="p">:</span>  <span class="c1"># New data is too short</span>
            <span class="n">np_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np_data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dr</span> <span class="o">-</span> <span class="n">cl</span><span class="p">,</span> <span class="n">cw</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">np_data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">np_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">np_data</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="k">elif</span> <span class="n">dc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Existing data has no width - replace with cl,0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">DataArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">cl</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="n">dr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Existing data has no rows - expand existing data with zeros to have right length</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">DataArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">cl</span><span class="p">,</span> <span class="n">dr</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">setas</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">setas</span><span class="o">.</span><span class="n">clone</span><span class="p">)</span>

        <span class="c1"># If not replacing, then add extra columns to existing data.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">replace</span><span class="p">:</span>
            <span class="n">colums</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span><span class="p">)</span>
            <span class="n">old_setas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setas</span><span class="o">.</span><span class="n">clone</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>  <span class="c1"># appending column</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">DataArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">np_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">setas</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">setas</span><span class="o">.</span><span class="n">clone</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">DataArray</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:</span><span class="n">index</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">np_data</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">index</span><span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
                    <span class="p">),</span>
                    <span class="n">setas</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">setas</span><span class="o">.</span><span class="n">clone</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">colums</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setas</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_setas</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">dc</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span><span class="p">[</span><span class="n">ix</span> <span class="o">+</span> <span class="n">cw</span><span class="p">]</span> <span class="o">=</span> <span class="n">colums</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setas</span><span class="p">[</span><span class="n">ix</span> <span class="o">+</span> <span class="n">cw</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_setas</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
        <span class="c1"># Check that we don&#39;t need to expand to overwrite with the new data</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">+</span> <span class="n">cw</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">DataArray</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">index</span> <span class="o">+</span> <span class="n">cw</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">setas</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">setas</span><span class="o">.</span><span class="n">clone</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Put the data into the array</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">index</span> <span class="p">:</span> <span class="n">index</span> <span class="o">+</span> <span class="n">cw</span><span class="p">]</span> <span class="o">=</span> <span class="n">np_data</span>

        <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># This will fix the header if not defined.</span>
            <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Column </span><span class="si">{</span><span class="n">ix</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span> <span class="o">+</span> <span class="n">cw</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
            <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="n">header</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">!=</span> <span class="n">cw</span><span class="p">:</span>
            <span class="n">header</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;Column </span><span class="si">{ix}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span> <span class="o">+</span> <span class="n">cw</span><span class="p">)])</span>
        <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">setas</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span><span class="p">[</span><span class="n">ix</span> <span class="o">+</span> <span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdr</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setas</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="DataFile.columns"><a class="viewcode-back" href="../../classes/Stoner.Core.DataFile.columns.html#Stoner.Core.DataFile.columns">[docs]</a>    <span class="k">def</span> <span class="nf">columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">not_masked</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterate over the columns of data int he datafile.</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            no_masked (bool):</span>
<span class="sd">                Only iterate over columns that don&#39;t have masked elements</span>
<span class="sd">            reset (bool):</span>
<span class="sd">                If true then reset the iterator (immediately stops the current iteration without returning any data)./</span>

<span class="sd">        Yields:</span>
<span class="sd">            1D array: Returns the next column of data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">not_masked</span> <span class="ow">and</span> <span class="n">ma</span><span class="o">.</span><span class="n">is_masked</span><span class="p">(</span><span class="n">col</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">reset</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span></div>

<div class="viewcode-block" id="DataFile.del_column"><a class="viewcode-back" href="../../classes/Stoner.Core.DataFile.del_column.html#Stoner.Core.DataFile.del_column">[docs]</a>    <span class="k">def</span> <span class="nf">del_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">duplicates</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete a column from the current :py:class:`DataFile` object.</span>

<span class="sd">        Args:</span>
<span class="sd">            col (int, string, iterable of booleans, list or re):</span>
<span class="sd">                is the column index as defined for :py:meth:`DataFile.find_col` to the column to be deleted</span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">            duplicates (bool):</span>
<span class="sd">                (default False) look for duplicated columns</span>

<span class="sd">        Returns:</span>
<span class="sd">            self:</span>
<span class="sd">                The :py:class:`DataFile` object with the column deleted.</span>

<span class="sd">        Note:</span>
<span class="sd">            - If duplicates is True and col is None then all duplicate columns are removed,</span>
<span class="sd">            - if col is not None and duplicates is True then all duplicates of the specified column are removed.</span>
<span class="sd">            - If duplicates is False and *col* is either None or False then all masked coplumns are deleeted. If</span>
<span class="sd">                *col* is True, then all columns that are not set i the :py:attr:`setas` attrobute are delted.</span>
<span class="sd">            - If col is a list (duplicates should not be None) then the all the matching columns are found.</span>
<span class="sd">            - If col is an iterable of booleans, then all columns whose elements are False are deleted.</span>
<span class="sd">            - If col is None and duplicates is None, then all columns with at least one elelemtn masked</span>
<span class="sd">                    will be deleted</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">duplicates</span><span class="p">:</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span>
            <span class="n">dups</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">chi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ch</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">chi</span> <span class="ow">in</span> <span class="n">ch</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]:</span>
                        <span class="n">dups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ch</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">chi</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">ch</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">find_col</span><span class="p">(</span><span class="n">col</span><span class="p">)]</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">dups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">del_column</span><span class="p">(</span><span class="n">dups</span><span class="p">,</span> <span class="n">duplicates</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">col</span><span class="p">):</span>  <span class="c1"># Without defining col we just compress by the mask</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">mask_cols</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">DataArray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">compressed</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">compress_cols</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="n">col</span><span class="p">:</span>  <span class="c1"># Without defining col we just compress by the mask</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setas</span><span class="o">.</span><span class="n">set</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span><span class="p">]</span>
            <span class="n">setas</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">setas</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setas</span><span class="o">.</span><span class="n">set</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setas</span><span class="o">.</span><span class="n">set</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setas</span> <span class="o">=</span> <span class="n">setas</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span> <span class="o">=</span> <span class="n">ch</span>
        <span class="k">elif</span> <span class="n">isIterable</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="ow">and</span> <span class="n">all_type</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>  <span class="c1"># If col is an iterable of booleans then we index by that</span>
            <span class="n">col</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
            <span class="n">new_setas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setas</span><span class="p">)[</span><span class="n">col</span><span class="p">]</span>
            <span class="n">new_column_headers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span><span class="p">)[</span><span class="n">col</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setas</span> <span class="o">=</span> <span class="n">new_setas</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span> <span class="o">=</span> <span class="n">new_column_headers</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Otherwise find individual columns</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_col</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">DataArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">c</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">ch</span><span class="p">[</span><span class="n">cl</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span> <span class="o">=</span> <span class="n">ch</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="DataFile.del_nan"><a class="viewcode-back" href="../../classes/Stoner.Core.DataFile.del_nan.html#Stoner.Core.DataFile.del_nan">[docs]</a>    <span class="k">def</span> <span class="nf">del_nan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clone</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove rows that have nan in them.</span>

<span class="sd">        eyword Arguments:</span>
<span class="sd">            col (index types or None):</span>
<span class="sd">                column(s) to look for nan&#39;s in. If None or not given, use setas columns.</span>
<span class="sd">            clone (boolean):</span>
<span class="sd">                if True clone the current object before running and then return the clone not self.</span>

<span class="sd">        Return:</span>
<span class="sd">            self (DataFile):</span>
<span class="sd">                Returns a copy of the current object (or clone if *clone*=True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">clone</span><span class="p">:</span>  <span class="c1"># Set ret to be our clone</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Not cloning so ret is self</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># If col is still None, use all columsn that are set to any value in self.setas</span>
            <span class="n">col</span> <span class="o">=</span> <span class="p">[</span><span class="n">ix</span> <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setas</span><span class="p">)</span> <span class="k">if</span> <span class="n">col</span> <span class="o">!=</span> <span class="s2">&quot;.&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isLikeList</span><span class="p">(</span><span class="n">col</span><span class="p">):</span>  <span class="c1"># If col isn&#39;t a list, make it one now</span>
            <span class="n">col</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="p">]</span>
        <span class="n">col</span> <span class="o">=</span> <span class="p">[</span><span class="n">ret</span><span class="o">.</span><span class="n">find_col</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">col</span><span class="p">]</span>  <span class="c1"># Normalise col to be a list of integers</span>
        <span class="n">dels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="n">col</span><span class="p">:</span>
            <span class="n">dels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
                <span class="n">dels</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">ix</span><span class="p">])</span>
            <span class="p">)</span>  <span class="c1"># dels contains True if any row contains a NaN in columns col</span>
        <span class="n">not_masked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">mask_rows</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">mask</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>  <span class="c1"># Get rows wqhich are not masked</span>
        <span class="n">dels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">not_masked</span><span class="p">,</span> <span class="n">dels</span><span class="p">)</span>  <span class="c1"># And make dels just be unmasked rows with NaNs</span>

        <span class="n">ret</span><span class="o">.</span><span class="n">del_rows</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">dels</span><span class="p">))</span>  <span class="c1"># Del the those rows</span>
        <span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="DataFile.del_rows"><a class="viewcode-back" href="../../classes/Stoner.Core.DataFile.del_rows.html#Stoner.Core.DataFile.del_rows">[docs]</a>    <span class="k">def</span> <span class="nf">del_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Search in the numerica data for the lines that match and deletes the corresponding rows.</span>

<span class="sd">        Args:</span>
<span class="sd">            col (list,slice,int,string, re, callable or None):</span>
<span class="sd">                Column containg values to search for.</span>
<span class="sd">            val (float or callable):</span>
<span class="sd">                Specifies rows to delete. Maybe:</span>
<span class="sd">                    -   None - in which case the *col* argument is used to identify rows to be deleted,</span>
<span class="sd">                    -   a float in which case rows whose columncol = val are deleted</span>
<span class="sd">                    -   or a function - in which case rows where the function evaluates to be true are deleted.</span>
<span class="sd">                    -   a tuple, in which case rows where column col takes value between the minium and maximum of</span>
<span class="sd">                        the tuple are deleted.</span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">            invert (bool):</span>
<span class="sd">                Specifies whether to invert the logic of the test to delete a row. If True, keep the rows</span>
<span class="sd">                that would have been deleted otherwise.</span>

<span class="sd">        Returns:</span>
<span class="sd">            self:</span>
<span class="sd">                The current :py:class:`DataFile` object</span>

<span class="sd">        Note:</span>
<span class="sd">            If col is None, then all rows with masked data are deleted</span>

<span class="sd">            if *col* is callable then it is passed each row as a :py:class:`DataArray` and if it returns</span>
<span class="sd">            True, then the row will be deleted or kept depending on the value of *invert*.</span>

<span class="sd">            If *val* is a callable it should take two arguments - a float and a</span>
<span class="sd">            list. The float is the value of the current row that corresponds to column col abd the second</span>
<span class="sd">            argument is the current row.</span>

<span class="sd">        Todo:</span>
<span class="sd">            Implement val is a tuple for deletinging in a range of values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">mask_rows</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">compress_rows</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="nb">slice</span><span class="p">)</span> <span class="ow">and</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># delete rows with a slice to make a list of indices</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
                <span class="n">col</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">*</span><span class="n">indices</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">callable</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="ow">and</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Delete rows usinga callalble taking the whole row</span>
                <span class="n">col</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">i</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">()</span> <span class="k">if</span> <span class="n">col</span><span class="p">(</span><span class="n">r</span><span class="p">)]</span>
            <span class="k">elif</span> <span class="n">isIterable</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="ow">and</span> <span class="n">all_type</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>  <span class="c1"># Delete rows by a list of booleans</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                    <span class="n">col</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">col</span><span class="p">)))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
                <span class="k">return</span> <span class="bp">self</span>
            <span class="k">if</span> <span class="n">isIterable</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="ow">and</span> <span class="n">all_type</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">int_types</span><span class="p">)</span> <span class="ow">and</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">invert</span><span class="p">:</span>
                <span class="n">col</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">col</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">del_rows</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">all_type</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">int_types</span><span class="p">)</span> <span class="ow">and</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">invert</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">col</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">del_rows</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">int_types</span><span class="p">)</span> <span class="ow">and</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">invert</span><span class="p">:</span>
                <span class="n">tmp_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span>
                <span class="n">tmp_setas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_setas</span><span class="o">.</span><span class="n">clone</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">tmp_mask</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_setas</span> <span class="o">=</span> <span class="n">tmp_setas</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">int_types</span><span class="p">)</span> <span class="ow">and</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">invert</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">del_rows</span><span class="p">([</span><span class="n">c</span><span class="p">],</span> <span class="n">invert</span><span class="o">=</span><span class="n">invert</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_col</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
                    <span class="n">rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span>
                        <span class="p">[(</span><span class="nb">bool</span><span class="p">(</span><span class="n">val</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">x</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">bool</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span><span class="p">))</span> <span class="o">!=</span> <span class="n">invert</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
                    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                    <span class="n">rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">([</span><span class="nb">bool</span><span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="n">val</span><span class="p">)</span> <span class="o">!=</span> <span class="n">invert</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">d</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">isIterable</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">upper</span><span class="p">,</span> <span class="n">lower</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">val</span><span class="p">)),</span> <span class="nb">min</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
                    <span class="n">rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">([</span><span class="nb">bool</span><span class="p">(</span><span class="n">lower</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">upper</span><span class="p">)</span> <span class="o">!=</span> <span class="n">invert</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">d</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span>
                        <span class="s2">&quot;If val is specified it must be a float,callable, or iterable object of length 2&quot;</span>
                    <span class="p">)</span>
                <span class="n">tmp_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span>
                <span class="n">tmp_setas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_setas</span><span class="o">.</span><span class="n">clone</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">tmp_mask</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_setas</span> <span class="o">=</span> <span class="n">tmp_setas</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="DataFile.dir"><a class="viewcode-back" href="../../classes/Stoner.Core.DataFile.dir.html#Stoner.Core.DataFile.dir">[docs]</a>    <span class="k">def</span> <span class="nf">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of keys in the metadata, filtering wiht a regular expression if necessary.</span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">            pattern (string or re):</span>
<span class="sd">                is a regular expression or None to list all keys</span>

<span class="sd">        Returns:</span>
<span class="sd">            list:</span>
<span class="sd">                A list of metadata keys.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pattern</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">_pattern_type</span><span class="p">):</span>
            <span class="n">test</span> <span class="o">=</span> <span class="n">pattern</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">test</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
        <span class="n">possible</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">test</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">possible</span></div>

<div class="viewcode-block" id="DataFile.filter"><a class="viewcode-back" href="../../classes/Stoner.Core.DataFile.filter.html#Stoner.Core.DataFile.filter">[docs]</a>    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the mask on rows of data by evaluating a function for each row.</span>

<span class="sd">        Args:</span>
<span class="sd">            func (callable):</span>
<span class="sd">                is a callable object that should take a single list as a p[arameter representing one row.</span>
<span class="sd">            cols (list):</span>
<span class="sd">                a list of column indices that are used to form the list of values passed to func.</span>
<span class="sd">            reset (bool):</span>
<span class="sd">                determines whether the mask is reset before doing the filter (otherwise rows already</span>
<span class="sd">                masked out will be ignored in the filter (so the filter is logically or&#39;d)) The default value of</span>
<span class="sd">                None results in a complete row being passed into func.</span>

<span class="sd">        Returns:</span>
<span class="sd">            self: The current :py:class:`DataFile` object with the mask set</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cols</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">find_col</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">reset</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">cols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">func</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">func</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">cols</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="DataFile.get_filename"><a class="viewcode-back" href="../../classes/Stoner.Core.DataFile.get_filename.html#Stoner.Core.DataFile.get_filename">[docs]</a>    <span class="k">def</span> <span class="nf">get_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Force the user to choose a new filename using a system dialog box.</span>

<span class="sd">        Args:</span>
<span class="sd">            mode (string):</span>
<span class="sd">                The mode of file operation to be used when calling the dialog box</span>

<span class="sd">        Returns:</span>
<span class="sd">            str:</span>
<span class="sd">                The new filename</span>

<span class="sd">        Note:</span>
<span class="sd">            The filename attribute of the current instance is updated by this method as well.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__file_dialog</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span></div>

<div class="viewcode-block" id="DataFile.insert_rows"><a class="viewcode-back" href="../../classes/Stoner.Core.DataFile.insert_rows.html#Stoner.Core.DataFile.insert_rows">[docs]</a>    <span class="k">def</span> <span class="nf">insert_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">new_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Insert new_data into the data array at position row. This is a wrapper for numpy.insert.</span>

<span class="sd">        Args:</span>
<span class="sd">            row (int):</span>
<span class="sd">                Data row to insert into</span>
<span class="sd">            new_data (numpy array):</span>
<span class="sd">                An array with an equal number of columns as the main data array containing the new row(s) of</span>
<span class="sd">                data to insert</span>

<span class="sd">        Returns:</span>
<span class="sd">            self:</span>
<span class="sd">                A copy of the modified :py:class:`DataFile` object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">new_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="DataFile.load"><a class="viewcode-back" href="../../classes/Stoner.Core.DataFile.load.html#Stoner.Core.DataFile.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load the :py:class:`DataFile` in from disc guessing a better subclass if necessary.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (string or None):</span>
<span class="sd">                path to file to load</span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">            auto_load (bool):</span>
<span class="sd">                If True (default) then the load routine tries all the subclasses of :py:class:`DataFile` in turn to</span>
<span class="sd">                load the file</span>
<span class="sd">            filetype (:py:class:`DataFile`, str):</span>
<span class="sd">                If not none then tries using filetype as the loader.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (DataFile):</span>
<span class="sd">                A copy of the loaded :py:data:`DataFile` instance</span>

<span class="sd">        Note:</span>
<span class="sd">            Possible subclasses to try and load from are identified at run time using the speciall</span>
<span class="sd">            :py:attr:`DataFile.subclasses` attribute.</span>

<span class="sd">            If *filetupe* is a string, then it is first tried as an exact match to a subclass name, otherwise it</span>
<span class="sd">            is used as a partial match and the first class in priority order is that matches is used.</span>

<span class="sd">            Some subclasses can be found in the :py:mod:`Stoner.FileFormats` module.</span>

<span class="sd">            Each subclass is scanned in turn for a class attribute priority which governs the order in which they</span>
<span class="sd">            are tried. Subclasses which can make an early positive determination that a file has the correct format</span>
<span class="sd">            can have higher priority levels. Classes should return a suitable expcetion if they fail to load the file.</span>

<span class="sd">            If not class can load a file successfully then a RunttimeError exception is raised.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">kargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;filename&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">filetype</span> <span class="o">=</span> <span class="n">kargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;filetype&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">auto_load</span> <span class="o">=</span> <span class="n">kargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;auto_load&quot;</span><span class="p">,</span> <span class="n">filetype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filetype</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>  <span class="c1"># We can specify filetype as part of name</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">filetype</span> <span class="o">=</span> <span class="n">DataFile</span><span class="o">.</span><span class="n">subclasses</span><span class="p">[</span><span class="n">filetype</span><span class="p">]</span>  <span class="c1"># pylint: disable=E1136</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">DataFile</span><span class="o">.</span><span class="n">subclasses</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  <span class="c1"># pylint: disable=E1136, E1101</span>
                    <span class="k">if</span> <span class="n">filetype</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                        <span class="n">filetype</span> <span class="o">=</span> <span class="bp">cls</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognised class name for file type: </span><span class="si">{</span><span class="n">filetype</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">):</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__file_dialog</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">IOBase</span><span class="p">):</span>  <span class="c1"># Opened file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot find </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="si">}</span><span class="s2"> to load&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filemagic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">filemagic</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="n">MAGIC_MIME_TYPE</span><span class="p">)</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">mimetype</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">id_filename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mimetype:</span><span class="si">{</span><span class="n">mimetype</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="n">failed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">auto_load</span><span class="p">:</span>  <span class="c1"># We&#39;re going to try every subclass we canA</span>
            <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">DataFile</span><span class="o">.</span><span class="n">subclasses</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>  <span class="c1"># pylint: disable=E1136, E1101</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">filemagic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mimetype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mime_type</span>
                    <span class="p">):</span>  <span class="c1"># short circuit for non-=matching mime-types</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> due to mismatcb mime type </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">mime_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="n">test</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="ow">and</span> <span class="n">filemagic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trying: </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> =mimetype </span><span class="si">{</span><span class="n">test</span><span class="o">.</span><span class="n">mime_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="n">test</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">_load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">auto_load</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">test</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Class </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39;s _load returned None !!&quot;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">kargs</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">_kargs</span>
                        <span class="nb">delattr</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="s2">&quot;_kargs&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                        <span class="k">pass</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Passed Load&quot;</span><span class="p">)</span>
                    <span class="n">failed</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">test</span><span class="p">[</span><span class="s2">&quot;Loaded as&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test matadata: </span><span class="si">{</span><span class="n">test</span><span class="o">.</span><span class="n">metadata</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">copy_into</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Self matadata: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="k">break</span>
                <span class="k">except</span> <span class="n">StonerLoadError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed Load: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="si">}</span><span class="s2"> Failed with a uncicode decode error for </span><span class="si">{</span> <span class="n">format_exc</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">StonerUnrecognisedFormat</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Ran out of subclasses to try and load </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> as.&quot;</span>
                    <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; Recognised filetype are:</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">DataFile</span><span class="o">.</span><span class="n">subclasses</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>  <span class="c1"># pylint: disable=E1101</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filetype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">test</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
                <span class="n">test</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">_load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">)</span>
                <span class="n">kargs</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="s2">&quot;_kargs&quot;</span><span class="p">,</span> <span class="n">kargs</span><span class="p">)</span>
                <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;Loaded as&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">data</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>
                <span class="n">failed</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">filetype</span><span class="p">,</span> <span class="n">DataFile</span><span class="p">):</span>
                <span class="n">test</span> <span class="o">=</span> <span class="n">filetype</span><span class="p">()</span>
                <span class="n">test</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">_load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">)</span>
                <span class="n">kargs</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="s2">&quot;_kargs&quot;</span><span class="p">,</span> <span class="n">kargs</span><span class="p">)</span>
                <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;Loaded as&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filetype</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">data</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">column_headers</span>
                <span class="n">failed</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filetype</span><span class="p">,</span> <span class="n">DataFile</span><span class="p">):</span>
                <span class="n">test</span> <span class="o">=</span> <span class="n">filetype</span><span class="o">.</span><span class="n">clone</span>
                <span class="n">test</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">_load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">)</span>
                <span class="n">kargs</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="s2">&quot;_kargs&quot;</span><span class="p">,</span> <span class="n">kargs</span><span class="p">)</span>
                <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;Loaded as&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filetype</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">data</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">column_headers</span>
                <span class="n">failed</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">failed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="s2">&quot;Failed to load file&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">kargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">False</span><span class="p">)):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kargs</span> <span class="o">=</span> <span class="n">kargs</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="DataFile.rename"><a class="viewcode-back" href="../../classes/Stoner.Core.DataFile.rename.html#Stoner.Core.DataFile.rename">[docs]</a>    <span class="k">def</span> <span class="nf">rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_col</span><span class="p">,</span> <span class="n">new_col</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Rename columns without changing the underlying data.</span>

<span class="sd">        Args:</span>
<span class="sd">            old_col (string, int, re):</span>
<span class="sd">                Old column index or name (using standard rules)</span>
<span class="sd">            new_col (string):</span>
<span class="sd">                New name of column</span>

<span class="sd">        Returns:</span>
<span class="sd">            self:</span>
<span class="sd">                A copy of the modified :py:class:`DataFile` instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">old_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_col</span><span class="p">(</span><span class="n">old_col</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span><span class="p">[</span><span class="n">old_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_col</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="DataFile.reorder_columns"><a class="viewcode-back" href="../../classes/Stoner.Core.DataFile.reorder_columns.html#Stoner.Core.DataFile.reorder_columns">[docs]</a>    <span class="k">def</span> <span class="nf">reorder_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">headers_too</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">setas_too</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct a new data array from the original data by assembling the columns in the order given.</span>

<span class="sd">        Args:</span>
<span class="sd">            cols (list of column indices):</span>
<span class="sd">                (referred to the oriignal data set) from which to assemble the new data set</span>
<span class="sd">            headers_too (bool):</span>
<span class="sd">                Reorder the column headers in the same way as the data (defaults to True)</span>
<span class="sd">            setas_too (bool):</span>
<span class="sd">                Reorder the column assignments in the same way as the data (defaults to True)</span>

<span class="sd">        Returns:</span>
<span class="sd">            self:</span>
<span class="sd">                A copy of the modified :py:class:`DataFile` object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">headers_too</span><span class="p">:</span>
            <span class="n">column_headers</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">find_col</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">column_headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span>
        <span class="k">if</span> <span class="n">setas_too</span><span class="p">:</span>
            <span class="n">setas</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">setas</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">find_col</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">setas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setas</span><span class="o">.</span><span class="n">clone</span>

        <span class="n">newdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_col</span><span class="p">(</span><span class="n">cols</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))])</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="n">newdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newdata</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_col</span><span class="p">(</span><span class="n">col</span><span class="p">)]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">DataArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">newdata</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setas</span> <span class="o">=</span> <span class="n">setas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span> <span class="o">=</span> <span class="n">column_headers</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="DataFile.rows"><a class="viewcode-back" href="../../classes/Stoner.Core.DataFile.rows.html#Stoner.Core.DataFile.rows">[docs]</a>    <span class="k">def</span> <span class="nf">rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">not_masked</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterate over rows of data.</span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">            not_masked(bool):</span>
<span class="sd">                If a row is masked and this is true, then don&#39;t return this row.</span>
<span class="sd">            reset (bool):</span>
<span class="sd">                If true then reset the iterator (immediately stops the current iteration without returning any data)./</span>

<span class="sd">        Yields:</span>
<span class="sd">            1D array: Returns the next row of data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">DataArray</span><span class="p">):</span>
                <span class="n">row</span> <span class="o">=</span> <span class="n">DataArray</span><span class="p">([</span><span class="n">row</span><span class="p">])</span>
                <span class="n">row</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="n">ix</span>
                <span class="n">row</span><span class="o">.</span><span class="n">setas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setas</span>
            <span class="k">if</span> <span class="n">ma</span><span class="o">.</span><span class="n">is_masked</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="ow">and</span> <span class="n">not_masked</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">reset</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">row</span></div>

<div class="viewcode-block" id="DataFile.save"><a class="viewcode-back" href="../../classes/Stoner.Core.DataFile.save.html#Stoner.Core.DataFile.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save a string representation of the current DataFile object into the file &#39;filename&#39;.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (string, bool or None):</span>
<span class="sd">                Filename to save data as, if this is None then the current filename for the object is used. If this</span>
<span class="sd">                is not set, then then a file dialog is used. If filename is False then a file dialog is forced.</span>
<span class="sd">            as_loaded (bool,str):</span>
<span class="sd">                If True, then the *Loaded as* key is inspected to see what the original class of the DataFile was</span>
<span class="sd">                and then this class&#39; save method is used to save the data. If a str then</span>
<span class="sd">                the keyword value is interpreted as the name of a subclass of the the current DataFile.</span>

<span class="sd">        Returns:</span>
<span class="sd">            self:</span>
<span class="sd">                The current :py:class:`DataFile` object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">as_loaded</span> <span class="o">=</span> <span class="n">kargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;as_loaded&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">):</span>
            <span class="c1"># now go and ask for one</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__file_dialog</span><span class="p">(</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">as_loaded</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">as_loaded</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;Loaded as&quot;</span> <span class="ow">in</span> <span class="bp">self</span>
            <span class="p">):</span>  <span class="c1"># Use the Loaded as key to find a different save routine</span>
                <span class="bp">cls</span> <span class="o">=</span> <span class="n">DataFile</span><span class="o">.</span><span class="n">subclasses</span><span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;Loaded as&quot;</span><span class="p">]]</span>  <span class="c1"># pylint: disable=unsubscriptable-object</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">as_loaded</span><span class="p">,</span> <span class="n">string_types</span><span class="p">)</span> <span class="ow">and</span> <span class="n">as_loaded</span> <span class="ow">in</span> <span class="n">DataFile</span><span class="o">.</span><span class="n">subclasses</span>
            <span class="p">):</span>  <span class="c1"># pylint: disable=E1136, E1135</span>
                <span class="bp">cls</span> <span class="o">=</span> <span class="n">DataFile</span><span class="o">.</span><span class="n">subclasses</span><span class="p">[</span><span class="n">as_loaded</span><span class="p">]</span>  <span class="c1"># pylint: disable=unsubscriptable-object</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">as_loaded</span><span class="si">}</span><span class="s2"> cannot be interpreted as a valid sub class of </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; so cannot be used to save this data&quot;</span>
                <span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">filename</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="c1"># Normalise the extension to ensure it&#39;s something we like...</span>
        <span class="n">filename</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;*.</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">DataFile</span><span class="o">.</span><span class="n">patterns</span><span class="p">:</span>  <span class="c1"># pylint: disable=unsupported-membership-test</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="n">DataFile</span><span class="o">.</span><span class="n">patterns</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">:]</span>  <span class="c1"># pylint: disable=unsubscriptable-object</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;TDI Format 1.5&quot;</span><span class="p">]</span>
        <span class="n">header</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">header</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="n">mdkeys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mdkeys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">mdremains</span> <span class="o">=</span> <span class="n">mdkeys</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:]</span>
            <span class="n">mdkeys</span> <span class="o">=</span> <span class="n">mdkeys</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mdremains</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mdtext</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">mdkeys</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mdtext</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">mdtext</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mdtext</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">mdtext</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">))</span>
        <span class="n">data_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">mdtext</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">])</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data_out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">data_out</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">fmt</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">mdremains</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str2bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">))</span>  <span class="c1"># (str2bytes(self.metadata.export(k) + &quot;\n&quot;))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="DataFile.swap_column"><a class="viewcode-back" href="../../classes/Stoner.Core.DataFile.swap_column.html#Stoner.Core.DataFile.swap_column">[docs]</a>    <span class="k">def</span> <span class="nf">swap_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">swp</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Swap pairs of columns in the data.</span>

<span class="sd">        Useful for reordering data for idiot programs that expect columns in a fixed order.</span>

<span class="sd">        Args:</span>
<span class="sd">            swp  (tuple of list of tuples of two elements):</span>
<span class="sd">                Each element will be iused as a column index (using the normal rules</span>
<span class="sd">                for matching columns).  The two elements represent the two</span>
<span class="sd">                columns that are to be swapped.</span>
<span class="sd">            headers_too (bool):</span>
<span class="sd">                Indicates the column headers are swapped as well</span>

<span class="sd">        Returns:</span>
<span class="sd">            self:</span>
<span class="sd">                A copy of the modified :py:class:`DataFile` objects</span>

<span class="sd">        Note:</span>
<span class="sd">            If swp is a list, then the function is called recursively on each</span>
<span class="sd">            element of the list. Thus in principle the @swp could contain</span>
<span class="sd">            lists of lists of tuples</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">swap_column</span><span class="p">(</span><span class="o">*</span><span class="n">swp</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="DataFile.to_pandas"><a class="viewcode-back" href="../../classes/Stoner.Core.DataFile.to_pandas.html#Stoner.Core.DataFile.to_pandas">[docs]</a>    <span class="k">def</span> <span class="nf">to_pandas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a pandas DataFrame from a :py:class:`Stoner.Data` object.</span>

<span class="sd">        Notes:</span>
<span class="sd">            In addition to transferring the numerical data, the DataFrame&#39;s columns are set to</span>
<span class="sd">            a multi-level index of the :py:attr:`Stoner.Data.column_headers` and :py:attr:`Stoner.Data.setas`</span>
<span class="sd">            calues. A pandas DataFrame extension attribute, *metadata* is registered and is used to store</span>
<span class="sd">            the metada from the :py:class:1Stoner.Data` object. This pandas extension attribute is in fact a trivial</span>
<span class="sd">            subclass of the :py:class:`Stoner.core.typeHintedDict`.</span>

<span class="sd">            The inverse operation can be carried out simply by passing a DataFrame into the copnstructor of the</span>
<span class="sd">            :py:class:`Stoner.Data` object.</span>

<span class="sd">        Raises:</span>
<span class="sd">            **NotImplementedError** if pandas didn&#39;t import correctly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Pandas not available&quot;</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">column_headers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setas</span><span class="p">]),</span> <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Headers&quot;</span><span class="p">,</span> <span class="s2">&quot;Setas&quot;</span><span class="p">))</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">idx</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/StonerLogo2.png" alt="Logo"/>
            </a></p>
<form class="search" action="../../search.html" method="get">
  <input type="text" name="q"
   placeholder="type to search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <div class="related bottom">
  <nav id="rellinks">
    <ul>
    </ul>
  </nav>
  <nav id="breadcrumbs">
    <ul>
      <li><a href="../../index.html">Stoner Package</a></li>
      <li>
        <a href="../index.html">Module code</a>
      </li> 
    </ul>
  </nav>
  </div>
  <footer id="pagefooter">&copy; 2013-15, Gavin Burnell et al.Last updated on Apr 13, 2020.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a>
      2.4.4
        with the <a href="http://github.com/irskep/sphinx-better-theme">
          better</a> theme.

  </footer>

  
  </body>
</html>