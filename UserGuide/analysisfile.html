<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Analysing Data Files &mdash; Stoner Pacakge API Documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="Stoner Pacakge API Documentation" href="../index.html" />
    <link rel="up" title="The Stoner Python Package User Guide" href="ugindex.html" />
    <link rel="next" title="Working with Lots of Files" href="datafolder.html" />
    <link rel="prev" title="Plotting Data" href="plotfile.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="datafolder.html" title="Working with Lots of Files"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="plotfile.html" title="Plotting Data"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Stoner Package</a> &raquo;</li>
          <li><a href="ugindex.html" accesskey="U">The Stoner Python Package User Guide</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="analysing-data-files">
<h1>Analysing Data Files<a class="headerlink" href="#analysing-data-files" title="Permalink to this headline">¶</a></h1>
<div class="section" id="normalising-and-basic-maths-operations">
<h2>Normalising and Basic Maths Operations<a class="headerlink" href="#normalising-and-basic-maths-operations" title="Permalink to this headline">¶</a></h2>
<p>Several methods are provided to assist with common data fitting and preparation tasks, such as normalising columns,
adding and subtracting columns.:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">a</span><span class="o">.</span><span class="n">normalise</span><span class="p">(</span><span class="s">&#39;data&#39;</span><span class="p">,</span><span class="s">&#39;reference&#39;</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="s">&#39;Normalised Data&#39;</span><span class="p">,</span><span class="n">replace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">normalise</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">normalise</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">3.141592654</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">normalise</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">a2</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.normalise.html#Stoner.Analysis.AnalyseFile.normalise" title="Stoner.Analysis.AnalyseFile.normalise"><tt class="xref py py-meth docutils literal"><span class="pre">AnalyseFile.normalise()</span></tt></a> method simply divides the data column by the reference column. By default the normalise method
replaces the data column with the new (normalised) data and appends &#8216;(norm)&#8217; to the column header. The keyword arguments
<em>header</em> and <em>replace</em> can override this behaviour. The third variant illustrates normalising to a constant
(note, however, that if the second argument is an integer it is treated as a column index and not a constant).
The final variant takes a 1D array with the same number of elements as rows and uses that to normalise to.
A typical example might be to have some baseline scan that one is normalising to.:</p>
<div class="highlight-python"><div class="highlight"><pre>a.subtract(&#39;A&#39;,&#39;B&#39;m header=&quot;A-B&quot;,replace=True)
a.subtract(0,1)
a.subtract(0,3.141592654)
a.subtract(0,a2.column(0))
</pre></div>
</div>
<p>As one might expect form the name, the <a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.subtract.html#Stoner.Analysis.AnalyseFile.subtract" title="Stoner.Analysis.AnalyseFile.subtract"><tt class="xref py py-meth docutils literal"><span class="pre">AnalyseFile.subtract()</span></tt></a> method subtracts the second column form the first.
Unlike <a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.normalise.html#Stoner.Analysis.AnalyseFile.normalise" title="Stoner.Analysis.AnalyseFile.normalise"><tt class="xref py py-meth docutils literal"><span class="pre">AnalyseFile.normalise()</span></tt></a> the first data column will not be replaced but a new column inserted and a new header
(defaulting to &#8216;column header 1 - column header 2&#8217;) will be created. This can be overridden with the <em>header</em> and <em>replace</em>
keyword arguments. The next two variants of the <a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.subtract.html#Stoner.Analysis.AnalyseFile.subtract" title="Stoner.Analysis.AnalyseFile.subtract"><tt class="xref py py-meth docutils literal"><span class="pre">AnalyseFile.subtract()</span></tt></a> method work in an analogous manner to the
<a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.normalise.html#Stoner.Analysis.AnalyseFile.normalise" title="Stoner.Analysis.AnalyseFile.normalise"><tt class="xref py py-meth docutils literal"><span class="pre">AnalyseFile.normalise()</span></tt></a> methods. Finally the <a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.add.html#Stoner.Analysis.AnalyseFile.add" title="Stoner.Analysis.AnalyseFile.add"><tt class="xref py py-meth docutils literal"><span class="pre">AnalyseFile.add()</span></tt></a> method allows one to add two columns in a
similar fashion:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">a</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;A&#39;</span><span class="p">,</span><span class="s">&#39;B&#39;</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="s">&#39;A plus B&#39;</span><span class="p">,</span><span class="n">replace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">3.141592654</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">a2</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
</pre></div>
</div>
<p>For completeness we also have:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">a</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="s">&#39;A&#39;</span><span class="p">,</span><span class="s">&#39;B&#39;</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="s">&#39;A/B&#39;</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="s">&#39;A&#39;</span><span class="p">,</span><span class="s">&#39;B&#39;</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="s">&#39;A*B&#39;</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>with variants that take either a 1D array of data or a constant instead of the B column index.</p>
<p>One might wish to split a single data file into several different data files each with the rows of the original
that have a common unique value in one data column, or for which some function of the complete row determines which datafile
each row belongs in. The <a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.split.html#Stoner.Analysis.AnalyseFile.split" title="Stoner.Analysis.AnalyseFile.split"><tt class="xref py py-meth docutils literal"><span class="pre">AnalyseFile.split()</span></tt></a> method is useful for this case.:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;Polarisation&#39;</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;Temperature&#39;</span><span class="p">,</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">r</span><span class="p">:</span><span class="n">x</span><span class="o">&gt;</span><span class="mi">100</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">([</span><span class="s">&#39;Temperature&#39;</span><span class="p">,</span><span class="s">&#39;Polarisation&#39;</span><span class="p">],[</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">r</span><span class="p">:</span><span class="n">x</span><span class="o">&gt;</span><span class="mi">100</span><span class="p">,</span><span class="bp">None</span><span class="p">])</span>
</pre></div>
</div>
<p>In these examples we assume the <a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.html#Stoner.Analysis.AnalyseFile" title="Stoner.Analysis.AnalyseFile"><tt class="xref py py-class docutils literal"><span class="pre">AnalyseFile</span></tt></a> has a data column &#8216;Polarisation&#8217; that takes two (or more) discrete values
and a column &#8216;Temperature&#8217; that contains numbers above and below 100.</p>
<p>The first example would return a <a class="reference internal" href="../classes/Stoner.Folders.DataFolder.html#Stoner.Folders.DataFolder" title="Stoner.Folders.DataFolder"><tt class="xref py py-class docutils literal"><span class="pre">Stoner.Folders.DataFolder</span></tt></a> object  containing two separate isntances of <a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.html#Stoner.Analysis.AnalyseFile" title="Stoner.Analysis.AnalyseFile"><tt class="xref py py-class docutils literal"><span class="pre">AnalyseFile</span></tt></a>  which
would each contain the rows from the original data that had each unique value of the polarisation data. The second example would
produce a <a class="reference internal" href="../classes/Stoner.Folders.DataFolder.html#Stoner.Folders.DataFolder" title="Stoner.Folders.DataFolder"><tt class="xref py py-class docutils literal"><span class="pre">Stoner.Folders.DataFolder</span></tt></a> object containing two <a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.html#Stoner.Analysis.AnalyseFile" title="Stoner.Analysis.AnalyseFile"><tt class="xref py py-class docutils literal"><span class="pre">AnalyseFile</span></tt></a> objects for the rows with temperature above and below 100.
The final example will result in a <a class="reference internal" href="../classes/Stoner.Folders.DataFolder.html#Stoner.Folders.DataFolder" title="Stoner.Folders.DataFolder"><tt class="xref py py-class docutils literal"><span class="pre">Stoner.Folders.DataFolder</span></tt></a> object that has two groups each of which contains
<a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.html#Stoner.Analysis.AnalyseFile" title="Stoner.Analysis.AnalyseFile"><tt class="xref py py-class docutils literal"><span class="pre">AnalyseFile</span></tt></a> objects for each polarisation value.</p>
</div>
<div class="section" id="curve-fitting">
<h2>Curve Fitting<a class="headerlink" href="#curve-fitting" title="Permalink to this headline">¶</a></h2>
<div class="section" id="simple-polynomial-fits">
<h3>Simple polynomial Fits<a class="headerlink" href="#simple-polynomial-fits" title="Permalink to this headline">¶</a></h3>
<p>Simple least squares fitting of polynomial functions is handled by the
<a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.polyfit.html#Stoner.Analysis.AnalyseFile.polyfit" title="Stoner.Analysis.AnalyseFile.polyfit"><tt class="xref py py-meth docutils literal"><span class="pre">AnalyseFile.polyfit()</span></tt></a> method:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">a</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">column_x</span><span class="p">,</span><span class="n">column_y</span><span class="p">,</span><span class="n">polynomial_order</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span><span class="n">result</span><span class="o">=</span><span class="s">&quot;New Column&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This is a simple pass through to the numpy routine of the same name. The x and y
columns are specified in the first two arguments using the usual index rules for
the Stoner package. The routine will fit multiple columns if <em>column_y</em>
is a list or slice. The <em>polynomial_order</em> parameter should be a simple integer
greater or equal to 1 to define the degree of polynomial to fit. The <em>bounds</em>
function follows the same rules as the <em>bounds</em> function in
<a class="reference internal" href="../classes/Stoner.Core.DataFile.search.html#Stoner.Core.DataFile.search" title="Stoner.Core.DataFile.search"><tt class="xref py py-meth docutils literal"><span class="pre">Stoner.Core.DataFile.search()</span></tt></a> to restrict the fitting to a limited range of rows. The
method returns a list of coefficients with the highest power first. If
<em>column_y</em> was a list, then a 2D array of coefficients is returned.</p>
<p>If <em>result</em> is specified then a new column with the header given by the <em>result</em> parameter will be
created and the fitted polynomial evaluated at each point.</p>
</div>
<div class="section" id="simple-function-fitting">
<h3>Simple function fitting<a class="headerlink" href="#simple-function-fitting" title="Permalink to this headline">¶</a></h3>
<p>For more general curve fitting operations the <a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.curve_fit.html#Stoner.Analysis.AnalyseFile.curve_fit" title="Stoner.Analysis.AnalyseFile.curve_fit"><tt class="xref py py-meth docutils literal"><span class="pre">AnalyseFile.curve_fit()</span></tt></a>
method can be employed. Again, this is a pass through to the numpy routine of
the same name.:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">a</span><span class="o">.</span><span class="n">curve_fit</span><span class="p">(</span><span class="n">func</span><span class="p">,</span>  <span class="n">xcol</span><span class="p">,</span> <span class="n">ycol</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">bounds</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">replace</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="s">&quot;New Column&quot;</span> <span class="p">)</span>
</pre></div>
</div>
<p>The first parameter is the fitting function. This should have prototype
<tt class="docutils literal"><span class="pre">y=func(x,p[0],p[1],p[2]...)</span></tt>: where <em>p</em> is a list of fitting parameters.
The <em>p0</em> parameter contains the initial guesses at the fitting
parameters, the default value is 1. <em>xcol</em> and <em>ycol</em> are the x
and y columns to fit. This method cannot handle multiple y columns.
<em>sigma</em>, if present, provides the weightings for each datapoint and so
should also be an array of the same length as the x and y data. Fianlly, the
<em>bounds</em> function can be used to restrict the fitting to only a subset of the rows
of data.</p>
<p><a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.curve_fit.html#Stoner.Analysis.AnalyseFile.curve_fit" title="Stoner.Analysis.AnalyseFile.curve_fit"><tt class="xref py py-meth docutils literal"><span class="pre">AnalyseFile.curve_fit()</span></tt></a> returns a list of two arrays <tt class="docutils literal"><span class="pre">[popt,pcov]</span></tt>:
where <em>popt</em> is an array of the optimal fitting parameters and
<em>pcov</em> is a 2D array of the co-variances between the parameters.</p>
<p>If <em>result</em> is not <strong>None</strong> then the fitted data is added to the <a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.html#Stoner.Analysis.AnalyseFile" title="Stoner.Analysis.AnalyseFile"><tt class="xref py py-class docutils literal"><span class="pre">AnalyseFile</span></tt></a>
object. Where it is added depends on the combination of the <em>result</em>, <em>replace</em>
and <em>header</em> parameters. If <em>result</em> is a string or integer it is interpreted as a column
index at which the fitted data will be inserted (<em>replace</em> <strong>False</strong>) or overwritten over the existing data (<em>replace</em> <strong>True</strong>).
The fitted data will be given the column header <em>header</em> unless <em>header</em> is not a string, in which ase the column
will be called &#8216;Fitted with &#8216; and the name of the function <em>func</em>.</p>
</div>
<div class="section" id="fitting-with-limits">
<h3>Fitting with limits<a class="headerlink" href="#fitting-with-limits" title="Permalink to this headline">¶</a></h3>
<p>The Stoner package has a number of alternative fitting mechanisms that supplement the standard
<tt class="xref py py-func docutils literal"><span class="pre">scipy.optimize.curve_fit()</span></tt> function. New in version 0.2 onwards of the Package is an interface to the
<em>lmfit</em> module.</p>
<div class="section" id="non-linear-curve-fitting-with-lmfit">
<h4>Non-linear curve fitting with lmfit<a class="headerlink" href="#non-linear-curve-fitting-with-lmfit" title="Permalink to this headline">¶</a></h4>
<p>lmfit provides a flexible way to fit complex models to experimental data in a pythonesque object-orientated fashion.
A full description of the lmfit module is given in the <a class="reference external" href="href=http://lmfit.github.io/lmfit-py/">lmffit documentation</a>. . The
<a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.lmfit.html#Stoner.Analysis.AnalyseFile.lmfit" title="Stoner.Analysis.AnalyseFile.lmfit"><tt class="xref py py-meth docutils literal"><span class="pre">AnalyseFile.lmfit()</span></tt></a> method is used to interact with lmfit.</p>
<p>In order to use <a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.lmfit.html#Stoner.Analysis.AnalyseFile.lmfit" title="Stoner.Analysis.AnalyseFile.lmfit"><tt class="xref py py-meth docutils literal"><span class="pre">AnalyseFile.lmfit()</span></tt></a>, one requires a c instance. This describes a function
and its independent and fittable parameters, whether they have limits and what the limits are. The <tt class="xref py py-mod docutils literal"><span class="pre">Stoner.Fit</span></tt> module contains
a series of :py:class:lmfit.model.Model` subclasses that represent various models used in condensed matter physics.</p>
<p>The operation of <a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.lmfit.html#Stoner.Analysis.AnalyseFile.lmfit" title="Stoner.Analysis.AnalyseFile.lmfit"><tt class="xref py py-meth docutils literal"><span class="pre">AnalyseFile.lmfit()</span></tt></a> is very similar to that of <a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.curve_fit.html#Stoner.Analysis.AnalyseFile.curve_fit" title="Stoner.Analysis.AnalyseFile.curve_fit"><tt class="xref py py-meth docutils literal"><span class="pre">AnalyseFile.curve_fit()</span></tt></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">Stoner.Fit</span> <span class="kn">import</span> <span class="n">Arrehenius</span>
<span class="n">model</span><span class="o">=</span><span class="n">Arrehenius</span><span class="p">(</span><span class="n">A</span><span class="o">=</span><span class="mf">1E7</span><span class="p">,</span><span class="n">DE</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<span class="n">fit</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">lmfit</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">xcol</span><span class="o">=</span><span class="s">&quot;Temp&quot;</span><span class="p">,</span><span class="n">ycol</span><span class="o">=</span><span class="s">&quot;Cond&quot;</span><span class="p">,</span><span class="n">result</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="s">&quot;Fit&quot;</span><span class="p">)</span>
<span class="k">print</span> <span class="n">fit</span><span class="o">.</span><span class="n">fit_report</span><span class="p">()</span>
<span class="k">print</span> <span class="n">a</span><span class="p">[</span><span class="s">&quot;A&quot;</span><span class="p">],</span><span class="n">a</span><span class="p">[</span><span class="s">&quot;A_err&quot;</span><span class="p">],</span><span class="n">a</span><span class="p">[</span><span class="s">&quot;chi^2&quot;</span><span class="p">],</span><span class="n">a</span><span class="p">[</span><span class="s">&quot;nfev&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>In this example we would be fitting an Arrehenius model to data contained inthe &#8216;Temp&#8217; and &#8216;Cond&#8217; columns. The resulting
fit would be added as an additional colum called fit. In addition, details of the fit are added as metadata to the current <a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.html#Stoner.Analysis.AnalyseFile" title="Stoner.Analysis.AnalyseFile"><tt class="xref py py-class docutils literal"><span class="pre">AnalyseFile</span></tt></a>.</p>
<p>The return value from <a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.lmfit.html#Stoner.Analysis.AnalyseFile.lmfit" title="Stoner.Analysis.AnalyseFile.lmfit"><tt class="xref py py-meth docutils literal"><span class="pre">AnalyseFile.lmfit()</span></tt></a> is controlled by the <em>output</em> keyword parameter. By default it is the <tt class="xref py py-class docutils literal"><span class="pre">lmfit.model.ModelFit</span></tt>
instance. This contains all the information about the fit and fitting process.</p>
</div>
<div class="section" id="non-linear-curve-fitting-with-mpfit">
<h4>Non-linear curve fitting with mpfit<a class="headerlink" href="#non-linear-curve-fitting-with-mpfit" title="Permalink to this headline">¶</a></h4>
<p>Current versions of the Stoner Package contain a second constrained non-linear fitting package, <em>mpfit</em>.</p>
<p>This is also suitable for cases where one requires more flexibility in fitting data, in particular
where the fitting parameters are constrained, the module is accessed thrpugh the <a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.mpfit.html#Stoner.Analysis.AnalyseFile.mpfit" title="Stoner.Analysis.AnalyseFile.mpfit"><tt class="xref py py-meth docutils literal"><span class="pre">AnalyseFile.mpfit()</span></tt></a>
method. This is a pass through to the <tt class="xref py py-mod docutils literal"><span class="pre">Stoner.mpfit</span></tt> module.:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">a</span><span class="o">.</span><span class="n">mpfit</span><span class="p">(</span><span class="n">func</span><span class="p">,</span>  <span class="n">xcol</span><span class="p">,</span> <span class="n">ycol</span><span class="p">,</span> <span class="n">p_info</span><span class="p">,</span>  <span class="n">func_args</span><span class="o">=</span><span class="nb">dict</span><span class="p">(),</span> <span class="n">sigma</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">bounds</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">mpfit_kargs</span> <span class="p">)</span>
</pre></div>
</div>
<p>In this case, the <em>func</em> argument takes a slightly different
prototype:<tt class="docutils literal"><span class="pre">def</span> <span class="pre">func(x,parameters,</span> <span class="pre">**func_args)</span></tt> where <em>parameters</em>
is a list of the fitting parameters and <em>func_args</em> provides a
dictionary of fixed ie non-fitting parameters. <em>xcol</em> and <em>ycol</em>
are the column indices for the x and y data, <em>bounds</em> is a bounding
function to select only those rows to use for fitting the function, and
<em>sigma</em> are the weightings for each data-point. The remaining arguments
are a dictionary of keywords to pass through to the <tt class="xref py py-mod docutils literal"><span class="pre">Stoner.mpfit</span></tt> routine and
<em>p_info</em> which is a list of dictionaries which is used to control the
parameters in the fit. This described below.</p>
<p><em>p_info</em> contains one element for each parameter used to fit the data.
Each element is a dictionary with the following keys:</p>
<ul>
<li><dl class="first docutils">
<dt>[value] the starting parameter value (but see the START_PARAMS parameter</dt>
<dd><p class="first last">for more information).</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>[fixed] a boolean value, whether the parameter is to be held fixed or</dt>
<dd><p class="first last">not.  Fixed parameters are not varied by MPFIT, but are passed on to MYFUNCT for
evaluation.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>[limited] a two-element boolean array.  If the first/second element is</dt>
<dd><p class="first last">set, then the parameter is bounded on the lower/upper side.  A parameter can be
bounded on both sides.  Both LIMITED and LIMITS must be given together.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>[limits] a two-element float array.  Gives the parameter limits on the</dt>
<dd><p class="first last">lower and upper sides, respectively.  Zero, one or two of these values can be
set, depending on the values of LIMITED.  Both LIMITED and LIMITS must be given
together.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>[parname] a string, giving the name of the parameter.  The fitting code</dt>
<dd><p class="first last">of MPFIT does not use this tag in any way.  However, the default iterfunct will
print the parameter name if available.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>[step] the step size to be used in calculating the numerical derivatives.</dt>
<dd><p class="first last">If set to zero, then the step size is    computed automatically.  Ignored when
AUTODERIVATIVE=0.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>[mpside] the sidedness of the finite difference when computing numerical</dt>
<dd><blockquote class="first">
<div><p>derivatives.  This field can take four values:</p>
</div></blockquote>
<ul class="last">
<li><p class="first">[0]one-sided derivative computed automatically</p>
</li>
<li><p class="first">[1]one-sided derivative <tt class="docutils literal"><span class="pre">(f(x+h)</span> <span class="pre">-</span> <span class="pre">f(x)</span>&nbsp; <span class="pre">)/h</span></tt></p>
</li>
<li><p class="first">[-1] one-sided derivative <tt class="docutils literal"><span class="pre">(f(x)</span>&nbsp;&nbsp; <span class="pre">-</span> <span class="pre">f(x-h))/h</span></tt></p>
</li>
<li><dl class="first docutils">
<dt>[2] two-sided derivative <tt class="docutils literal"><span class="pre">(f(x+h)</span> <span class="pre">-</span> <span class="pre">f(x-h))/(2*h)</span></tt></dt>
<dd><p class="first last">Where H is the STEP parameter described above.  The &#8220;automatic&#8221;
one-sided derivative method will chose a direction for the finite difference
which does not violate any constraints.  The other methods do
not perform this check.  The two-sided method is in principle more precise, but
requires twice as many function evaluations.  <strong>Default: 0</strong>.</p>
</dd>
</dl>
</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>[mpmaxstep] the maximum change to be made in the parameter value.  During</dt>
<dd><p class="first last">the fitting process, the parameter will never be changed by more than this value
in one iteration. A value of 0 indicates no maximum.  <strong>Default: 0</strong>.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>[tied] a string expression which &#8216;ties&#8217; the parameter to other      free or</dt>
<dd><p class="first last">fixed parameters.  Any expression involving      constants and the parameter
array P are permitted.Example: if parameter 2 is always to be twice parameter 1
then use the following: <tt class="docutils literal"><span class="pre">parinfo(2).tied</span> <span class="pre">=</span> <span class="pre">'2</span> <span class="pre">*</span> <span class="pre">p(1)'</span></tt>. Since they are
totally constrained, tied parameters are considered to be fixed; no errors are
computed for them.[ NOTE: the PARNAME can&#8217;t be used in expressions. ]</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>[mpprint] if set to 1, then the default iterfunct will print the</dt>
<dd><p class="first last">parameter value.  If set to 0, the parameter value will not be printed.  This
tag can be used to selectively print only a few parameter values out of
many.**Default: 1** (all parameters printed)</p>
</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="non-linear-curve-fitting-with-initialisation-file">
<h4>Non-linear curve fitting with initialisation file<a class="headerlink" href="#non-linear-curve-fitting-with-initialisation-file" title="Permalink to this headline">¶</a></h4>
<p>If you wish to fit your data to a non-linear function more complicated than a polynomial you can use
<a class="reference internal" href="../classes/Stoner.nlfit.nlfit.html#Stoner.nlfit.nlfit" title="Stoner.nlfit.nlfit"><tt class="xref py py-meth docutils literal"><span class="pre">Stoner.nlfit.nlfit()</span></tt></a> or equivalently if you have an <a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.html#Stoner.Analysis.AnalyseFile" title="Stoner.Analysis.AnalyseFile"><tt class="xref py py-class docutils literal"><span class="pre">AnalyseFile</span></tt></a> instance of your data
you can call <a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.nlfit.html#Stoner.Analysis.AnalyseFile.nlfit" title="Stoner.Analysis.AnalyseFile.nlfit"><tt class="xref py py-meth docutils literal"><span class="pre">AnalyseFile.nlfit()</span></tt></a>. This performs a non-linear least squares fitting algorithm to your data
and returns the <a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.html#Stoner.Analysis.AnalyseFile" title="Stoner.Analysis.AnalyseFile"><tt class="xref py py-class docutils literal"><span class="pre">AnalyseFile</span></tt></a> instance used with an additional final column that is the fit,
it also plots the fit. There is an example run script, ini file and data file in <tt class="docutils literal"><span class="pre">/scripts/</span></tt> in the github repository.
Hhave a look at them to see how to use this function.</p>
<p>The function to fit to can either be created by the user and passed in or one of a library of current existing functions
can be used from the <tt class="xref py py-mod docutils literal"><span class="pre">Stoner.FittingFuncs</span></tt> (just pass in the name of the function you wish to use as a string).
The function takes its fitting parameters information from a .ini file created by the user,
look at the example .ini file mentioned above for the format, you can see that it allows for the parameters to be fixed
or constrained which can be very useful for fitting.</p>
<p>Current functions existing in FittingFunctions.py:</p>
<ul class="simple">
<li>Various tunnelling I-V models including BDR, Simmons, Field emission and Tersoff Hamman STM.</li>
<li>2D weak localisation</li>
<li>Strijkers model for PCAR fitting</li>
</ul>
<p>Please see the function documentation in <tt class="xref py py-mod docutils literal"><span class="pre">Stoner.FittingFuncs</span></tt> for more information about these models.
Please do add functions you think would be of use to everybody, have a look at the current functions for examples,
the main thing is that the function must take an x array and a list of parameters, apply a function and then
return the resulting array.</p>
</div>
</div>
</div>
<div class="section" id="more-analysefile-functions">
<h2>More AnalyseFile Functions<a class="headerlink" href="#more-analysefile-functions" title="Permalink to this headline">¶</a></h2>
<div class="section" id="applying-an-arbitary-function-through-the-data">
<h3>Applying an arbitary function through the data<a class="headerlink" href="#applying-an-arbitary-function-through-the-data" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.apply.html#Stoner.Analysis.AnalyseFile.apply" title="Stoner.Analysis.AnalyseFile.apply"><tt class="xref py py-meth docutils literal"><span class="pre">AnalyseFile.apply()</span></tt></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">a</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">replace</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span>
</pre></div>
</div>
<p>Here <em>func</em> is an arbitrary function that will take a complete row in the form of a numpy 1D array, <em>col</em>
is the index of a column at which the resulting data is to be inserted or overwrite the
existing data (depending on the values of <em>replace</em> and <em>header</em>).</p>
</div>
<div class="section" id="basic-data-inspection">
<h3>Basic Data Inspection<a class="headerlink" href="#basic-data-inspection" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.max.html#Stoner.Analysis.AnalyseFile.max" title="Stoner.Analysis.AnalyseFile.max"><tt class="xref py py-meth docutils literal"><span class="pre">AnalyseFile.max()</span></tt></a> and <a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.min.html#Stoner.Analysis.AnalyseFile.min" title="Stoner.Analysis.AnalyseFile.min"><tt class="xref py py-meth docutils literal"><span class="pre">AnalyseFile.min()</span></tt></a>:</p>
<div class="highlight-python"><div class="highlight"><pre>a.max(column)
a.min(column)
a.max(column,bounds=labda x,y:y[2]&gt;1 and y[2]&lt;10)
a.min(column,bounds=labda x,y:y[2]&gt;1 and y[2]&lt;10)
</pre></div>
</div>
<p>Hopefully all of the above are fairly obvious ! In the last two cases, one can use a function
to limit the search to particular rows (eg to search for the maximum y value subject to some constraint
in x). One important point to note is that the routines return a tuple of two numbers, the maximum (or
minimum) and the row number where the maximum or minimum was found.</p>
<p>There are a couple of related functions to help here:</p>
<div class="highlight-python"><div class="highlight"><pre>a.span(column)
a.span(column, bounds=lambda x,y:y[2]&gt;100)
a.clip(column,(max_v,min_v)
a.clip(column,b.span(column))
</pre></div>
</div>
<p>The <a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.span.html#Stoner.Analysis.AnalyseFile.span" title="Stoner.Analysis.AnalyseFile.span"><tt class="xref py py-meth docutils literal"><span class="pre">AnalyseFile.span()</span></tt></a> method simply returns a tuple of minimum and maximum values within either the whole column or
bounded data. Internally this is just calling the <a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.max.html#Stoner.Analysis.AnalyseFile.max" title="Stoner.Analysis.AnalyseFile.max"><tt class="xref py py-meth docutils literal"><span class="pre">AnalyseFile.max()</span></tt></a> and <a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.min.html#Stoner.Analysis.AnalyseFile.min" title="Stoner.Analysis.AnalyseFile.min"><tt class="xref py py-meth docutils literal"><span class="pre">AnalyseFile.min()</span></tt></a> methods.
The <a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.clip.html#Stoner.Analysis.AnalyseFile.clip" title="Stoner.Analysis.AnalyseFile.clip"><tt class="xref py py-meth docutils literal"><span class="pre">AnalyseFile.clip()</span></tt></a> method deletes rows for which the specified column as a value that is either larger or
smaller than the maximum or minimum value within the second argument. This allows one to specify either a tuple &#8211;
eg the result of the <a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.span.html#Stoner.Analysis.AnalyseFile.span" title="Stoner.Analysis.AnalyseFile.span"><tt class="xref py py-meth docutils literal"><span class="pre">AnalyseFile.span()</span></tt></a> method, or a complete list as in the last example above. Specifying a single
float would have the effect of removing all rows where the column didn&#8217;t equal the float value. This is probably not a good idea...</p>
<p>It is worth pointing out that these functions will respect the existing mask on the data unless the bounds parameter is set,
in which case the mask is temproarily discarded in favour of one generated from the bounds expression. This can be worked around,
however, as the parameter passed to the bounds function is itself a masked array and thus one can include a test of the mask in the
bounds function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">a</span><span class="o">.</span><span class="n">span</span><span class="p">(</span><span class="n">column</span><span class="p">,</span><span class="n">bounds</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">10</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">mask</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="data-reduction-methods">
<h2>Data Reduction Methods<a class="headerlink" href="#data-reduction-methods" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.html#Stoner.Analysis.AnalyseFile" title="Stoner.Analysis.AnalyseFile"><tt class="xref py py-class docutils literal"><span class="pre">AnalyseFile</span></tt></a> offers a number of methods to assist in data reduction and data processing.</p>
<div class="section" id="re-binning-data">
<h3>(Re)Binning Data<a class="headerlink" href="#re-binning-data" title="Permalink to this headline">¶</a></h3>
<p>Data binning is the process of taking approximately continuous (x,y) data and grouping them into &#8220;bins&#8221; of specified x, and average y. Since
this is a data averaging process, the statistical variation in y values is reduced, at the expense of a loss of resolution in x.</p>
<p><a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.html#Stoner.Analysis.AnalyseFile" title="Stoner.Analysis.AnalyseFile"><tt class="xref py py-class docutils literal"><span class="pre">AnalyseFile</span></tt></a> provides a simple <a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.bin.html#Stoner.Analysis.AnalyseFile.bin" title="Stoner.Analysis.AnalyseFile.bin"><tt class="xref py py-meth docutils literal"><span class="pre">AnalyseFile.bin()</span></tt></a> method that can re-bin data:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="n">x_bin</span><span class="p">,</span><span class="n">y_bin</span><span class="p">,</span><span class="n">dy</span><span class="p">)</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">bin</span><span class="p">(</span><span class="n">xcol</span><span class="o">=</span><span class="s">&quot;Q&quot;</span><span class="p">,</span><span class="n">ycol</span><span class="o">=</span><span class="s">&quot;Counts&quot;</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s">&quot;lin&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="n">x_bin</span><span class="p">,</span><span class="n">y_bin</span><span class="p">,</span><span class="n">dy</span><span class="p">)</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">bin</span><span class="p">(</span><span class="n">xcol</span><span class="o">=</span><span class="s">&quot;Q&quot;</span><span class="p">,</span><span class="n">ycol</span><span class="o">=</span><span class="s">&quot;Counts&quot;</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s">&quot;log&quot;</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="s">&quot;dCounts&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="n">x_bin</span><span class="p">,</span><span class="n">y_bin</span><span class="p">,</span><span class="n">dy</span><span class="p">)</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">bin</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s">&quot;log&quot;</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span><span class="n">bin_start</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">bin_stop</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</pre></div>
</div>
<p>The mode parameter controls whether linear binning or logarithmic binning is used. The bins parameter is either an integer
in which case it specifies the number of bins to be used, or a float in which case it specifies the bin width. For logarithmic binning
the bin width for bin n is defined as <span class="math">\(x_n * w\)</span> with <span class="math">\(w\)</span> being the bin width parameter. Thus the bin boundaries are at
<span class="math">\(x_n\)</span> and <span class="math">\(x_{n+1}=x_n(1+w)\)</span> whilst the bin centre is at <span class="math">\(x_n(1+\frac{w}{2})\)</span>. If a number of bins is specified in logarithmic mode
then the bin boundaries are set from equal logspace boundaries.</p>
<p>If the keyword <strong>yerr</strong> is supplied then the y values in each bin are weighted by their respective error bars when calculating the mean. In this case the
error bar on the bin bceomes the quadrature sum of the individual error bars on each point included in the bin. If <strong>yerr</strong> is nopt specified, then the error bar
is the standard error in the y points in the bin and the y value is the simple mean of the data.</p>
<p>If <strong>xcol</strong> and/or <strong>ycol</strong> are not specified, then they are looked up from the <a class="reference internal" href="../classes/Stoner.Core.DataFile.html#Stoner.Core.DataFile.setas" title="Stoner.Core.DataFile.setas"><tt class="xref py py-attr docutils literal"><span class="pre">Stoner.Core.DataFile.setas</span></tt></a> attribute. In this case, the <strong>yerr</strong>
is also taken from this attribute if not specified spearately.</p>
<p>IF the keyword <em>clone</em> is supplied and is False, four 1D numpy arrays are returned, representing the x, y and y-errors for the new bins and the number of
points averaged into each bin.. If <em>clone</em> is True or not provided, <a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.bin.html#Stoner.Analysis.AnalyseFile.bin" title="Stoner.Analysis.AnalyseFile.bin"><tt class="xref py py-meth docutils literal"><span class="pre">AnalyseFile.bin()</span></tt></a> returns a clone of the current data file with its data
(and column headers) replaced with the newly binned data.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">Stoner</span> <span class="kn">import</span> <span class="n">Data</span>
<span class="kn">from</span> <span class="nn">Stoner.plotutils</span> <span class="kn">import</span> <span class="n">errorfill</span>

<span class="n">d</span><span class="o">=</span><span class="n">Data</span><span class="p">(</span><span class="s">&quot;Noisy_Data.txt&quot;</span><span class="p">,</span><span class="n">setas</span><span class="o">=</span><span class="s">&quot;xy&quot;</span><span class="p">)</span>

<span class="n">d</span><span class="o">.</span><span class="n">template</span><span class="o">.</span><span class="n">fig_height</span><span class="o">=</span><span class="mi">6</span>
<span class="n">d</span><span class="o">.</span><span class="n">template</span><span class="o">.</span><span class="n">fig_width</span><span class="o">=</span><span class="mi">8</span>
<span class="n">d</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

<span class="n">e</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">bin</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s">&quot;lin&quot;</span><span class="p">)</span>
<span class="n">f</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">bin</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s">&quot;lin&quot;</span><span class="p">)</span>

<span class="n">e</span><span class="o">.</span><span class="n">fig</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">fig</span>
<span class="n">f</span><span class="o">.</span><span class="n">fig</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">fig</span>

<span class="n">e</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plotter</span><span class="o">=</span><span class="n">errorfill</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;0.05 bins&quot;</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plotter</span><span class="o">=</span><span class="n">errorfill</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;0.25 bins&quot;</span><span class="p">)</span>

<span class="n">d</span><span class="o">.</span><span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Bin demo&quot;</span>
</pre></div>
</div>
<p>(<a class="reference external" href="../samples/bins.py">Source code</a>)</p>
</div>
<div class="section" id="stitching-datasets-together">
<h3>Stitching Datasets together<a class="headerlink" href="#stitching-datasets-together" title="Permalink to this headline">¶</a></h3>
<p>Sometimes a data set is obtained by joing together several separate sets of data,
for example, joinging several scans over different angular or energy ranges to make a single
combinaed scan. In the ideal world, these scans could simple be joing together (e.g. by using the +
operator), in practise one often finds that there are systematic changes in scaling or offsets
between individual scans. The task of stitching data sets together then becomes one of finding the
best mapping between two sets of (x,y) points that are nominally the same. <a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.html#Stoner.Analysis.AnalyseFile" title="Stoner.Analysis.AnalyseFile"><tt class="xref py py-class docutils literal"><span class="pre">AnalyseFile</span></tt></a> provides
a <a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.stitch.html#Stoner.Analysis.AnalyseFile.stitch" title="Stoner.Analysis.AnalyseFile.stitch"><tt class="xref py py-meth docutils literal"><span class="pre">AnalyseFile.stitch()</span></tt></a> method to facilitate this.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">Stoner</span> <span class="kn">import</span> <span class="n">Data</span>

<span class="kn">from</span> <span class="nn">Stoner.Util</span> <span class="kn">import</span> <span class="n">format_error</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>

<span class="c"># Load and plot two sets of data</span>
<span class="n">s1</span><span class="o">=</span><span class="n">Data</span><span class="p">(</span><span class="s">&quot;Stitch-scan1.txt&quot;</span><span class="p">,</span><span class="n">setas</span><span class="o">=</span><span class="s">&quot;xy&quot;</span><span class="p">)</span>
<span class="n">s2</span><span class="o">=</span><span class="n">Data</span><span class="p">(</span><span class="s">&quot;Stitch-scan2.txt&quot;</span><span class="p">,</span><span class="n">setas</span><span class="o">=</span><span class="s">&quot;xy&quot;</span><span class="p">)</span>
<span class="n">s1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Set 1&quot;</span><span class="p">)</span>
<span class="n">s2</span><span class="o">.</span><span class="n">fig</span><span class="o">=</span><span class="n">s1</span><span class="o">.</span><span class="n">fig</span>
<span class="n">s2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Set 2&quot;</span><span class="p">)</span>
<span class="c">#Stitch scan 2 onto scan 1</span>
<span class="n">s2</span><span class="o">.</span><span class="n">stitch</span><span class="p">(</span><span class="n">s1</span><span class="p">)</span>

<span class="n">s2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Stictched&quot;</span><span class="p">)</span>
<span class="n">s2</span><span class="o">.</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Stictching Example&quot;</span>

<span class="c">#Tidy up the plot by adding annotation fo the stirching co-efficients</span>
<span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;A&quot;</span><span class="p">,</span><span class="s">&quot;B&quot;</span><span class="p">,</span><span class="s">&quot;C&quot;</span><span class="p">]</span>
<span class="n">txt</span><span class="o">=</span><span class="p">[]</span>
<span class="n">lead</span><span class="o">=</span><span class="s">r&quot;$x&#39;\rightarrow x+A$&quot;</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">+</span><span class="s">r&quot;$y&#39;=\rightarrow By+C$&quot;</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="k">for</span> <span class="n">l</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span><span class="n">s2</span><span class="p">[</span><span class="s">&quot;Stitching Coefficients&quot;</span><span class="p">],</span><span class="n">s2</span><span class="p">[</span><span class="s">&quot;Stitching Coeffient Errors&quot;</span><span class="p">]):</span>
    <span class="n">txt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">format_error</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">latex</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">l</span><span class="o">+</span><span class="s">&quot;=&quot;</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.7</span><span class="p">,</span><span class="mf">0.65</span><span class="p">,</span><span class="n">lead</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">txt</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</pre></div>
</div>
<p>(<a class="reference external" href="../samples/stitch.py">Source code</a>, <a class="reference external" href="../samples/stitch.png">png</a>, <a class="reference external" href="../samples/stitch.hires.png">hires.png</a>, <a class="reference external" href="../samples/stitch.pdf">pdf</a>)</p>
<div class="figure">
<img alt="../_images/stitch.png" src="../_images/stitch.png" />
</div>
<p>The stitch method can be fine tuned by specifying the possible scaling and shifting operations, overlap
region to use or even a custom stiching transofmration function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">s2</span><span class="o">.</span><span class="n">stitch</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s">&quot;shift x&quot;</span><span class="p">)</span>
<span class="n">s2</span><span class="o">.</span><span class="n">stitch</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s">&quot;scale y, shift x&quot;</span><span class="p">,</span><span class="n">overlap</span><span class="o">=</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span><span class="mf">5.0</span><span class="p">))</span>
<span class="n">s2</span><span class="o">.</span><span class="n">stitch</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span><span class="n">func</span><span class="o">=</span><span class="n">my_stitcher</span><span class="p">,</span><span class="n">p0</span><span class="o">=</span><span class="p">[</span><span class="mf">3.14</span><span class="p">,</span><span class="mf">2.54</span><span class="p">,</span><span class="mf">2.0</span><span class="p">])</span>
</pre></div>
</div>
<p>In these examples, the x and y columns of <em>scan2</em> are modified to give the best
possible match to <em>scan1</em>. If <em>xcol</em> or <em>ycol</em> are not given then the default x and y columns as set py the
<a class="reference internal" href="../classes/Stoner.Core.DataFile.html#Stoner.Core.DataFile.setas" title="Stoner.Core.DataFile.setas"><tt class="xref py py-attr docutils literal"><span class="pre">Stoner.Core.DataFile.setas</span></tt></a> attribute.</p>
<p>The <em>mode</em> keyword can be used to specify the types of scaling operations that are
to be allowed. Teh defaults are to shoft both x and y by an offset value and to rescale
the y data by some factor. If even more control of the transformation is needed,
the <em>func</em> keyword and <em>p0</em> keyword can be used to provide an alternative transformation
function and initial guesses to its parameters. The profotype for the transformation
function should be:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">my_stitcher</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">,</span><span class="n">p3</span><span class="o">...</span><span class="p">,</span><span class="n">pn</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">mapped_x</span><span class="p">,</span><span class="n">mapped_y</span><span class="p">)</span>
</pre></div>
</div>
<p>In addition to changing the X and Y data in the current <a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.html#Stoner.Analysis.AnalyseFile" title="Stoner.Analysis.AnalyseFile"><tt class="xref py py-class docutils literal"><span class="pre">AnalyseFile</span></tt></a>
instance, two new metadata keys, <em>Stitching Coefficient</em> and <em>Stitching Coeffient Errors</em>,
with the co-efficients used to modify the scan data.</p>
</div>
<div class="section" id="thresholding-and-interpolating-data">
<h3>Thresholding and Interpolating Data<a class="headerlink" href="#thresholding-and-interpolating-data" title="Permalink to this headline">¶</a></h3>
<p>Thresholding data is the process of identifying points where y data values cross a given limit (equivalently, finding roots for
<span class="math">\(y=f(x)-y_{threshold}\)</span>). This is carried out by the <a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.threshold.html#Stoner.Analysis.AnalyseFile.threshold" title="Stoner.Analysis.AnalyseFile.threshold"><tt class="xref py py-meth docutils literal"><span class="pre">AnalyseFile.threshold()</span></tt></a> method:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">a</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s">&quot;Y-data&quot;</span><span class="p">,</span> <span class="n">rising</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">falling</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">all_vals</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">xcol</span><span class="o">=</span><span class="s">&quot;X-data&quot;</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">threshold</span><span class="p">)</span>
</pre></div>
</div>
<p>If the parameters <strong>col</strong> and <strong>xcol</strong> are not given, they are determined by the <a class="reference internal" href="../classes/Stoner.Core.DataFile.html#Stoner.Core.DataFile.setas" title="Stoner.Core.DataFile.setas"><tt class="xref py py-attr docutils literal"><span class="pre">Stoner.Core.DataFile.setas</span></tt></a> attribute. The <strong>rising</strong> and <strong>falling</strong>
parameters control whether the y values are rising or falling with row number as they pass the threshold and <strong>all_vals</strong> determines whether the method returns
just the first threshold or all thresholds it can find. The values returned are mapped to the x-column data if it is specified. The thresholding uses just a simple
two point linear fit to find the thresholds.</p>
<p>Interpolating data finds values of y for points x that lie between data points. The <a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.interpolate.html#Stoner.Analysis.AnalyseFile.interpolate" title="Stoner.Analysis.AnalyseFile.interpolate"><tt class="xref py py-meth docutils literal"><span class="pre">AnalyseFile.interpolate()</span></tt></a> provides a simple pass-through to the
scipy routine <tt class="xref py py-func docutils literal"><span class="pre">scipy.optimize.interp1d()</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">a</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">newX</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="s">&#39;linear&#39;</span><span class="p">,</span> <span class="n">xcol</span><span class="o">=</span><span class="s">&quot;X-Data&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The new values of X are set from the mandetory first argument. <strong>kind</strong> can be either &#8220;linear&#8221; or &#8220;cubic&#8221; whilst the xcol data can be omitted in which case the
<a class="reference internal" href="../classes/Stoner.Core.DataFile.html#Stoner.Core.DataFile.setas" title="Stoner.Core.DataFile.setas"><tt class="xref py py-attr docutils literal"><span class="pre">Stoner.Core.DataFile.setas</span></tt></a> attribute is used. The method will return a new set of data where all columns are interpolated against the new values of X.</p>
</div>
<div class="section" id="smoothing-and-differentiating-data">
<h3>Smoothing and Differentiating Data<a class="headerlink" href="#smoothing-and-differentiating-data" title="Permalink to this headline">¶</a></h3>
<p>Smoothing and numerical differentation are carried out using the Savitsky-Golay filtering function.
Whilst not the most sophisticated algorithm it is reasonably easy to implement and simple to use.:</p>
<div class="highlight-python"><div class="highlight"><pre>SG_Filter(col=(&quot;X&quot;.&quot;Y&quot;), points=15, poly=1, order=0,result=None, replace=False, header=None)
</pre></div>
</div>
<p>If col is a tuple then it is taken to be specifing both x and y data column indices. Otherwise the data
indexed by col is differentiated with repsect to the row. <em>order</em> specifies the order of differentiation, where 0
means simply smoothing the data. The algorithm works by locally fitting a polynomial over a certain window of points.
The parameters for this fitting are controlled by the <em>points</em> and <em>poly</em> parameters. <em>points</em>&gt;*poly*&gt;*order* for
the algorithm to work. <em>resul;t</em>, <em>replace</em> and <em>header</em> specify that the calculated data should also be added to
the <a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.html#Stoner.Analysis.AnalyseFile" title="Stoner.Analysis.AnalyseFile"><tt class="xref py py-class docutils literal"><span class="pre">AnalyseFile</span></tt></a> instance, optionally replacing an existing column indexed by <em>result</em> and given a new header
<em>header</em>. The nature of the local fitting means that the first and last <em>poly</em>/2 points are not valid.</p>
</div>
<div class="section" id="peak-finding">
<h3>Peak Finding<a class="headerlink" href="#peak-finding" title="Permalink to this headline">¶</a></h3>
<p>Peak finding is a tricky and often required task in experimental data analysis. When a functional form is known,
it is possible to fit the data to this functional form. However, often a more numerical approach is required.
The <a class="reference internal" href="../classes/Stoner.Analysis.AnalyseFile.peaks.html#Stoner.Analysis.AnalyseFile.peaks" title="Stoner.Analysis.AnalyseFile.peaks"><tt class="xref py py-meth docutils literal"><span class="pre">AnalyseFile.peaks()</span></tt></a> provides a relatively simple and effective method for doing this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">peak_data</span><span class="o">=</span><span class="n">peaks</span><span class="p">()</span>
<span class="n">peak_data</span><span class="o">=</span><span class="n">peaks</span><span class="p">(</span><span class="n">ycol</span><span class="o">=</span><span class="s">&quot;Y Data&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">significance</span><span class="o">=</span><span class="mf">0.001</span> <span class="p">,</span> <span class="n">xcol</span><span class="o">=</span><span class="s">&quot;X Data&quot;</span><span class="p">,</span> <span class="n">peaks</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">troughs</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">poly</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>  <span class="n">sort</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>The <em>xcol</em> and <em>ycol</em> arguments index the columns with the relevant data. If <em>xcol</em> is not provided then the row number is used instead.
If <em>ycol</em> is not provided then both x and y data is taken from the <em>setas</em> attribute.</p>
<p>The algorithm used is to differentiate the data with a Savitsky-Golay filter - which in effect fits a polynomial locally over the data.
Zero crossing values in the derivative are located and then the second derivative is found for these points and are used to identify
peaks and troughs in the data. The <em>width</em> and <em>poly</em> keywords are used to control the order of polynomial and the width of the window
used for calculating the derivative - a lower order of polynomial and wider width will make the algroithm less sensitive to narrow peaks.
Only peaks and troughs whose second derivatives are larger than <em>significance</em> are returned, and if <em>sort</em> is True, the peaks are returned
in order of their significance. <em>peaks</em> and <em>troughs</em> select whether to return peaks or troughs.</p>
<p>The default values of width and saignificance are set on the assumption that a data set will have less than about 10 peaks of more or
less equal significance. By default, only peaks are returned in order of x position.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/StonerLogo.png" alt="Logo"/>
            </a></p>
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Analysing Data Files</a><ul>
<li><a class="reference internal" href="#normalising-and-basic-maths-operations">Normalising and Basic Maths Operations</a></li>
<li><a class="reference internal" href="#curve-fitting">Curve Fitting</a><ul>
<li><a class="reference internal" href="#simple-polynomial-fits">Simple polynomial Fits</a></li>
<li><a class="reference internal" href="#simple-function-fitting">Simple function fitting</a></li>
<li><a class="reference internal" href="#fitting-with-limits">Fitting with limits</a><ul>
<li><a class="reference internal" href="#non-linear-curve-fitting-with-lmfit">Non-linear curve fitting with lmfit</a></li>
<li><a class="reference internal" href="#non-linear-curve-fitting-with-mpfit">Non-linear curve fitting with mpfit</a></li>
<li><a class="reference internal" href="#non-linear-curve-fitting-with-initialisation-file">Non-linear curve fitting with initialisation file</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#more-analysefile-functions">More AnalyseFile Functions</a><ul>
<li><a class="reference internal" href="#applying-an-arbitary-function-through-the-data">Applying an arbitary function through the data</a></li>
<li><a class="reference internal" href="#basic-data-inspection">Basic Data Inspection</a></li>
</ul>
</li>
<li><a class="reference internal" href="#data-reduction-methods">Data Reduction Methods</a><ul>
<li><a class="reference internal" href="#re-binning-data">(Re)Binning Data</a></li>
<li><a class="reference internal" href="#stitching-datasets-together">Stitching Datasets together</a></li>
<li><a class="reference internal" href="#thresholding-and-interpolating-data">Thresholding and Interpolating Data</a></li>
<li><a class="reference internal" href="#smoothing-and-differentiating-data">Smoothing and Differentiating Data</a></li>
<li><a class="reference internal" href="#peak-finding">Peak Finding</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="plotfile.html"
                        title="previous chapter">Plotting Data</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="datafolder.html"
                        title="next chapter">Working with Lots of Files</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/UserGuide/analysisfile.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="datafolder.html" title="Working with Lots of Files"
             >next</a> |</li>
        <li class="right" >
          <a href="plotfile.html" title="Plotting Data"
             >previous</a> |</li>
        <li><a href="../index.html">Stoner Package</a> &raquo;</li>
          <li><a href="ugindex.html" >The Stoner Python Package User Guide</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Gavin Burnell et al.
      Last updated on Apr 07, 2015.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>